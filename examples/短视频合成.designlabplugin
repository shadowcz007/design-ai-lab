{
  "poster": "data:image/png;base64,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",
  "knowledge": {
    "readme": "## 短视频合成\n\n\n### 从本地文件合成短视频，并添加音乐",
    "course": ""
  },
  "code": "//TODO 合成文字 有bug，大小不对\n// 调整逻辑，合成好frame的图片数据再传ffmpeg合成视频和音频\n// \n\n// 基础数据\nvar videos = {};\nlet videoObjId;\n\n// 变量区域-素材\nlet variables;\n\n// 扩展\nCanvas.prototype.addVariableRect = function (obj) {\n  return this.addRect({\n    left: obj.left,\n    top: obj.top,\n    width: obj.width,\n    height: obj.height,\n    fill: 'rgba(0,255,0,0.3)',\n    lockMovementX: false,\n    lockRotation: false,\n    lockScalingX: false,\n    lockScalingY: false,\n  }, true, true);\n}\n\n\nvar store = new Store('video_create_by_shadow');\nvar storeKey = (new Date()).getTime().toString();\nvar outputVideo;\n\n// 合成预览\n// 540*960\nvar _WIDTH = Math.min(parseInt(window.innerWidth * 0.8), 240),\n  _HEIGHT = parseInt(_WIDTH * 16 / 9),\n  _SCALE = 4,\n  _LOOP = 5,\n  _OUTPUTDIR = (() => {\n    let p = localStorage.getItem('_OUTPUTDIR');\n    return !!p ? p : null;\n  })();\n\n// UI\nlet pc, info, setupInfo;\n\n// 界面\nlet audioGroup, framesGroup;\nasync function gui() {\n  //隐藏p5的画布\n  Lab.ui.p5Show(false);\n  Lab.ui.layout(0);\n\n  setupInfo = Lab.ui.createBaseText(_OUTPUTDIR || '设置路径');\n  setupInfo.style = `width: 86%;\n    white-space: nowrap;\n    text-overflow: ellipsis;\n    display: block;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;`;\n  let setupBtn = Lab.ui.createIcon('setup', _setupFilePath, false);\n  let refreshBtn = Lab.ui.createIcon(\"clear\", _newVideo, false);\n  // 设置路径、设置按钮、清空\n  let setupBtns = Lab.ui.createGroup(setupInfo, setupBtn, refreshBtn);\n\n  setupBtns.layout(6);\n  //Lab.ui.add(setupBtns);\n  // 合成视频\n  let createBtn = Lab.ui.createIcon(\"play\", _createVideo, false);\n  info = Lab.ui.createBaseText('开始合成吧！');\n  // let downloadBtn = Lab.ui.createIcon('save', _downloadVideo, false);\n  let mainBtns = Lab.ui.createGroup(createBtn, info);\n  mainBtns.layout(6);\n\n  let loopIn = Lab.ui.createInput('text', '字幕时长', ns => {\n    _LOOP = ~~ns[0];\n  }, true, false);\n  loopIn.input.value = _LOOP;\n\n  let header = Lab.ui.createGroup(setupBtns, mainBtns, loopIn);\n  header.layout(6);\n  Lab.ui.add(header);\n\n  //添加背景音乐 \n  audioGroup = Lab.ui.createGroup(Lab.ui.createIcon('music', () => {\n    Lab.ui.toast('推荐背景音乐，待开发');\n  }, false));\n  audioGroup.layout(6);\n  Lab.ui.add(audioGroup);\n\n  // 帧\n  framesGroup = Lab.ui.createGroup();\n  framesGroup.style.padding = '24px';\n  framesGroup.layout(6);\n\n  //framesGroup.children = {};\n  Lab.ui.add(framesGroup);\n\n  // 添加帧\n  createAddCard();\n\n  let editBtn = Lab.ui.createIcon(\"square\", _newRect, false);\n  let textBtn = Lab.ui.createIcon(\"comment\", _newText, false);\n  let copyBtn = Lab.ui.createIcon(\"plus\", _addVariableElements, false);\n  let editGroup = Lab.ui.createGroup(editBtn, textBtn, copyBtn);\n  editGroup.layout(6);\n  Lab.ui.add(editGroup);\n\n  pc = new Canvas(_WIDTH, _HEIGHT, false, false);\n\n\n  let previewGroup = Lab.ui.createGroup(pc.getElement());\n  previewGroup.layout(0);\n  Lab.ui.add(previewGroup);\n\n  // 变量区域-素材\n  let rectInfo = Lab.ui.createBaseText('变量区域-素材');\n  variables = Lab.ui.createGroup(rectInfo);\n  variables.layout(6);\n  Lab.ui.add(variables);\n\n  // 字幕生成\n  const createTextImageAndUpdate = (text, style) => {\n    let id = Lab.base.hash({ text, style });\n    console.log(videos, videoObjId)\n    if (id != videos[videoObjId].textId) {\n      videos[videoObjId] = Object.assign(videos[videoObjId], {\n        textId: id,\n        text,\n        //mergeImage: createMergeImage(text, style)\n      })\n    }\n  };\n  // 绑定事件\n  pc.onModified = (opt, json) => {\n    // 矩形变量更改\n    console.log(opt.target.type, opt.target)\n    if (opt.target.type == 'rect') {\n      let index = null;\n\n      // for (let i = 0; i < variables.length; i++) {\n      //     if (variables[i].videoObjId === videoObjId) {\n      //         index = i;\n      //     }\n      // }\n      if (index != null) {\n        videos[videoObjId].variableRect = opt.target.getScaledBound();\n        console.log('更新变量区域', videos[videoObjId])\n      }\n\n    }\n    // 文本修改信息\n    if (opt.target.type === 'textbox') {\n      let style = textStyleExtract(opt.target);\n      const { text } = opt.target;\n      createTextImageAndUpdate(text, style);\n    };\n    // 布局信息\n    updateData(videoObjId, json);\n    // 更新预览图\n    updatePreviewImg(videoObjId);\n  };\n\n  pc.render(true)\n};\n\nasync function createVideoPreview(url) {\n  outputVideo = await Lab.ui.createVideo(url,\n    false);\n  outputVideo.style.width = _WIDTH + 'px';\n  outputVideo.style.height = _HEIGHT + 'px';\n  outputVideo.play();\n}\n\nasync function createAddCard() {\n  let addBtn = Lab.ui.createIcon(\"plus\", _addVideo, false);\n  let imBtn = Lab.ui.createButton(\"\", () => { }, false);\n  imBtn.appendChild(addBtn);\n  addBtn.style.width = '56px';\n  addBtn.style.borderRadius = 0;\n  addBtn.style.color = '#4a4a4a';\n  addBtn.style.background = 'rgba(255,255,255,0.1)';\n  addBtn.style.height = `${_HEIGHT * 56 / _WIDTH}px`\n  addBtn.style.margin = '2px';\n  imBtn.style = `\n    height: auto;\n    background: #eee;\n    border-radius: 8px;\n    padding: 0;`;\n  framesGroup.appendChild(imBtn);\n};\n\n\nasync function _addVariableElements() {\n  let rectInfo = Lab.ui.createBaseText('变量区域-素材');\n  // 关键帧的可变区域-素材集\n  videos[videoObjId].variableElements = await Lab.ui.createShortVideoInput();\n  if (videos[videoObjId].variableElements) {\n    rectInfo.innerText = `变量区域-素材${videos[videoObjId].variableElements.length}`;\n  };\n  variables.innerHTML = '';\n  variables.appendChild(rectInfo);\n  _save();\n};\n\nfunction _addVariableRect2UI(videoObjId) {\n  // variables.push({\n  //     videoObjId: videoObjId\n  // });\n\n  // 已经绑定了变量素材\n  if (videos[videoObjId].variableElements) {\n    let rectInfo = Lab.ui.createBaseText('变量区域-素材');\n    rectInfo.innerText = `变量区域-素材${videos[videoObjId].variableElements.length}`;\n    variables.innerHTML = '';\n    variables.appendChild(rectInfo);\n  } else {\n    let rectInfo = Lab.ui.createBaseText('变量区域-素材');\n    variables.innerHTML = '';\n    variables.appendChild(rectInfo);\n  }\n\n\n  // let g = Lab.ui.createGroup(rectBtn, rectInfo);\n  // g.layout(6);\n  // Lab.ui.add(g);\n}\n\n\n// 添加素材\nasync function _addVideo() {\n  let labVideos = Lab.ui.createShortVideoInput();\n  // console.log(labVideos)\n  if (labVideos) {\n\n    for (let labVideo of labVideos) {\n      // 帧数据\n      labVideo = await baseData(labVideo);\n\n      videos[labVideo.id] = labVideo;\n\n      if (labVideo.type === 'audio') {\n        await baseAddBackgroundAudio(labVideo);\n      } else {\n        await baseAddVideo(labVideo);\n      }\n\n      updateData(labVideo.id);\n    }\n\n  }\n\n}\n// 结果\nasync function _createVideo() {\n  if (!_OUTPUTDIR) _setupFilePath();\n  if (!_OUTPUTDIR) return\n  info.innerText = '正在合成ing';\n  let finishData = createVideoData();\n  if (finishData.frames.length > 0) {\n    Lab.ui.loading(0);\n    let src = await Lab.video.mergeAll(finishData, (progress) => {\n      info.innerText = progress.toFixed(2);\n    });\n    await createVideoPreview(src);\n    Lab.ui.loading(100);\n    // Lab.ui.toast('完成' + outputVideo.src);\n    _save();\n  }\n\n}\n\nfunction _setupFilePath() {\n  // console.log('filePath')\n  let filePath = Lab.ui.getFilePath(2);\n  if (filePath && filePath[0]) {\n    _OUTPUTDIR = filePath[0];\n    Lab.video.newDirname = _OUTPUTDIR;\n    setupInfo.innerText = _OUTPUTDIR;\n    localStorage.setItem('_OUTPUTDIR', _OUTPUTDIR);\n    Lab.video.newDirname = _OUTPUTDIR;\n  }\n  return _OUTPUTDIR\n  // console.log(filePath)\n}\nasync function _newVideo() {\n  await store.clear();\n  videos = {};\n  videoObjId = null;\n  // 变量区域-素材\n  variables = null;\n  Lab.ui.clear();\n  gui();\n}\n\nfunction _newRect() {\n  // 暂时只支持一个变量区域\n  if (videos[videoObjId].variableRect) return\n  let rect = pc.addVariableRect({\n    left: 0,\n    top: 0,\n    width: _WIDTH,\n    height: _WIDTH\n  });\n\n  videos[videoObjId].variableRect = rect.getScaledBound();\n\n  // console.log(rect);\n  _addVariableRect2UI(videoObjId);\n\n}\n\n\n// 复制当前的变量区域 到全部\n// function _copyRect() {\n//     if (!videos[videoObjId].variableRect) return\n//     let v = JSON.parse(JSON.stringify(videos[videoObjId].variableRect));\n//     // variables.push({rect:variables[0].rect,videoObjId:'a555a9c614d00029c2b0ac20063bcf33bbfb67cf'})\n//     for (var id in videos) {\n//         if (!videos[id].variableRect) {\n//             variables.push({ videoObjId: id });\n//             _addVariableRect2UI(id);\n//         };\n//         videos[id].variableRect = v;\n//     };\n// };\n\n// 添加字幕\nfunction _newText() {\n  if (!videos[videoObjId].text) pc.addText('TEXT', getTextStyle());\n};\n\n// 关键帧数据\nconst createFrameData = (labVideo) => {\n  let { index, url, type, layout, createTime, id, text } = labVideo;\n  if (!((index != null || index != undefined) && typeof index === 'number')) index = Object.keys(videos).length;\n  let obj = {\n    index,\n    type,\n    url,\n    text,\n    // textImage,\n    layout,\n    createTime: createTime || (new Date()).getTime()\n  };\n  if (!id) {\n    obj.id = Lab.base.hash(obj)\n  } else {\n    obj.id = id;\n  };\n\n  return obj;\n};\n\n// const createMergeImage = (text, style) => {\n//   let tc = new Canvas(_WIDTH, _HEIGHT, true, false);\n//   let tx = tc.addText(text, style, false, false);\n//   // console.log(style)\n//   //TODO  调试\n//   // document.body.appendChild(tc.getElement())\n//   return tc.exportImage(tx, 2);\n// };\n\n// 计算字幕的停留时间\nconst getTextLoop = text => {\n  text = text || '';\n  return Math.max(parseInt(text.length / 2.5), _LOOP)\n}\n\n// 取布局数据\nconst getLayout = (obj) => {\n  let { top, left, width, height, scaleX, scaleY, angle } = obj;\n  scaleX = scaleX || 1;\n  scaleY = scaleY || 1;\n  return {\n    angle: angle || 0,\n    top: parseInt(top * _SCALE),\n    left: parseInt(left * _SCALE),\n    width: Math.min(parseInt(width * _SCALE * scaleX), _WIDTH * _SCALE),\n    height: Math.min(parseInt(height * _SCALE * scaleY), _HEIGHT * _SCALE)\n  }\n};\n\n\n// 文本的样式\nconst textStyleExtract = obj => {\n  let res;\n  if (obj) {\n    const { top,\n      left,\n      width,\n      height,\n      fill,\n      fontSize,\n      charSpacing,\n      fontFamily,\n      angle,\n      scaleX,\n      scaleY\n    } = obj;\n    res = {\n      top,\n      left,\n      width,\n      height,\n      fill,\n      fontSize,\n      charSpacing: charSpacing || 0,\n      fontFamily,\n      angle: angle || 0,\n      scaleX: scaleX || 1,\n      scaleY: scaleY || 1\n    }\n  } else {\n    res = {\n      top: parseInt(_HEIGHT * 0.1),\n      left: 0,\n      width: _WIDTH,\n      fontSize: parseInt(_HEIGHT * 0.05),\n      fill: \"white\",\n      fontFamily: 'monospace'\n    }\n  }\n  return res\n\n}\n\n// 内容样式\n// 计算居中\nconst contentStyleExtract = (obj, element) => {\n  let res;\n  if (obj) {\n    // width,height是元素真实的尺寸，通过scale来缩放成最终的高宽\n    const { left, top, width, height, angle, scaleX, scaleY } = obj;\n    // console.log(width, height, scaleX, scaleY)\n    res = {\n      left, top,\n      width, height,\n      scaleX: scaleX || 1, scaleY: scaleY || 1,\n      angle: angle || 0\n    }\n  } else {\n    let width = element.width, height = element.height;\n    let scale = _WIDTH / element.width;\n    if (width < _WIDTH) {\n      scale = element.width / _WIDTH;\n    };\n\n    scale = parseFloat(scale.toFixed(2));\n\n    res = {\n      left: parseInt((_WIDTH - width * scale) / 2),\n      top: parseInt((_HEIGHT - height * scale) / 2),\n      width, height,\n      scaleX: scale, scaleY: scale,\n      angle: 0\n    }\n    // console.log(res)\n  }\n  return res\n}\n\nconst getContentStyle = (layout, element) => {\n  let target = layout ? layout.filter(f => f.type === 'image')[0] : null;\n  let res = contentStyleExtract(target, element);\n  // console.log(res)\n  return res\n};\n\nconst getTextStyle = (layout) => {\n  let target = layout ? layout.filter(f => f.type === 'textbox')[0] : null;\n  let res = textStyleExtract(target);\n  return res\n}\n\n// 准备绘制 字幕的数据\nconst getTextAndStyle = labVideo => {\n  // 文字输入\n  let style = getTextStyle(labVideo.layout),\n    text = null;\n  // console.log(textStyle)\n  if (labVideo.text) {\n    text = labVideo.text;\n  };\n  return {\n    element: text,\n    style\n  }\n}\n// 准备绘制 内容的数据\nconst getContentAndStyle = async labVideo => {\n  // 元素\n  let element;\n  if (labVideo.type == \"video\") {\n    element = await Lab.ui.createVideo(labVideo.url, false);\n\n  } else if (labVideo.type == \"img\") {\n    element = await Lab.ui.createImage(labVideo.url);\n  } else if (labVideo.type == \"gif\") {\n    // let frames = await pc.buildSprite(labVideo.url,pc.canvas);\n    // console.log(frames)\n    if (!labVideo.videoUrl) {\n      let videoUrl = await Lab.video.gif2video(labVideo.url);\n      // console.log(videoUrl)\n      labVideo.videoUrl = videoUrl;\n    };\n\n    element = await Lab.ui.createVideo(labVideo.videoUrl, false);\n\n  }\n  // 样式\n  let style = getContentStyle(labVideo.layout, element);\n  return {\n    element,\n    style\n  }\n}\n\nasync function createPreviewImg(id) {\n  let base64 = pc.exportImage(pc.bg, _SCALE);\n\n  //创建图片\n  let im = await Lab.ui.createImage(base64);\n  im.style.width = '56px';\n  im.style.margin = '2px';\n  im.id = id;\n  let imBtn = Lab.ui.createButton(\"\", async () => {\n    videoObjId = id;\n    await baseAddVideo(videos[id], false);\n    updateData(id);\n    _addVariableRect2UI(videoObjId);\n  }, false);\n  imBtn.appendChild(im);\n  imBtn.style = `\n    height: auto;\n    background: #eee;\n    border-radius: 8px;\n    padding: 0;`;\n  framesGroup.appendChild(imBtn);\n  framesGroup.children[id] = im;\n  videos[id].preview = {\n    base64: im.src,\n    width: im.naturalWidth,\n    height: im.naturalHeight\n  };\n}\n\nfunction updatePreviewImg(id) {\n  let base64 = pc.exportImage(pc.bg, _SCALE);\n  //更新图片\n  if (framesGroup.children[id]) framesGroup.children[id].src = base64;\n  videos[id].preview = {\n    base64,\n    width: framesGroup.children[id] ? framesGroup.children[id].naturalWidth : null,\n    height: framesGroup.children[id] ? framesGroup.children[id].naturalHeight : null\n  };\n}\n\n\n// 用来合成视频的数据\nfunction createVideoData() {\n  // 背景音乐\n  let backgroudAudio = null;\n  let _videos = videos2array();\n  var videosNew = Array.from(_videos, v => {\n    if (v && v.url) {\n      let index = v.index;\n      // console.log(v)\n      let content = null;\n      let variable = v.variableElements && v.variableRect ? {\n        elements: v.variableElements,\n        rect: v.variableRect\n      } : null;\n\n      // 背景音乐\n      if (v.type === 'audio') {\n        backgroudAudio = v;\n      } else if (v.type === 'img') {\n        content = v.preview;\n      };\n      return (content) ? {\n        index,\n        content,\n        variable\n      } : null\n    }\n  }).filter(f => f);\n\n  let finishData;\n  if (videosNew) {\n    finishData = {\n      width: videosNew[0].content.width,\n      height: videosNew[0].content.height,\n      // 按照index升序\n      frames: videosNew.sort((a, b) => a.index - b.index),\n      backgroudAudio: backgroudAudio\n    };\n  }\n\n  // console.log(finishData)\n  return finishData\n}\n\n// 笛卡尔积\nfunction ddd() {\n  // TODO\n}\n\n// 更新布局layout\nconst updateLayout = json => {\n  return Array.from(json.objects, o => {\n    // console.log(o)\n    let no = { left: o.left, top: o.top, width: o.width, height: o.height, type: o.type };\n    if (o.type == 'textbox') {\n      no = Object.assign(no, textStyleExtract(o))\n    } else if (o.type == 'image') {\n      no = Object.assign(no, contentStyleExtract(o))\n    }\n    return no\n  });\n};\n\nasync function baseData(labVideo) {\n  // 帧数据\n  let videoObj = createFrameData(labVideo);\n  labVideo.type !== 'audio' ? videoObjId = videoObj.id : null;\n  // 去重？?\n  // if (Array.from(videos, v => v.id).includes(videoObj.id)) return console.log(labVideo);\n  if (labVideo.type == 'audio') {\n    //背景音乐\n    let element = await Lab.ui.createaAudio(labVideo.url, false);\n    videoObj = Object.assign(videoObj, {\n      duration: element.duration,\n      startTime: 0,\n      loop: 5\n    })\n  };\n  return videoObj\n}\n\nfunction updateData(id, json) {\n  // console.log('更新数据',videos[id],json)\n  // console.log(updateLayout(json))\n  videos[id] = Object.assign(videos[id], {\n    layout: updateLayout(json || pc.exportJSON())\n  })\n  _save();\n}\n\nasync function baseAddBackgroundAudio(labVideo) {\n  if (audioGroup.querySelector('audio')) audioGroup.querySelector('audio').remove();\n  audioGroup.appendChild(await Lab.ui.createaAudio(labVideo.url, false));\n}\n\n\nasync function baseAddVideo(labVideo, isNew = true) {\n  // console.log(labVideo)\n  //  console.log(labVideo.preview)\n  // _addVariableRect2UI(rect, videoObjId);\n  let variableRect;\n\n  if (labVideo) {\n\n    //添加到画布 \n    pc.reset();\n    // 背景\n    pc.bg = pc.addRect({\n      width: _WIDTH,\n      height: _HEIGHT,\n      fill: 'black',\n      stroke: 'black'\n    }, false);\n    console.log(pc.bg)\n\n    // 内容 把type==gif的转化为video\n    let { element, style } = await getContentAndStyle(labVideo);\n    // console.log(labVideo)\n    if (labVideo.type == \"video\" || labVideo.type == \"gif\") {\n      pc.addVideo(element,\n        Object.assign(style, {\n          objectCaching: false,\n          lockMovementX: false,\n          lockRotation: false,\n          lockScalingX: false,\n          lockScalingY: false,\n        }), true, false);\n    } else if (labVideo.type == \"img\") {\n      pc.addImg(element, style);\n    };\n\n    // 字幕\n    let { element: text, style: ts } = getTextAndStyle(labVideo);\n    if (text) pc.addText(text, ts);\n\n    // 变量区域\n    if (labVideo.variableRect) {\n      // console.log(variableRect)\n      variableRect = pc.addRect({\n        left: labVideo.variableRect.left,\n        top: labVideo.variableRect.top,\n        width: labVideo.variableRect.width,\n        height: labVideo.variableRect.height,\n        fill: 'rgba(0,255,0,0.3)',\n        lockMovementX: false,\n        lockRotation: false,\n        lockScalingX: false,\n        lockScalingY: false,\n      }, true, true);\n    }\n\n    //最后\n    // 创建预览图片\n    await sleep(() => (isNew === true) ? createPreviewImg(labVideo.id) : updatePreviewImg(labVideo.id), 200);\n\n  };\n\n  return variableRect;\n};\n\nfunction sleep(fn, t = 500) {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      if (fn) fn();\n      resolve();\n    }, t);\n  });\n}\n\n// 缓存\nstore.getValues().then(async vs => {\n  // console.log(vs)\n  await store.clear();\n  if (vs[0]) {\n    _WIDTH = vs[0].width;\n    _HEIGHT = vs[0].height;\n    _SCALE = vs[0].scale;\n    if (outputVideo && outputVideo.src) (outputVideo.src = vs[0].outputVideo) && outputVideo.play();\n    let ds = (vs[0].videos || []);\n    ds = ds.sort((a, b) => a.index - b.index);\n    for (let i = 0; i < ds.length; i++) {\n      videos[ds[i].id] = ds[i];\n      let variableRect;\n      if (ds[i].type === 'audio') {\n        await baseAddBackgroundAudio(ds[i]);\n      } else {\n        variableRect = await baseAddVideo(ds[i]);\n      };\n\n      videoObjId = ds[i].id;\n      // 变量\n      // if (variableRect) {\n      _addVariableRect2UI(videoObjId);\n      // console.log(ds[i].variableElements);\n      // };\n\n    };\n    _save();\n  }\n});\n// videos object转array\nfunction videos2array() {\n  let vs = [];\n  for (let id in videos) {\n    vs.push(videos[id])\n  };\n  vs = vs.sort((a, b) => a.index - b.index);\n  return vs;\n};\n// 保存\nfunction _save() {\n  let vs = videos2array();\n  store.set(storeKey, {\n    videos: vs,\n    width: _WIDTH,\n    height: _HEIGHT,\n    scale: _SCALE,\n    outputVideo: outputVideo && outputVideo.src && outputVideo.src.match('.mp4') ? outputVideo.src : null\n  });\n}\n\n",
  "code_length": 171,
  "size": [
    671,
    647
  ],
  "extname": "designlabplugin",
  "version": "0.1.2",
  "package_id": "912fea7ba254e9c7c27fd07c72ac45097a9d2a12",
  "create_time": 1619019066182
}