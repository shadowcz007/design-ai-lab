{
  "id": "ee6b14eaf128cb692e22ce10dbcd96f526ca4b66",
  "poster": "data:image/png;base64,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",
  "title": "指南生成",
  "knowledge": {
    "course": "用于对话式网页排版\n- 新增群聊样式\n\n",
    "readme": "指南生成",
    "author": "shadow",
    "version": "0.11"
  },
  "code": "// 缓存key\nvar _STORE_KEY = 'mix-book'\n\nvar dataset = {}\nvar db = new Lab.Store(_STORE_KEY)\n\n// 默认的图谱label\nvar _GRAPHE_LABEL = -1\nvar _GRAPHE_LAYOUT = 'circular'\nvar _GRAPHE_COLORS = ['#003366', '#006699', '#4cabce', '#e5323e']\n// 按推荐还是来源归类\nvar _GRAPHE_C_BY_L = true\n\n// 配色方案\nvar colors = {\n  font: 'rgb(181, 181, 181)',\n  background: '#fff8ee',\n  highlight: ['rgb(255, 192, 56)', 'rgb(181, 181, 181)']\n}\n\n// 维护录入过人物、对白\nvar metaHuman = {}\nvar metaHumanStore = new Lab.Store('metaHuman')\nvar metaHumanAvatarsStore = new Lab.Store('metaHumanAvatars')\n\nvar mainDiv, rightDiv, cards, tag, selectModel, myChart\n\n// 人物输入\nvar metaHumanDiv\nvar appDiv\n\nfunction gui () {\n  // 加载echart库\n  loadEcharts()\n\n  mainDiv = Lab.ui.createGroup('container')\n  mainDiv.style = `display: flex;\n    flex-direction: row;\n    justify-content: flex-start;\n    background: #eee;\n    margin: 0;`\n\n  Lab.ui.add(mainDiv)\n\n  let leftDiv = Lab.ui.createGroup('container')\n  rightDiv = Lab.ui.createGroup('container')\n  leftDiv.style = `margin: 0;\n    padding: 1em;\n    width: 50vw;\n    overflow-y: scroll;`\n  rightDiv.style = `height: 90vh;\n    width: 48vw;\n    position: fixed;\n    top:0;\n    right: 0;\n    padding: 0 16px;\n    margin: 1em;\n    background: white;\n    overflow-y: scroll;`\n  mainDiv.add(leftDiv)\n  mainDiv.add(rightDiv)\n\n  loadAppStore().then(_appDiv => {\n    appDiv = _appDiv\n    // 从app\n    leftDiv.add(appDiv)\n    leftDiv.add(Lab.ui.createDivider())\n\n    // 根据url获取文章\n    let spiderDiv = createSpiderInput()\n    leftDiv.add(spiderDiv)\n    leftDiv.add(Lab.ui.createDivider())\n\n    // 人物\n    metaHumanDiv = createMetaHumanInput()\n    leftDiv.add(metaHumanDiv)\n    leftDiv.add(Lab.ui.createDivider())\n    leftDiv.add(createResultBtns())\n\n    //\n    metaHumanStore.getJson().then(async res => {\n      let avatars = await metaHumanAvatarsStore.getJson()\n      if (res) metaHuman = { ...res }\n      for (const id in metaHuman) {\n        let img = avatars[metaHuman[id].avatarId] || {}\n        metaHuman[id].avatar = img.base64\n      }\n      // console.log(metaHuman,metaHumanDiv.update)\n      metaHumanDiv.updateCount(Object.keys(metaHuman).length)\n    })\n  })\n\n  // rightDiv.add(createResultPannel(rightDiv));\n\n  // // 按照推荐关系获取更多\n  // let moreBtn = Lab.ui.createButton('相关推荐', moreRelate, false);\n  // mainDiv.add(moreBtn);\n\n  // // 生成文章 模态框\n  // selectModel = Lab.ui.createModel(\"\");\n  // Lab.ui.add(selectModel);\n\n  // let allSelectBtn = Lab.ui.createButton('全部取消/增加', toggleSelectForCreate, false);\n  // selectModel.add(allSelectBtn, 'header');\n\n  // let nextBtn = Lab.ui.createButton('下一步', nextForCreate, false);\n  // selectModel.add(nextBtn, 'header');\n\n  // let runBtn = Lab.ui.createButton('生成', runForCreate, false);\n  // selectModel.add(runBtn, 'header');\n\n  // // 设置图谱的颜色\n  // let colorsSetBtn = Lab.ui.createButton('颜色设置', setColorsForGraph, false);\n  // mainDiv.add(colorsSetBtn);\n\n  // // 重设图谱颜色\n  // let colorsResetBtn = Lab.ui.createButton('颜色重设', resetColorsForGraph, false);\n  // mainDiv.add(colorsResetBtn);\n\n  // // 生成图谱\n  // let copyGraphBtn = Lab.ui.createButton('生成图谱', runCreateGraph, false);\n  // mainDiv.add(copyGraphBtn);\n\n  // // 清空数据\n  // let clearBtn = Lab.ui.createButton('清空', clearDataset, false);\n  // mainDiv.add(clearBtn);\n\n  // // 选择后生成\n  // let selectBtn = Lab.ui.createButton('选择后生成', selectForCreate, false);\n  // mainDiv.add(selectBtn);\n\n  // // 生成置顶logo\n  // let createLogo1Btn = Lab.ui.createButton('生成置顶logo1', () => createOneImageLayout(1), false);\n  // mainDiv.add(createLogo1Btn);\n  // // 生成置顶logo\n  // let createLogo2Btn = Lab.ui.createButton('生成置顶logo2', () => createOneImageLayout(2), false);\n  // mainDiv.add(createLogo2Btn);\n\n  // // 生成单图\n  // let createOneImageLayoutBtn = Lab.ui.createButton('生成单图', () => createOneImageLayout(0), false);\n  // mainDiv.add(createOneImageLayoutBtn);\n\n  // cards = Lab.ui.createGroup('column');\n  // cards.style.width = '320px';\n  // mainDiv.add(cards);\n\n  // 加载缓存\n  initDatasetFromStore()\n}\n\nfunction initDatasetFromStore () {\n  db.get('dataset').then(r => {\n    if (r) dataset = r\n    tag = Lab.ui.createTag(`收集 ${Object.keys(dataset).length}`)\n    tag.style = `\n        position:fixed;\n        top:12px;\n        right:12px;`\n    mainDiv.add(tag)\n    tag.addEventListener('click', async () => {\n      if (Object.keys(dataset).length > 0) {\n        Lab.ui.saveJsonDialog(dataset, '下载数据')\n      } else {\n        let json = Lab.ui.openJsonDialog()\n        if (Object.keys(json).length > 0) {\n          dataset = json\n          db.set('dataset', dataset)\n          tag.innerText = `收集 ${Object.keys(dataset).length}`\n        }\n      }\n      // let tagModel=Lab.ui.createModel();\n      // let downloadBtn = Lab.ui.createButton('下载数据', () => {\n      //     dataset = {};\n      //     db.set('dataset', {});\n      //     cards.innerHTML = '';\n      //     tag.innerText = `收集 ${Object.keys(dataset).length}`;\n      // }, false);\n      // mainDiv.add(downloadBtn);\n    })\n  })\n  db.get('_GRAPHE_COLORS').then(r => {\n    if (r) _GRAPHE_COLORS = r\n  })\n}\n\nfunction loadEcharts () {\n  let script = document.createElement('script')\n  script.type = 'text/javascript'\n  script.src = 'https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js'\n  Lab.ui.add(script)\n}\n\nfunction pasteAndSpider () {\n  let url = Lab.clipboard.read()\n  if (url.match('https')) {\n    spider(url, 0)\n  }\n}\n\nfunction spider (url, mainIndex = 0) {\n  let webview = Lab.ui.createWebview(url, false)\n  webview.style = `\n            position:fixed;\n            z-index:9999;\n            top:0;\n            left:0;\n            display:inline-flex;\n            width:1020px;\n            height:2800px;\n            `\n  mainDiv.add(webview)\n  if (typeof mainIndex == 'number')\n    webview.setAttribute('main-index', mainIndex)\n  // console.log(webview.getAttribute('main-index'))\n  // webview.addEventListener('page-title-updated', doData);\n  // webview.addEventListener('dom-ready', console.log);\n  // webview.addEventListener('load-commit', console.log);\n  webview.addEventListener('did-finish-load', doData)\n  // webview.addEventListener('did-frame-finish-load', console.log);\n  // webview.addEventListener('console-message', console.log);\n  // webview.addEventListener('update-target-url', doData);\n}\n\n// 扩充一层相关推荐\nfunction moreRelate () {\n  for (const id in dataset) {\n    let d = dataset[id]\n    if (!d.isMore) {\n      for (const r of d.relate) {\n        spider(r.url, d.mainIndex + 1)\n      }\n      d.isMore = true\n    }\n  }\n}\n\n//\nfunction toggleSelectForCreate () {\n  let labels = Array.from(selectModel.querySelectorAll('.label'), d => d)\n  if (\n    Array.from(labels, b => b.classList.contains('red')).filter(f => f).length >\n    0\n  ) {\n    Array.from(labels, r => r.classList.remove('red'))\n  } else {\n    Array.from(labels, r => r.classList.add('red'))\n  }\n}\n\nfunction nextForCreate (viewModel) {\n  // let ids = Array.from(selectModel.querySelectorAll('.label.red'), d => d.getAttribute('data-id'));\n  let datas = []\n  for (let id in dataset) {\n    // if (ids.includes(id)) datas.push(dataset[id]);\n    datas.push(dataset[id])\n  }\n  datas = datas.sort((a, b) => b.mainIndex)\n  return checkImgForCreate(datas, viewModel)\n}\n\nasync function runForCreate () {\n  // selectModel.hide();\n  Lab.ui.loading(0)\n  let selectRes = Array.from(selectModel.querySelectorAll('img'), im => {\n    return {\n      url: im.src,\n      id: im.getAttribute('data-id'),\n      type: im.getAttribute('data-type')\n    }\n  })\n  let imgs = {}\n  Array.from(selectRes, im => {\n    if (!imgs[im.id]) imgs[im.id] = []\n    imgs[im.id].push({ url: im.url, type: im.type })\n  })\n\n  for (let id in imgs) {\n    let data = { ...dataset[id] }\n    data.imgs = imgs[id]\n    imgs[id] = data\n  }\n\n  cards.innerHTML = ''\n  await createCard(imgs)\n  // Lab.clipboard.write(cards.innerHTML,'html');\n  setTimeout(() => Lab.ui.loading(100), 500)\n}\n\n// 生成之前 审核图片\nfunction checkImgForCreate (datas, viewModel) {\n  const createTagByType = (_type, viewModel) => {\n    let t = Lab.ui.createTag(_type, 'gray')\n    t.addEventListener('click', e => {\n      if (viewModel) viewModel.hide()\n      let data = t.getAttribute('data')\n      if (data) {\n        data = JSON.parse(data)\n        console.log(data)\n        metaHumanDiv.update({\n          name: data.title,\n          avatar: data.imgurl,\n          dialogue: data.text\n        })\n      }\n    })\n    return t\n  }\n\n  let div = Lab.ui.createGroup()\n  for (const data of datas) {\n    let d = { ...data }\n    let card = Lab.ui.createGroup('card')\n    let t = createTagByType(d.type, viewModel)\n    card.add(t)\n    t.setAttribute(\n      'data',\n      JSON.stringify({\n        // imgurl:im.url,\n        title: d.title,\n        text: d.text || ''\n      })\n    )\n\n    let title = Lab.ui.createHeader(4, d.title)\n    // title.style.fontSize = '2em';\n    card.add(title)\n    let txt = Lab.ui.createBaseText(d.text)\n    card.add(txt)\n\n    card.style = `outline:1px solid #eee;padding:12px`\n    // console.log(d)\n\n    if (!d.imgs) d.imgs = []\n    d.imgs = [{ url: d.image }, ...d.imgs]\n    // let mImg = await Lab.ui.createImage(d.image);\n    // mImg.setAttribute('data-id', d.id);\n    // card.add(mImg);\n    d.imgs = Array.from(\n      d.imgs,\n      im => (im = { ...im, score: im.type == 'gif' ? 1 : 0 })\n    ).sort((a, b) => b.score - a.score)\n    d.imgs = d.imgs.filter(f => f.url)\n\n    Array.from(d.imgs, async im => {\n      let row = Lab.ui.createGroup('row')\n      row.style = `margin: 24px 0;outline:1px solid #eee`\n      if (im.url) {\n        im.url = await getImgBase64(im.url)\n\n        let t = createTagByType('IMG', viewModel)\n        row.add(t)\n        t.setAttribute(\n          'data',\n          JSON.stringify({\n            imgurl: im.url,\n            text: im.text || ''\n          })\n        )\n\n        let img = await Lab.ui.createImage(im.url)\n        if (d.id) img.setAttribute('data-id', d.id)\n        img.setAttribute('data-type', im.type)\n        img.className = 'ui card'\n        img.addEventListener('mouseover', e => img.classList.add('raised'))\n        img.addEventListener('mouseout', e => img.classList.remove('raised'))\n        // img.addEventListener('click', e => img.remove());\n        let text = Lab.ui.createBaseText(im.text || '')\n        row.add(img)\n        row.add(text)\n        card.add(row)\n      }\n    })\n    div.add(card)\n  }\n  return div\n}\n\nasync function createCard (ds) {\n  let index = 1\n  for (const id in ds) {\n    let data = ds[id]\n    createCardByHtml(await createCardHtml(index, data))\n    index++\n  }\n}\n\nfunction createCardByHtml (html) {\n  let card = Lab.ui.createGroup('card')\n  // cards.add(card);\n  let htmlDiv = Lab.ui.createGroup('card')\n  card.add(htmlDiv)\n  htmlDiv.innerHTML = '<br>' + html + '<br>'\n  htmlDiv.setAttribute('contenteditable', true)\n\n  rightDiv.add(card)\n  // TODO 变量解析\n  // 规范\n  //variableParse(card, htmlDiv);\n\n  // let copyBtn = Lab.ui.createButton('拷贝', e => {\n  //     // console.log(htmlDiv)\n  //     let metaHumanObj = {\n  //         avatar: htmlDiv.querySelector('.meta-human-avatar').src,\n  //         name: htmlDiv.querySelector('.meta-human-name').innerText,\n  //         dialogue: htmlDiv.querySelector('.meta-human-dialogue').innerText\n  //     };\n  //     let id = Lab.base.md5(metaHumanObj.name);\n  //     let isNew = false;\n  //     if (!metaHuman[id]) {\n  //         metaHuman[id] = {\n  //             id,\n  //             name: metaHumanObj.name,\n  //             avatar: metaHumanObj.avatar,\n  //             dialogues: []\n  //         };\n  //         isNew = true;\n  //     };\n\n  //     if (!metaHuman[id].dialogues.includes(metaHumanObj.dialogue)) {\n  //         metaHuman[id].dialogues.push(metaHumanObj.dialogue);\n  //         isNew = true;\n  //     };\n  //     if (isNew) {\n  //         metaHumanStore.set(id, metaHuman[id]);\n  //     }\n  //     Lab.clipboard.write(htmlDiv.innerHTML, 'html');\n  // }, false);\n  // card.add(copyBtn);\n}\n\n// TODO 变量解析\n// 规范\nfunction variableParse (container, div) {\n  // console.log(div)\n  let vs = div.querySelectorAll('.mix-variable')\n  for (const v of vs) {\n    let value = v.getAttribute('variable-attribute')\n    if (value) {\n      if (value === 'src') {\n        let inputUrl = Lab.ui.createInput('img', '', async ds => {\n          let t = ds[0]\n          if (t) {\n            v.src = await Lab.Image.getNativeImageFromWebview2(t)\n            inputUrl.setPlaceholder([v.src])\n          }\n        })\n        inputUrl.setPlaceholder([v.src])\n        container.add(inputUrl)\n      } else if (value === 'innerText') {\n        let inputText = Lab.ui.createInput('text', v.innerText, ds => {\n          let t = ds[0] || ''\n          v.innerText = t\n        })\n        container.add(inputText)\n      }\n    }\n  }\n}\n\nasync function doData (e) {\n  // console.log(e)\n  let webview = e.target\n  webview.zoomFactor = 0.1\n  await Lab.base.sleep(500)\n  window.scrollTo(0, 999999999999)\n  await Lab.base.sleep(3000)\n  let code = ''\n  console.log(webview.src)\n  // 设置url的来源\n  if (webview.src.match('mp.weixin.qq.com')) {\n    code = `\n        var ks=Array.from(document.head.querySelectorAll('meta'),m=>{\n            return {property:m.getAttribute('property'),content:m.getAttribute('content')}\n        }).filter(f=>f.property==='og:title'||f.property==='og:description'||f.property==='og:image');\n        \n        var kd={\n            type:'weixin',\n            url:document.URL,\n            author:document.querySelector('#js_name').innerText.trim(),\n            text:document.querySelector('#js_content').innerText\n        };\n        Array.from(ks,k=>{\n            kd[k.property.replace('og:','')]=k.content\n        });\n\n        kd.imgs=Array.from(document.querySelectorAll('#js_content img'),img=>{\n            var obj;\n            console.log(img,img.complete)\n            if(img.parentElement.nextElementSibling){\n        \n            let tx=img.parentElement.nextElementSibling.innerText.trim();\n        \n            let dtype=img.getAttribute('data-type'),url=img.src;\n            let width=img.naturalWidth,height=img.naturalHeight;\n        \n            url.match('https')&&width!=height&&width>100?obj={url,text:tx,type:dtype,\n        width,height}:null;\n            \n            }\n            return obj;\n        }).filter(f=>f);\n\n        kd.relate=Array.from(document.querySelectorAll('.js_related_main a'),a=>{\n\n            let im=a.querySelector('.weui-media-box__ft').style.backgroundImage.replace('url(\"','').replace('\")',''),\n                title= a.querySelector('.weui_ellipsis_mod_inner').innerText,\n                author=a.querySelector('.relate_profile_nickname').innerText,\n                url=a.getAttribute('data-url');\n        \n            return{imurl:im,title,author,url};\n        });\n\n        kd;`\n  } else if (webview.src.match('producthunt.com')) {\n    code = `var ks = Array.from(document.head.querySelectorAll('meta'), m => {\n            return { property: m.getAttribute('property'), content: m.getAttribute('content') }\n        }).filter(f => f.property === 'og:title' || f.property === 'og:description' || f.property === 'og:image');\n\n        var exts;\n        try{exts=JSON.parse(Array.from(document.querySelectorAll('script'),s=>s.type=='application/ld+json'?s.innerText:'').filter(f=>f)[0])[0];}catch{};\n\n        var kd = {\n            type: 'producthunt',\n            url: document.URL,\n            applicationCategory:exts?.applicationCategory,\n            exts\n        };\n        Array.from(ks, k => {\n            kd[k.property.replace('og:', '')] = k.content\n        });\n        if(exts) kd.title=exts.name;\n        // kd.image = document.querySelector('.lazyload-wrapper source').src.replace(/\\\\?.*/ig, '');\n        if(exts) kd.image=exts.image;\n\n        kd.imgs = Array.from(document.querySelectorAll('.lazyload-wrapper img'), w => {\n            return { url: w.alt }\n        }).filter(f => f.url.match('http'));\n        kd.relate = Array.from(document.querySelectorAll('a'), a => {\n            return {\n                type: a.getAttribute('data-test'),\n                url: a.href, \n                imurl: (a.querySelector('video source') || a.querySelector('img'))?.src,\n                title: a.querySelectorAll('span')[0]?.innerText\n            }\n        }).filter(f => f.type === 'related-post');\n        kd;`\n  } else if (webview.src.match('baike.baidu.com')) {\n    code = `var text=document.querySelector('.lemma-summary').innerText;\n        var title=document.querySelector('h1').innerText;\n        var info=document.querySelector('.basic-info').innerText.split('\\\\n');\n        var res={title,text,info,type:'baike',url:document.URL};\n        res;`\n  }\n\n  let res = await webview.executeJavaScript(code)\n  console.log(res)\n  // for (const r of res) {\n  //     r.base64=await Lab.Image.getNativeImageFromWebview(r.url);\n  // };\n  if (res && webview.getAttribute('main-index'))\n    res.mainIndex = ~~webview.getAttribute('main-index')\n  if (res) {\n    res.id = Lab.base.hash({\n      title: res.title,\n      description: res.description,\n      image: res.image\n    })\n    // if (!dataset[res.id]) dataset[res.id] = res;\n    res.tags = extractArticalFeature(res)\n    dataset[res.id] = res\n    // console.log(res)\n    db.set('dataset', dataset)\n    tag.innerText = `收集 ${Object.keys(dataset).length}`\n\n    // 更新图谱\n    // let data = await createGraph();\n    // displayGraph(data);\n  }\n  webview.remove()\n  return res\n}\n\nasync function createCardHtml (index, cardData) {\n  let html = ''\n  let data = { ...cardData }\n\n  if (data.image) data.image = await getImgBase64(data.image)\n\n  if (data.type == 'weixin')\n    html = createHead(index, data.title, data.image, data.description)\n  if (data.type == 'producthunt')\n    html = oneImageLayout2(data.title, data.image, data.description)\n\n  let imgs = []\n  for (const im of data.imgs) {\n    let base64 = await getImgBase64(im.url)\n    // console.log(im)\n    if (im.type === 'gif') {\n      html += await createContent([base64])\n    } else {\n      imgs.push(base64)\n    }\n  }\n  html += await createContent(imgs)\n  // card.innerHTML=html;\n  // html+=createCopyHTMLBtn();\n  return html\n}\n\nfunction createCopyHTMLBtn () {}\n\nfunction createHead (index, title, image, description) {\n  return `<section class=\"_design-ai-lab\" data-tools=\"mixlab无界社区\">\n    <section style=\"margin: 1em auto;\">\n        <section style=\"display: flex;align-items: center;justify-content: center;align-items: flex-end;\">\n            <section style=\"box-sizing:border-box;margin-left: 10px;width: 100%;\" data-width=\"45%\">\n                <section style=\"text-align: left;height: 2em;\">\n                    <section class=\"autonum\" style=\"box-sizing:border-box;font-size: 20px;color: #fff;text-align: center;background-image: linear-gradient(to bottom, ${colors.highlight[0]} ,${colors.highlight[1]});display: inline-block;width: 35px;height: 28px;line-height: 28px;\">\n                        <strong style='width: 100%;display: block;'>${index}</strong>\n                    </section>\n                </section>\n                <section style=\"margin-left: 10px;margin-top: -15px;\">\n                    <section data-autoskip=\"1\" class=\"mix-brush\" style=\"text-align: justify;line-height:1.75em;letter-spacing: 1.5px;font-size:14px;background: ${colors.background};padding:1.3em 1em 1em 1em;color: ${colors.font};\">\n                        <p>\n                            <strong>${title}</strong>\n                        </p>\n                        <p>${description}\n                        </p>\n                    </section>\n                    \n                </section>\n            </section>\n            \n        </section>\n    </section></section>\n`\n}\n\nasync function createContent (imgs = []) {\n  if (imgs.length == 1) return oneImageLayout(imgs[0])\n  if (imgs.length >= 3) return await threeImageLayout(imgs)\n  if (imgs.length < 3) return ''\n}\n\nasync function threeImageLayout (imgs) {\n  console.log(imgs)\n  let ratios = [1.1555555555555554, 1.1555555555555554, 1.3737864077669903]\n  let newImages = []\n  for (let index = 0; index < imgs.length; index++) {\n    let im = imgs[index]\n    let img = await Lab.ui.createImage(im)\n    let canvas = await Lab.Image.smartCrop(\n      img,\n      400,\n      parseInt(400 / ratios[index])\n    )\n    newImages.push(canvas.toDataURL())\n  }\n  imgs = newImages\n\n  return `<section class=\"_design-ai-lab\" data-tools=\"mixlab无界社区\">\n    <section style=\"margin: 10px 2em;text-align: right;\">\n        <section style=\"display: flex;justify-content: center;align-items: flex-end;\">\n            <section style=\"display: flex;flex-direction: column;flex: 1;\">\n                <section style=\"display: flex;justify-content: flex-start;\">\n                    <section class=\"mix-brush\" data-brushtype=\"text\" style=\"font-size: 13px;letter-spacing: 1.5px;padding: 4px 1em;color: ${colors.font};display: inline-block;writing-mode: vertical-lr ;\">\n                        ENJOY\n                    </section>\n                </section>\n                <section style=\"display: flex;justify-content: center;align-items: center;margin-top: 1em;\">\n                    <section style=\"box-sizing:border-box;width: 100%;margin-right: 20px;\" data-width=\"100%\">\n                        <img style=\"box-sizing:border-box;width: 100%;display: block;\" src=\"${imgs[0]}\" data-ratio=\"1.1555555555555554\" data-w=\"135\" data-width=\"100%\"/>\n                    </section>\n                    <section style=\"box-sizing:border-box;width: 100%;margin-right: 10px;\" data-width=\"100%\">\n                        <img style=\"box-sizing:border-box;width: 100%;display: block;\" src=\"${imgs[1]}\" data-ratio=\"1.1555555555555554\" data-w=\"135\" hm_fix=\"325:318\" data-width=\"100%\"/>\n                    </section>\n                </section>\n                <section style=\"display: flex;justify-content: flex-start;margin-top: 1em;\">\n                    <section style=\"box-sizing:border-box;width: 10%;height: 4px;background:${colors.highlight[0]};\" data-width=\"10%\"></section>\n                </section>\n            </section>\n            <section style=\"box-sizing:border-box;width: 40%;\" data-width=\"40%\">\n                <section class=\"assistant\" style=\"display: flex;justify-content: flex-end;\">\n                    <section style=\"box-sizing:border-box;width: 10%;height: 4px;background:${colors.highlight[1]};\" data-width=\"10%\"></section>\n                </section>\n                <section style=\"box-sizing:border-box;width: 100%;margin-top: 20px;\" data-width=\"100%\">\n                    <img style=\"box-sizing:border-box;width: 100%;display: block;\" src=\"${imgs[2]}\" data-ratio=\"1.3737864077669903\" data-w=\"206\" data-width=\"100%\"/>\n                </section>\n            </section>\n        </section>\n    </section>\n</section>\n`\n}\n\nfunction talkMore (img, texts = []) {\n  // let im= await Lab.ui.createImage(img);\n  // let c=new Lab.Color();\n  // let color=(await c.getColor(im))||[0,0,0];\n  \n  // console.log(texts)\n  let isLeft = false\n  let res = []\n  for (const text of texts) {\n    if(!window.talkColors||(window.talkColors&&window.talkColors.length<=0)){\n      window.talkColors=['rgb(255 245 245)','rgb(246 255 245)','rgb(245 255 254)','rgb(247 245 255)','rgb(255 245 252)'];\n    }\n    let color=window.talkColors.pop();\n    if (isLeft) {\n      res.push(`<section class=\"mix-editor\" style='margin:12px 0;'>\n            <section style=\"display: flex;\">\n                <section style=\"display: flex;\n                max-width: 60%;\n                justify-content: flex-start;\">\n                    ${\n                      texts.indexOf(text) >= texts.length - 2\n                        ? `<p style='font-size:10px;color:rgb(212 212 212)'>#</p>`\n                        : ''\n                    }\n                    <section\n                        style=\"border-radius: 32px; background-color:${color}; padding: 10px 18px; display: inline-block; color: rgb(17, 17, 17);  margin-left: 25px; box-sizing: border-box;\">\n                        <p style=\"margin: 0px;clear: none !important;font-size: 14px;font-weight: 300;min-width: 112px;\" class='mix-variable meta-human-dialogue' variable-attribute='innerText'>${text}</p>\n                    </section>\n                </section>\n            </section>\n        </section>`)\n      isLeft = false\n    } else {\n      res.push(`<section class=\"mix-editor\" style='margin:12px 0;'>\n                <section style=\"display: flex;justify-content: flex-end;\">\n                    <section style=\"display: flex;\n                    max-width: 60%;\n                    justify-content: flex-end;\">\n                        <section\n                            style=\"border-radius: 32px; background-color:${color}; padding: 10px 18px; display: inline-block; color: rgb(17, 17, 17);margin-right: 25px; box-sizing: border-box;\">\n                            <p style=\"margin: 0px;clear: none !important;font-size: 14px;font-weight: 300;min-width: 112px;\" class='mix-variable meta-human-dialogue' variable-attribute='innerText'>${text}</p>\n                        </section>\n                        ${\n                          texts.indexOf(text) === 0\n                            ? `<p style='font-size:10px;color:rgb(212 212 212)'>#</p>`\n                            : ''\n                        }\n                    </section>\n                </section>\n            </section>`)\n      isLeft = true\n    }\n  }\n  console.log(res)\n  return res.join('')\n}\n\nfunction oneImageLayout2 (title, imgurl, description, isLeft = true) {\n  let oImg = `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAeCAYAAABE4bxTAAADA0lEQVRYR8XXX0hTURwH8O/vbrubFQmBL2IvuZmC4EMP/YEebFtCUO/VSxBRUA89BCG5p0TIwB6C8qGHFf2hQEsKI92cUOhDpkFJ7s6sQASfpDJxu39+cTZXmvtz73bN87Kxnfs9n3vO72znElbaoKK2kYNfBWrlt9nPNuOV/oKSJ4joPkA9umGEWna7pzYVFIuxU69R4wB2AdAJ6AFwze+Tx/8n7M8MiUEjSuosCN2rAQwegCFdD9Q5o0TEG41bA+pPsFuGNgNwdY6BPxHhVpJd94746MdGwdaAxCDRROoiAzcKDLgIxkMQhQM+16jdsHWg2Bf26JqqANhZbDACpgAKS5r2uLmh4mux/ma+XwdK11IidRrAHTMB2T4MvCNQj6TrvYfqPWJzlNRygsSOM2rUCQYaS0oFJon4qcHUG/TJE1YycoIyO04NgnjASlievjMAXjJ40FiSIy1N9KtQZl6QuGgwofYR+JgNqGxEiog7/V53KF9mQVA0sVzLkD4AqLAR9Y1Bp4I+13CuzIKgTIGrrQB32AgSUQ8cSde55kZa/De3KGhsjF3fK9XxMgo8570wUyhY52q3DMrUUmofAW8AOGycqQUGrgR98u3VmUVnKNs5Op28ykxtNoIA0ByD21ejTIPE0i1UqqME7LEXhQVm6lre5uw6Wk1LpkHppVOSDUQ0BmCLzSiAEJYMdFsCZXZd8iQgDnL2N3HUsQxaKfKbBFywm0QMkWu9PfnI8g63GgNwwPrVea+YB9HxkkAisj/BVS6oIwR4bUERdwa87sslgwQiNr3sNVgaYaCqLBQhAjLOB2o9SlkggRhSUnsNwlAZO08hGJf8Ps9zkVc2KF3kcTVAEvdZR9EsMYf8dXI4O8O2gNI/B3H1ICR+AWC7yeVTQOgIeOW7Jf11mBkkklD3Azyyvi/NApggGJNgirOTx/Wf8udchzXbZihdT/FUkyHhvXjPwDQIEQIPG5r2+nD91jkzN2UrSDwcMHCGmHrh0J+JXWMGsZFL1urQtEflPBL9BktnFDZhBW8qAAAAAElFTkSuQmCC`\n  // console.log(description)\n  description = description.replace(/\\n/gi, '<br>')\n  if (isLeft) {\n    return `<section class=\"mix-editor\" style='margin: 2em 0;'>\n        <section style=\"display: flex;\">\n            <section style=\"display: inline-block;width: 56px;\">\n                <section\n                    style=\"width: 48px;height: 48px;overflow: hidden;border-radius: 50%;margin: 0px auto;text-align: center;box-sizing: border-box;\">\n                    <img src=\"${imgurl}\" style=\"width: 50px; height: auto; max-width: 100%;\" class='mix-variable meta-human-avatar' variable-attribute='src'></section>\n                <p style=\"margin: 5px auto;color:#333;text-align:center;font-size: 10px;font-weight: 800;\" class='mix-variable meta-human-name' variable-attribute='innerText'>${title}</p>\n            </section>\n            <section style=\"display: inline-block;\">\n                <section\n                    style=\"border-radius: 25px; background-color:rgb(239 239 239); padding: 15px; display: inline-block; color: rgb(17, 17, 17); margin-top: 13px; margin-left: 25px; box-sizing: border-box;\">\n                    <p style=\"margin: 0px;clear: none !important;font-size: 14px;font-weight: 300;\" class='mix-variable meta-human-dialogue' variable-attribute='innerText'>${description}</p>\n                </section>\n            </section>\n        </section>\n    </section>`\n  } else {\n    return `<section class=\"mix-editor\" style='margin: 2em 0;'>\n        <section style=\"display: flex;justify-content: flex-end;\">\n\n            <section style=\"display: inline-block;\">\n                <section\n                    style=\"border-radius: 25px; background-color:rgb(188, 219, 250); padding: 15px; display: inline-block; color: rgb(17, 17, 17); margin-top: 13px; margin-right: 25px; box-sizing: border-box;\">\n                    <p style=\"margin: 0px;clear: none !important;font-size: 14px;font-weight: 300;\" class='mix-variable meta-human-dialogue' variable-attribute='innerText'>${description}</p>\n                </section>\n            </section>\n\n            <section style=\"display: inline-block;width: 56px;\">\n                <section\n                    style=\"width: 48px;height: 48px;overflow: hidden;border-radius: 50%;margin: 0px auto;text-align: center;box-sizing: border-box;\">\n                    <img src=\"${imgurl}\" style=\"width: 50px; height: auto; max-width: 100%;\" class='mix-variable meta-human-avatar' variable-attribute='src'></section>\n                <p style=\"margin: 5px auto;color:#333;text-align:center;font-size: 10px;font-weight: 800;\" class='mix-variable meta-human-name' variable-attribute='innerText'>${title}</p>\n            </section>\n            \n        </section>\n    </section>`\n  }\n}\n\nasync function oneImageLayout (name, img, dialogue) {\n  let dt = new Date()\n  let im = await Lab.ui.createImage(img)\n  let c = new Lab.Color()\n  let color = (await c.getColor(im)) || [0, 0, 0]\n  // console.log(color)\n  return `<section class=\"mix-editor\">\n    <section class=\"\"\n        style=\"border: 1px dotted ${colors.highlight[1]}; \n        margin: 0 11px; \n        padding: 14px 19px 22px 18px; \n        box-sizing: border-box !important;\">\n        <section style=\"display: flex; flex-direction: column;\">\n            <section style=\"display: flex; justify-content: space-between;\">\n                <section>\n                    <p\n                        style=\"color:rgb(${color.join(\n                          ','\n                        )}); font-size: 16px; font-weight: bold; line-height: 16px; font-family: '思源黑体'; letter-spacing: 1px; margin: 0\">\n                        ${name}</p>\n                </section>\n                <section>\n                    <p\n                        style=\"color: ${\n                          colors.highlight[1]\n                        }; font-size: 10px; line-height: 14px; font-family: '思源黑体'; letter-spacing: 1px; margin: 0\">\n                        ${dt.getFullYear()}.${dt.getMonth() +\n    1}.${dt.getDate()}</p>\n                </section>\n            </section>\n            <section style=\"margin-top: 9px;\">\n                <p\n                    style=\"color: ${\n                      colors.highlight[1]\n                    }; font-size: 14px; line-height: 14px; font-family: '思源黑体'; letter-spacing: 1px; margin: 0\">\n                    I LOVE TO TRAVEL</p>\n            </section>\n            <section style=\"margin-top: 13px;\"><img\n                    style=\"max-width: 100%; width: 100%; display: block; height: auto;\"\n                    src=\"${img}\"\n                    alt=\"\"></section>\n            <section\n                style=\"width: 61px;height: 6px;background-color: ${\n                  colors.background\n                };text-align: right;align-self: flex-end;margin-top: 7px;\">\n            </section>\n            <section style=\"display: flex;justify-content: space-between;align-items: center;margin-top: 17px;\">\n                 <p tyle=\"color: ${colors.highlight[1]}; \n                 font-size: 12px; line-height: 14px; \n                 font-family: '思源黑体'; \n                 letter-spacing: 1px; \n                 margin: 0\">\n                            ${dialogue}</p>\n            </section>\n        </section>\n    </section>\n</section>`\n}\n\n// 头像嵌入文本\nfunction inLineText(name, img, dialogue){\n   return `<section class=\"mix-editor\" style=\"margin: 2em 0;\">\n        <section style=\"margin: 0 16px;\">\n            <p style=\"\n            font-size: 10px;display: inline;\"><img src=\"${img}\" \n            style=\"width: 32px;height: auto;border-radius:100%;\" \n            class=\"mix-variable meta-human-avatar\" \n            variable-attribute=\"src\"> </p>\n            <p style=\"\n            font-size: 10px;\n            margin-right: 8px;display: inline;\">${name}</p> \n            <p style=\"margin: 0px;clear: none !important;font-size: 14px;font-weight: 300;line-height: 28px;display: inline;\" \n            class=\"mix-variable meta-human-dialogue\" \n            variable-attribute=\"innerText\">${dialogue}</p>\n        </section>\n    </section>`\n}\n\nasync function setColorsForGraph () {\n  cards.innerHTML = ''\n  let data = await createGraph()\n\n  _GRAPHE_COLORS = Array.from(\n    data.categories,\n    (c, i) => _GRAPHE_COLORS[i % _GRAPHE_COLORS.length]\n  )\n\n  data.categories.forEach((c, index) => {\n    let cg = Lab.ui.createGroup('row')\n    cg.style = `display: flex;\n            justify-content: space-between;`\n\n    let text = `${c} - ${data.categoriesCount[c]}`\n\n    let cIn = Lab.ui.createInput(\n      'color',\n      text,\n      newColors => {\n        _GRAPHE_COLORS[index] = newColors[0]\n        db.set('_GRAPHE_COLORS', _GRAPHE_COLORS)\n      },\n      true,\n      false\n    )\n    cIn.setDefaultValue([_GRAPHE_COLORS[index]])\n    cg.add(Lab.ui.createBaseText(text))\n    cg.add(cIn)\n    cards.add(cg)\n  })\n}\n\nasync function resetColorsForGraph () {\n  cards.innerHTML = ''\n  let data = await createGraph()\n  _GRAPHE_COLORS = [\n    '#5470c6',\n    '#91cc75',\n    '#fac858',\n    '#ee6666',\n    '#73c0de',\n    '#3ba272',\n    '#fc8452',\n    '#9a60b4',\n    '#ea7ccc'\n  ]\n  _GRAPHE_COLORS = Array.from(\n    data.categories,\n    (c, i) => _GRAPHE_COLORS[i % _GRAPHE_COLORS.length]\n  )\n\n  data.categories.forEach((c, index) => {\n    let cg = Lab.ui.createGroup('row')\n    cg.style = `display: flex;\n            justify-content: space-between;`\n\n    let text = `${c} - ${data.categoriesCount[c]}`\n\n    let cIn = Lab.ui.createInput(\n      'color',\n      text,\n      newColors => {\n        _GRAPHE_COLORS[index] = newColors[0]\n        db.set('_GRAPHE_COLORS', _GRAPHE_COLORS)\n      },\n      true,\n      false\n    )\n    cIn.setDefaultValue([_GRAPHE_COLORS[index]])\n    cg.add(Lab.ui.createBaseText(text))\n    cg.add(cIn)\n    cards.add(cg)\n  })\n}\n\nasync function runCreateGraph () {\n  Lab.ui.loading(0)\n  if (!myChart) initGraph()\n  resetGraph()\n  let data = await createGraph()\n  displayGraph(data)\n  // Lab.clipboard.write(JSON.stringify(data));\n  displayTags(data.tags)\n  setTimeout(() => Lab.ui.loading(100), 500)\n}\n\nasync function createGraph () {\n  var links = [],\n    nodes = [],\n    tags = {},\n    categories = [],\n    categoriesCount = {},\n    // 推荐次序\n    levels = []\n\n  let datasetNew = { ...dataset }\n\n  // categories用来分类的字段\n  for (let id in datasetNew) {\n    let data = datasetNew[id]\n    if (data.hasOwnProperty('applicationCategory')) {\n      datasetNew[id]['author'] = data['applicationCategory'] || '-'\n    }\n  }\n\n  // 使用author作为分类\n  for (let id in datasetNew) {\n    let data = datasetNew[id]\n    // console.log(data.author)\n    if (!categories.includes(data.author)) categories.push(data.author)\n    if (!levels.includes(data.mainIndex)) levels.push(data.mainIndex)\n    Array.from(data.tags, t => {\n      if (!tags[t.keyword]) tags[t.keyword] = 0\n      tags[t.keyword] += t.weight\n    })\n  }\n  let tagsList = []\n  for (const keyword in tags) {\n    tagsList.push({\n      weight: tags[keyword],\n      keyword\n    })\n  }\n  tags = tagsList.sort((a, b) => b.weight - a.weight)\n  // console.log(tags)\n\n  for (let id in datasetNew) {\n    let data = datasetNew[id]\n\n    // 获得图片的base64\n    data.image = await getImgBase64(data.image)\n\n    nodes.push({\n      id,\n      title: data.title,\n      value: 0,\n      mainIndex: data.mainIndex,\n      category: data.author,\n      tags: data.tags,\n      image: data.image,\n      targetCategories: {}\n    })\n    // 统计分类下面的数量\n    if (!categoriesCount[data.author]) categoriesCount[data.author] = 0\n    categoriesCount[data.author]++\n  }\n\n  for (let id in datasetNew) {\n    let data = datasetNew[id]\n    Array.from(data.relate, r => {\n      let t = r.url.replace(/.*s\\?/gi, '')\n      let tid, tauthor\n      //     console.log(t);\n      for (let m in datasetNew) {\n        let n = datasetNew[m].url.replace(/.*s\\?/gi, '')\n        if (t == n) {\n          tid = m\n          tauthor = datasetNew[m].author\n        }\n      }\n      if (tid) {\n        links.push({ source: id, target: tid, sourceCategory: data.author })\n        // console.log(id == tid);\n        // 计算节点权重，link越多，节点越大\n        Array.from(nodes, n => {\n          if (n.id == tid) {\n            n.value++\n            if (!n.targetCategories[data.author])\n              n.targetCategories[data.author] = []\n            n.targetCategories[data.author].push(data.title)\n          }\n        })\n      }\n    })\n  }\n\n  // 排序\n  categories = Array.from(categories, c => {\n    return {\n      name: c,\n      score: categoriesCount[c]\n    }\n  }).sort((a, b) => b.score - a.score)\n  categories = Array.from(categories, c => c.name)\n  // categories = categories.sort((a, b) => a.localeCompare(b));\n\n  links = links.sort((a, b) => a.sourceCategory.localeCompare(b.sourceCategory))\n\n  nodes = nodes.sort((a, b) => a.category.localeCompare(b.category))\n\n  levels = levels.sort((a, b) => a - b)\n\n  return { links, nodes, categories, tags, categoriesCount, levels }\n}\n\nfunction displayTags (tagsAll) {\n  let topN = Lab.ui.createTags(\n      Array.from(tagsAll.slice(0, 10), t => t.keyword)\n    ),\n    bottomN = Lab.ui.createTags(\n      Array.from(\n        tagsAll.slice(tagsAll.length - 10, tagsAll.length),\n        t => t.keyword\n      )\n    ),\n    otherN = Lab.ui.createTags(\n      Array.from(tagsAll.slice(10, tagsAll.length - 10), t => t.keyword)\n    )\n  // console.log(topN)\n  let data = [\n    {\n      active: true,\n      title: 'TOP10',\n      data: Array.from(topN.children, c => c.outerHTML)\n    }\n  ]\n  if (bottomN.children.length > 0)\n    data.push({\n      active: false,\n      title: 'BOTTOMN',\n      data: Array.from(bottomN.children, c => c.outerHTML)\n    })\n  if (otherN.children.length > 0)\n    data.push({\n      active: false,\n      title: '其他',\n      data: Array.from(otherN.children, c => c.outerHTML)\n    })\n\n  cards.innerHTML = ''\n  let div = Lab.ui.createAccordion(data)\n  cards.add(div)\n}\n\n// 提取文章特征\nfunction extractArticalFeature (d) {\n  var dts = {}\n  Array.from(\n    Lab.nlp.jieba.extract((d.title + ' ' + d.description).toLowerCase(), 10),\n    t => (dts[t.keyword] = t.weight)\n  )\n  // console.log(dts);\n  dts = Array.from(\n    Lab.nlp.jieba.extract(\n      d.text ? d.text.toLowerCase() : d.description.toLowerCase(),\n      30\n    ),\n    t => {\n      if (dts[t.keyword]) return t\n    }\n  ).filter(f => f)\n  return dts\n}\n\nfunction initGraph () {\n  let c = Lab.ui.createGroup('container')\n  c.style = `position: fixed;\n    bottom: 0;\n    right: 0;\n    outline: gray solid 1px;\n    height: 300px;\n    width: 300px;\n    background: #fff;`\n  let m = Lab.ui.createGroup('container')\n  m.style = `height: 100%;\n    width: 100%;`\n  // let script = document.createElement('script');\n  // script.type = \"text/javascript\";\n  // script.src = \"https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js\";\n  // c.add(script);\n  mainDiv.add(c)\n  c.add(m)\n\n  let btns = Lab.ui.createGroup('column')\n  c.add(btns)\n  btns.style = `position: absolute;\n    top: 0;`\n\n  let btn = Lab.ui.createIcon(\n    'copy',\n    async () => {\n      let im = await Lab.ui.createImage(\n        myChart.getDataURL({\n          type: 'jpeg',\n          pixelRatio: 2,\n          backgroundColor: '#fff',\n          excludeComponents: ['toolbox', 'legend', 'title']\n        })\n      )\n      cards.add(im)\n    },\n    false\n  )\n  btns.add(btn)\n\n  let scaleBtn = Lab.ui.createIcon(\n    'light',\n    async () => {\n      if (c.style.width === '300px') {\n        c.style.width = '100%'\n        c.style.height = '100%'\n        c.style.top = '0'\n      } else {\n        c.style.width = '300px'\n        c.style.height = '300px'\n        c.style.top = 'auto'\n        c.style.bottom = '0'\n      }\n\n      myChart.resize()\n    },\n    false\n  )\n  btns.add(scaleBtn)\n\n  let toggleBtn = Lab.ui.createIcon(\n    'play',\n    async () => {\n      _GRAPHE_LABEL++\n      if (_GRAPHE_LABEL > 3) _GRAPHE_LABEL = 0\n      myChart.resize()\n    },\n    false\n  )\n  btns.add(toggleBtn)\n\n  // 改变布局类型\n  let layoutBtn = Lab.ui.createIcon(\n    'fan',\n    async () => {\n      if (_GRAPHE_LAYOUT === 'circular') {\n        _GRAPHE_LAYOUT = 'force'\n      } else {\n        _GRAPHE_LAYOUT = 'circular'\n      }\n      resetGraph()\n      let data = await createGraph()\n      displayGraph(data)\n    },\n    false\n  )\n  btns.add(layoutBtn)\n\n  // 改变分类\n  let cBtn = Lab.ui.createIcon(\n    'thumbtack',\n    async () => {\n      if (_GRAPHE_C_BY_L === true) {\n        _GRAPHE_C_BY_L = false\n      } else {\n        _GRAPHE_C_BY_L = true\n      }\n      resetGraph()\n      let data = await createGraph()\n      displayGraph(data)\n    },\n    false\n  )\n  btns.add(cBtn)\n\n  resetGraph(m)\n}\n\n// 重设\nfunction resetGraph (dom) {\n  if (myChart) {\n    if (!dom) dom = myChart.getDom()\n    myChart.dispose()\n  }\n\n  let option = {\n    title: {\n      text: '',\n      subtext: '',\n      top: 'bottom',\n      left: 'right'\n    },\n    tooltip: {\n      triggerOn: 'click',\n      formatter: e => {\n        return `${e.data.categoryName} _ ${e.data.value} \n                <br> 🔥 ${e.name}\n                <br> ${(() => {\n                  let text = ''\n                  for (const ct in e.data.targetCategories) {\n                    text += `💡 ${ct} <br>${e.data.targetCategories[ct].join(\n                      '<br>'\n                    )}<br>`\n                  }\n                  return text\n                })()}`\n      }\n    },\n    color: _GRAPHE_COLORS,\n    // legend: [{\n    //     data: graph.categories.map(function (a) {\n    //         return a.name\n    //     })\n    // }],\n    zoom: 0.8,\n    animationDurationUpdate: 1500,\n    animationEasingUpdate: 'quinticInOut',\n    emphasis: {\n      focus: 'adjacency'\n      //blurScope: 'coordinateSystem'\n    },\n    series: [\n      {\n        name: '',\n        type: 'graph',\n        layout: _GRAPHE_LAYOUT,\n        circular: {\n          rotateLabel: true\n        },\n        data: [],\n        links: [],\n        categories: [],\n        roam: true,\n        label: {\n          position: 'right',\n          fontSize: 10,\n          formatter: function (b) {\n            // console.log(b)\n            //b.data.categoryName\n            //b.data.tags[0].keyword\n            let t = b.data.tags[0] ? b.data.tags[0].keyword : ''\n\n            //b.name\n            if (_GRAPHE_LABEL === 0) return b.data.categoryName\n            if (_GRAPHE_LABEL === 1) return t\n            if (_GRAPHE_LABEL === 2) return ''\n            return b.name\n          }\n        },\n        lineStyle: {\n          color: 'source',\n          curveness: 0.3\n        },\n        force: {\n          repulsion: 100\n        },\n        left: 10,\n        top: 10,\n        right: 10,\n        bottom: 10\n      }\n    ]\n  }\n\n  if (dom) myChart = echarts.init(dom, null, { renderer: 'canvas' })\n  //myChart.setOption(option);\n\n  if (dom && option && typeof option === 'object') {\n    myChart.setOption(option)\n  }\n}\n\nfunction displayGraph (graph = {}) {\n  // var myChart = echarts.init(dom);\n  // myChart.showLoading();\n  // setTimeout(() => myChart.hideLoading(), 1000);\n  if (_GRAPHE_C_BY_L == true) {\n    graph.categories = Array.from(graph.levels, (c, i) => {\n      return {\n        name: `相关性${c}`,\n        icon: 'circle'\n      }\n    })\n  } else {\n    graph.categories = Array.from(graph.categories, (c, i) => {\n      return {\n        name: c,\n        icon: 'circle'\n      }\n    })\n  }\n\n  graph.nodes.forEach(function (node) {\n    node.name = node.title\n    node.label = {\n      show: true\n    }\n    node.symbolSize = Math.max(20, node.value * 2)\n    node.symbol = `image://${node.image}`\n\n    node.categoryName = node.category\n    if (_GRAPHE_C_BY_L == true) {\n      node.category = node.mainIndex\n    } else {\n      node.category = Array.from(graph.categories, (c, i) => {\n        if (c.name == node.categoryName) return i\n      }).filter(f => f != undefined)[0]\n    }\n  })\n\n  // 填入数据\n  if (myChart)\n    myChart.setOption({\n      layout: _GRAPHE_LAYOUT,\n      // colors:[\"#003366\", \"#006699\", \"#4cabce\", \"#e5323e\"],\n      legend: [\n        {\n          type: 'scroll',\n          left: '80%',\n          right: 12,\n          top: 24,\n          height: '80%',\n          orient: 'vertical',\n          data: graph.categories,\n          itemStyle: {\n            borderWidth: 2\n          }\n        }\n      ],\n      series: [\n        {\n          data: graph.nodes,\n          links: graph.links,\n          categories: graph.categories\n        }\n      ]\n    })\n\n  return\n}\n\nfunction clearDataset () {\n  dataset = {}\n  db.set('dataset', {})\n  cards.innerHTML = ''\n  tag.innerText = `收集 ${Object.keys(dataset).length}`\n}\n\nfunction selectForCreate () {\n  selectModel.show()\n  selectModel.querySelector('.content').innerHTML = ''\n  selectModel.querySelector('.content').style = `height: 80vh;overflow: scroll;`\n  // selectModel.querySelector('.content').setAttribute('contenteditable', true);\n\n  var datas = []\n  for (let id in dataset) {\n    datas.push(dataset[id])\n  }\n  datas = datas.sort((a, b) => b.mainIndex)\n\n  let tags = Lab.ui.createTags(\n    Array.from(datas, d => {\n      return {\n        id: d.id,\n        label: d.title\n      }\n    })\n  )\n  Array.from(tags.querySelectorAll('.label'), i =>\n    i.addEventListener('click', e => {\n      // console.log(e);\n      e.target.classList.toggle('red')\n    })\n  )\n  selectModel.add(tags)\n  // selectBtn.setAttribute('data-click', '2');\n}\n\n// metahuman\nfunction updateMetaHuman (metaHumanObj) {\n  // let metaHumanObj = {\n  //     avatar: htmlDiv.querySelector('.meta-human-avatar').src,\n  //     name: htmlDiv.querySelector('.meta-human-name').innerText,\n  //     dialogue: htmlDiv.querySelector('.meta-human-dialogue').innerText\n  // };\n\n  let avatarId = Lab.base.hash(metaHumanObj.avatar)\n  metaHumanAvatarsStore.set(avatarId, {\n    base64: metaHumanObj.avatar,\n    id: avatarId\n  })\n\n  let data = {\n    name: metaHumanObj.name,\n    // avatar: metaHumanObj.avatar,\n    avatarId,\n    dialogue: metaHumanObj.dialogue\n  }\n\n  let id = Lab.base.hash(data)\n\n  if (!metaHuman[id]) {\n    metaHuman[id] = {\n      id,\n      ...data,\n      avatar: metaHumanObj.avatar\n    }\n    metaHumanStore.set(id, {\n      id,\n      ...data\n    })\n  }\n}\n\n// // GUI\n// function createResultPannel(htmlDiv){\n//     let copyBtn = Lab.ui.createButton('拷贝', e => {\n//         // console.log(htmlDiv)\n//         Lab.clipboard.write(htmlDiv.innerHTML, 'html');\n//     }, false);\n//     return copyBtn\n\n// }\n\nasync function loadAppStore () {\n  let container = Lab.ui.createGroup()\n  let title = Lab.ui.createHeader(2, '从APP')\n  container.add(title)\n\n  let appStore = new Lab.AppStore()\n  let ids = await appStore.getIds()\n  let dom = Lab.ui.createSelect(\n    'APP',\n    'APP',\n    Array.from(ids, k => {\n      return { value: k.id, text: k.name }\n    })\n  )\n  container.add(dom)\n  container.add(Lab.ui.createDivider())\n\n  container.getValue = async () => {\n    let id = dom.getValue()\n    return await appStore.load(id)\n  }\n  // console.log(dom)\n\n  let selectBtn = Lab.ui.createButton('确定', async () => {\n    // selectModel.clear();\n    // let ds=nextForCreate(selectModel);\n    // selectModel.add(ds);\n    // // let runBtn = Lab.ui.createButton('生成', runForCreate, false);\n    // // selectModel.add(runBtn, 'header');\n    // selectModel.show();\n    let data = await container.getValue()\n    if (data.id === '46dadd69e2d7d3484ad99dae9a970b1799ccb3f8') {\n      // product-hunt信息整理\n      let d = Lab.base.shuffle([...data.data])\n      let avatar = await getImgBase64(d[0].imgurl)\n      metaHumanDiv.update({\n        name: d[0].title,\n        avatar: avatar,\n        dialogue: d[0].description + '\\n' + d[0].url\n      })\n    } else if (data.id === '35eb0e192e4e006778b4ca0f8d85028d592638b2') {\n      // 文本动图合成\n      let avatar = await getImgBase64(data.data)\n      metaHumanDiv.update({\n        name: data.name,\n        avatar: avatar,\n        dialogue: ''\n      })\n    } else if (data.id === '4c28836a5728d77c47b02b4f755543b0b0389172') {\n      // 图片工具\n      let avatar = await getImgBase64(data.data)\n      metaHumanDiv.update({\n        name: data.name,\n        avatar: avatar,\n        dialogue: ''\n      })\n    }\n  })\n  container.add(selectBtn)\n\n  return container\n}\n\nfunction createSpiderInput () {\n  let container = Lab.ui.createGroup()\n  let title = Lab.ui.createHeader(2, '网页')\n  container.add(title)\n\n  let selectModel = Lab.ui.createModel('选择')\n  container.add(selectModel)\n\n  let selectBtn = Lab.ui.createButton('选择', () => {\n    selectModel.clear()\n    let ds = nextForCreate(selectModel)\n    selectModel.add(ds)\n    // let runBtn = Lab.ui.createButton('生成', runForCreate, false);\n    // selectModel.add(runBtn, 'header');\n    selectModel.show()\n  })\n  let spiderBtn = Lab.ui.createButton('粘贴URL获取文章', pasteAndSpider, false)\n\n  container.add(selectBtn)\n  container.add(spiderBtn)\n\n  return container\n}\n\nfunction createMetaHumanInput () {\n  let container = Lab.ui.createGroup()\n  let humanSelectModel = Lab.ui.createModel('选择')\n  container.add(humanSelectModel)\n\n  let title = Lab.ui.createHeader(2, '人物')\n  container.add(title)\n\n  let num = Lab.ui.createBaseText(Object.keys(metaHuman).length)\n  container.add(num)\n  container.updateCount = n => {\n    num.innerText = n\n    // console.log(num)\n  }\n\n  let histroy = Lab.ui.createIcon('plus', async () => {\n    let items = {}\n    for (const id in metaHuman) {\n      let h = metaHuman[id]\n      if (!items[h.name]) {\n        items[h.name] = {\n          avatars: {},\n          dialogues: []\n        }\n      }\n      items[h.name].avatars[h.avatarId] = h.avatar\n      //参数扩展\n      items[h.name].dialogues.push(h.dialogue)\n    }\n    // 如果无数据，则不需要弹窗\n    if (Object.keys(items).length === 0) return Lab.ui.toast('暂无')\n\n    let parentElement = Lab.ui.createGroup()\n    for (const name in items) {\n      let div = Lab.ui.createGroup()\n\n      div.add(Lab.ui.createHeader(2, name))\n      let avatarImgurls = []\n      for (const id in items[name].avatars) {\n        if (items[name].avatars[id])\n          avatarImgurls.push(\n            `<img src=\"${items[name].avatars[id]}\" style='width:44px;height:auto'/>`\n          )\n      }\n      let imgs = Lab.ui.createList(avatarImgurls)\n      for (const im of imgs.children) {\n        im.classList.add('label')\n        im.classList.add('ui')\n        im.setAttribute(\n          'data-item',\n          JSON.stringify({\n            imgurl: im.querySelector('img').src,\n            name\n          })\n        )\n        im.addEventListener('click', () => {\n          im.classList.toggle('blue')\n          humanSelectModel.hide()\n          let h = JSON.parse(im.getAttribute('data-item'))\n          // console.log(h)\n          container.update({\n            name: h.name,\n            avatar: h.imgurl,\n            dialogue: h.text\n          })\n        })\n      }\n      div.add(imgs)\n      let dialogues = Lab.ui.createList(items[name].dialogues)\n      for (const d of dialogues.children) {\n        d.classList.add('label')\n        d.classList.add('ui')\n        d.setAttribute(\n          'data-item',\n          JSON.stringify({\n            name,\n            text: d.innerText\n          })\n        )\n        d.addEventListener('click', () => {\n            d.classList.toggle('blue');\n            humanSelectModel.hide()\n            let h = JSON.parse(d.getAttribute('data-item'))\n            // console.log(h)\n            container.update({\n              name: h.name,\n              avatar: h.imgurl,\n              dialogue: h.text\n            })\n        })\n      }\n      div.add(dialogues)\n      //   div.add(Lab.ui.createFeed(items[name].data))\n      div.add(Lab.ui.createDivider())\n      parentElement.add(div)\n    }\n\n    // Array.from(parentElement.querySelectorAll('.blue'), item => {\n    //   item.addEventListener('click', e => {\n\n    //   })\n    // })\n\n    humanSelectModel.clear()\n    humanSelectModel.add(parentElement)\n    humanSelectModel.show()\n  })\n  container.add(histroy)\n  container.add(Lab.ui.createDivider())\n\n  let mHuman = {\n    avatar: null,\n    name: '',\n    dialogue: '',\n    type: 1\n  }\n\n  let inputUrl = Lab.ui.createImageAndPreview()\n  inputUrl.addEventListener('click', () => imgSelect.show())\n\n  const doImg = async base64 => {\n    if (base64 && base64.match('image/')) {\n      mHuman.avatar = base64\n      // console.log(base64.match('image/gif'))\n      if (isSmartCrop.getValue()) {\n        if (base64.match('image/gif')) {\n          base64 = await doGifCrop(base64)\n        } else {\n          base64 = await doImageOneCrop(base64)\n        }\n        inputUrl.setValue([base64])\n      } else {\n        inputUrl.setValue([base64])\n      }\n    }\n  }\n  let imgSelect = Lab.ui.createImageSelectModel(doImg)\n  // let imgSelect = createImageSelect(doImg);\n  container.add(imgSelect)\n  container.add(inputUrl)\n  container.add(Lab.ui.createDivider())\n\n  // smartCrop\n  let isSmartCrop = Lab.ui.createToggle({\n    name: '是否智能裁切',\n    label: '是否智能裁切',\n    checked: true\n  })\n  container.add(isSmartCrop)\n  container.add(Lab.ui.createDivider())\n\n  // 单图\n  // let isSingleImage = Lab.ui.createToggle({\n  //     name: '是否单图',\n  //     label: '是否单图',\n  //     checked:false\n  // });\n  let radio = Lab.ui.createRadio('类型', [\n    {\n      name: 'oneImage',\n      label: '单图'\n    },\n    {\n      name: 'left',\n      label: '左侧对白',\n      checked: true\n    },\n    {\n      name: 'right',\n      label: '右侧对白'\n    },\n    { name: 'talkClound', label: '群聊' },\n    {name:'inlineText',label:'内嵌'}\n  ])\n  container.add(radio)\n  // $(radio).checkbox()\n  container.add(Lab.ui.createDivider())\n\n  let inputName = Lab.ui.createInput('text', '昵称')\n  container.add(inputName)\n  container.add(Lab.ui.createDivider())\n\n  let inputDialogue = Lab.ui.createTextareaInput('对白')\n\n  container.add(inputDialogue)\n  container.add(Lab.ui.createDivider())\n\n  // let isRight = Lab.ui.createToggle({\n  //     name: '右对齐',\n  //     label: '右对齐'\n  // }, vs => {\n  //     mHuman.type = vs[0] ? 2 : 1;\n  // });\n  // container.add(isRight);\n  // container.add(Lab.ui.createDivider());\n\n  let btn = Lab.ui.createButton('生成', async () => {\n    console.log(radio.getValue())\n    let type = radio.getValue()\n    if (type === 'left' || type === 'right') {\n      mHuman.avatar = inputUrl.getValue()\n      mHuman.name = inputName.getValue()\n      mHuman.dialogue = inputDialogue.getValue()\n      mHuman.type = type === 'right' ? 2 : 1\n      // console.log(mHuman)\n      updateMetaHuman(mHuman)\n      await createBaseHtml(\n        mHuman.avatar,\n        mHuman.type,\n        mHuman.name,\n        mHuman.dialogue\n      )\n      num.innerText = Object.keys(metaHuman).length\n    } else if (type === 'oneImage') {\n      let img = inputUrl.getValue()\n      let title = inputName.getValue()\n      let text = inputDialogue.getValue()\n      let data = {\n        img,\n        title,\n        text\n      }\n      await createBaseHtml(img, 0, title, text)\n      // console.log(data);\n    } else if (type === 'talkClound') {\n      let img = inputUrl.getValue()\n      let title = inputName.getValue()\n      let text = inputDialogue.getValue()\n      await createBaseHtml(img, 3, title, text)\n      console.log('talkClound', text)\n    }else if(type === 'inlineText'){\n      let img = inputUrl.getValue()\n      let title = inputName.getValue()\n      let text = inputDialogue.getValue()\n      await createBaseHtml(img, 4, title, text)\n      console.log('inlineText', text)\n    }\n  })\n  container.add(btn)\n\n  // 扩充方法\n  container.update = async obj => {\n    if (obj) {\n        console.log(obj);\n      if (obj.name) inputName.setValue([obj.name])\n      if (obj.avatar) {\n        await doImg(obj.avatar)\n        // inputUrl.setValue([obj.avatar]);\n      }\n      if (obj.dialogue) inputDialogue.setValue([obj.dialogue])\n    }\n  }\n  return container\n}\n\n// 结果控制\nfunction createResultBtns () {\n  let container = Lab.ui.createGroup()\n  let title = Lab.ui.createHeader(2, '输出')\n  container.add(title)\n  let copyBtn = Lab.ui.createButton(\n    '拷贝',\n    e => {\n      // console.log(htmlDiv)\n      Lab.clipboard.write(rightDiv.innerHTML, 'html')\n    },\n    false\n  )\n  container.add(copyBtn)\n  let clearBtn = Lab.ui.createButton(\n    '清空',\n    e => {\n      // console.log(htmlDiv)\n      rightDiv.innerHTML = ''\n    },\n    false\n  )\n  container.add(clearBtn)\n  return container\n}\n\nasync function doGifCrop (base64) {\n  //window.im = base64;\n  let g = new Lab.GIF()\n  let { frames, fps } = await g.parseGIF(base64)\n  for (let i = 0; i < frames.length; i++) {\n    let frame = await Lab.Image.smartCrop(frames[i], 80, 80)\n    g.add(frame, fps)\n  }\n  let url = await g.render()\n  return url\n}\n\nasync function doImageOneCrop (base64) {\n  let im = await Lab.Image.createImage(base64)\n  let canvas = await Lab.Image.smartCrop(im, 80, 80)\n  return canvas.toDataURL()\n}\n\nfunction createImageSelect (callback) {\n  let pannel = Lab.ui.createModel('选择图片')\n  // console.log(type)\n  let imgBase64\n  let pasteBtn = Lab.ui.createButton(\n    '从剪切板复制图片',\n    () => {\n      let im = Lab.clipboard.read('img')\n      if (im) {\n        imgBase64 = im.toDataURL()\n        pannel.hide()\n        if (callback) callback(imgBase64)\n      }\n    },\n    false\n  )\n  pannel.add(pasteBtn)\n\n  let pasteURLBtn = Lab.ui.createButton(\n    '从剪切板复制图片链接',\n    async () => {\n      let url = Lab.clipboard.read('text')\n      if (url) {\n        let im = await Lab.Image.getNativeImageFromWebview2(url)\n        if (im) {\n          imgBase64 = im\n          pannel.hide()\n          if (callback) callback(imgBase64)\n        }\n      }\n    },\n    false\n  )\n  pannel.add(pasteURLBtn)\n\n  let readFileBtn = Lab.ui.createButton(\n    '从本地',\n    async () => {\n      let filePaths = Lab.ui.getFilePath(1, '从本地')\n      if (filePaths && filePaths[0]) {\n        let im = await Lab.Image.getNativeImageFromWebview2(filePaths[0])\n        if (im) {\n          imgBase64 = im\n          pannel.hide()\n          if (callback) callback(imgBase64)\n        }\n      }\n    },\n    false\n  )\n  pannel.add(readFileBtn)\n  return pannel\n}\n\nfunction createOneImageLayout (type = 0) {\n  let pannel = Lab.ui.createModel('生成单图')\n  // console.log(type)\n  let pasteBtn = Lab.ui.createButton(\n    '从剪切板复制图片',\n    () => {\n      let im = Lab.clipboard.read('img')\n      if (im) {\n        im = im.toDataURL()\n        createBaseHtml(im, type)\n        pannel.hide()\n        pannel.remove()\n      }\n    },\n    false\n  )\n  pannel.add(pasteBtn)\n\n  let pasteURLBtn = Lab.ui.createButton(\n    '从剪切板复制图片链接',\n    async () => {\n      let url = Lab.clipboard.read('text')\n      if (url) {\n        let im = await Lab.Image.getNativeImageFromWebview2(url)\n        if (im) {\n          createBaseHtml(im, type)\n          pannel.hide()\n          pannel.remove()\n        }\n      }\n    },\n    false\n  )\n  pannel.add(pasteURLBtn)\n\n  let readFileBtn = Lab.ui.createButton(\n    '从本地',\n    async () => {\n      let filePaths = Lab.ui.getFilePath(1, '从本地')\n      //    console.log(filePaths)\n      if (filePaths && filePaths[0]) {\n        let im = await Lab.Image.getNativeImageFromWebview2(filePaths[0])\n        if (im) {\n          createBaseHtml(im, type)\n          pannel.hide()\n          pannel.remove()\n        }\n      }\n    },\n    false\n  )\n  pannel.add(readFileBtn)\n\n  Lab.ui.add(pannel)\n  pannel.show()\n}\n\nasync function createBaseHtml (im, type, name = '昵称', dialogue = '对白') {\n  let html\n  if (im) {\n    if (type == 0) {\n      html = await oneImageLayout(name, im, dialogue)\n    } else if (type == 1) {\n      html = oneImageLayout2(name, im, dialogue)\n    } else if (type == 2) {\n      html = oneImageLayout2(name, im, dialogue, false)\n    }else if(type===4){\n      html=inLineText(name,im,dialogue);\n    }\n  }\n  if (type == 3) {\n    dialogue = dialogue.split('\\n').filter(t => t)\n    html = talkMore(im, dialogue)\n  }\n\n  return createCardByHtml(html)\n}\n\nasync function getImgBase64 (imgurl) {\n  if (!imgurl) return imgurl\n  if (imgurl && imgurl.match('data:image')) return imgurl\n  // 获得图片的base64\n  let base64 = await db.get(imgurl)\n  if (!base64) {\n    base64 = await Lab.Image.getNativeImageFromWebview2(imgurl)\n    db.set(imgurl, base64)\n  }\n  return base64\n}\n",
  "code_length": 401,
  "size": [
    751,
    712
  ],
  "extname": "designlabplugin",
  "version": "0.11",
  "package_version": "0.1.2",
  "package_id": "0d66cc538861f304b963c2dda25d323740ca8d29",
  "dependencies": {
    "@ffmpeg-installer/ffmpeg": "^1.0.20",
    "@ffprobe-installer/ffprobe": "^1.1.0",
    "@fortawesome/fontawesome-free": "^5.15.3",
    "@hapi/hapi": "^20.1.2",
    "@kilokilo/three-bmfont-text": "^3.1.0",
    "@mediapipe/camera_utils": "^0.3.1632432234",
    "@mediapipe/drawing_utils": "^0.3.1620248257",
    "@mediapipe/holistic": "^0.5.1635989137",
    "@node-rs/jieba": "^1.3.1",
    "@paddlejs-models/humanseg": "0.0.5",
    "@pixiv/three-vrm": "^0.6.7",
    "@tensorflow-models/body-pix": "^2.1.0",
    "@tensorflow-models/deeplab": "^0.2.1",
    "@tensorflow-models/face-landmarks-detection": "0.0.1",
    "@tensorflow-models/knn-classifier": "^1.2.2",
    "@tensorflow-models/mobilenet": "^2.1.0",
    "@tensorflow-models/posenet": "^2.2.2",
    "@tensorflow/tfjs": "^3.3.0",
    "@tensorflow/tfjs-backend-wasm": "^3.3.0",
    "about-window": "^1.14.0",
    "animejs": "^3.2.1",
    "babylonjs": "^4.2.0",
    "babylonjs-gui": "^4.2.0",
    "babylonjs-loaders": "^4.2.0",
    "color": "^3.1.3",
    "copy-dir": "^1.3.0",
    "dat.gui": "^0.7.7",
    "debounce": "^1.2.1",
    "electron-json-storage": "^4.4.0",
    "electron-squirrel-startup": "^1.0.0",
    "emoji-picker-element": "^1.6.0",
    "emoji-regex": "^9.2.2",
    "espree": "^7.3.1",
    "exceljs": "^4.2.1",
    "face-api.js": "^0.22.2",
    "fluent-ffmpeg": "^2.1.2",
    "fomantic-ui": "^2.8.7",
    "gif.js": "^0.2.0",
    "gifuct-js": "^2.1.1",
    "horajs": "^0.1.3",
    "idb-kv-store": "^4.5.0",
    "internal-ip": "^6.2.0",
    "jimp": "^0.16.1",
    "kalidokit": "^1.0.5",
    "lowdb": "^1.0.0",
    "make-cert": "^1.2.0",
    "marked": "^1.2.9",
    "md5": "^2.3.0",
    "mime-types": "^2.1.34",
    "mkcert": "^1.5.0",
    "ml": "^6.0.0",
    "natural": "^5.0.3",
    "ngraph.path": "^1.3.1",
    "nouislider": "^14.7.0",
    "object-hash": "^2.1.1",
    "open-simplex-noise": "^2.5.0",
    "opencvjs-dist": "^4.4.0",
    "osc-js": "^2.1.2",
    "pdfjs-dist": "^2.6.347",
    "peer": "^0.6.1",
    "peerjs": "^1.3.2",
    "pixelit": "https://github.com/giventofly/pixelit.git",
    "qrcode": "^1.5.0",
    "recordrtc": "^5.6.2",
    "regl": "^2.1.0",
    "smartcrop": "^2.0.3",
    "socket.io": "^4.0.0",
    "socket.io-client": "^4.0.0",
    "three": "^0.134.0",
    "timeago.js": "^4.0.2",
    "unsplash-js": "^7.0.12",
    "wordcloud": "^1.2.2",
    "yoga-layout-wasm": "^1.9.3-alpha.7",
    "zdog": "^1.1.2"
  },
  "author": "shadow",
  "create_time": 1656833506170
}