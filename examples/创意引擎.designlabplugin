{
  "id": "fde0758eed72ccb7bd985944826344b566e6f1ae",
  "poster": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAABaCAYAAABzAJLvAAAIf0lEQVR4nO2d3W7byBXH//NBRaJF280qkRO4SezrpGiDYvsIxaJdoOheFO0T9KLP0Yvtzb5W00WxaXuVDQJvAW8Lq1k5kkVK5MycXlBDU7KNJBZJkdL8AMM2JQ3J+WvOnPk4h2w6nZIQAkIIMMZQF5TSAGilMogIjDFobcA5B+fp/QkhQETQWsMYA4ABoMLunyi9bsbY/O+0fAvnHEKI7P8y610KISClxGg0yi5s3TDGEATByjduBWZMQ2sNxuRC5RtjIKUE57yIy75yXqUUGGNZ47HnTpIEnPPsWOkCj0YjnJyc4O7duyCiwm/4Q7E3G4YhACAIgpUqwFaoLSP/Bb4Un2E6nUIphZ2dndVvAte1YODs7Ay+76Pb7WbvW76mMpCpCdPo9/vo9/ulnuxDiaIISZIU8g23Il4nskVrDaXUKpf8XqIogud5V8Qvu1uUeXNijIExZu0t2IoLlNc/2QomIuzs7Cx8AYrqGvJW4vHjxwtlW0tpjCnXROcr0gq7boGrcPaICEIIaJ32z0Vjy0wbDSHvZC1blTKRpZZeexiIAMaQ/S66fIBAZBaOVtmAtlbg1PdIMi+6SGfncnimwRhfqxe9HltcA5a96MlkslDR9rVVfyyDwQBhGC74FlV0R1vbgvNYL3p5GHVb8sOz/LHrhmpls7UC5ys770UXWX6+td6/f3/h9cq86NJKrjm2gu1sU5ECL09P2uGYxXnRFWGnK68zqatjTTKueNH5eeiy2VqBrZdbthcNEKT0spZqjIFSqrKh0tYKnPei4ziG1hqdTmdhKnEV7OftZMq7d+8gpcTu7m5mnqvog7d2mJQnjmNEUXTFw131J1/O6ekphsNhdsz1wSWz7EX7vl+aF+15Hp49ewrg8pjzoktm2YsGMF/8L6bsy8WM65w350VXQiqwngtQbGUbQ+CcgShdbMiLLkR11b61AttlSSFE5tEW5UlbMe3Sa34umoiglIIQzosuFSuCNdNKqcyLLnI92DIajeB5HjqdDtJVLNcHV8ZsNkMcx2i324W04sWJk1TMwWCAIAiyc7g+uGRu8qKLqvB8WZxzHB8fLxx3Lbhklnc+EpXlRefHxXZ+2rXgSpBSFuZYfQxusaECrImsYv/XTeevQuStFbiKPcnvwy34l8y6Wm+VuMWGDccJvOFstYluOlf6cGOApY0ErgU3FCICw9yPsJsXbAiw/R9O4MbCGAPZYRbnUBdjjF9+AzUagc23IBFjTuCmQkSgefzT6Ju/4+UXv8Y///BbvPziV3j3txfpe7R2AjeZdJhH+PdXf4EaDnHv898gefsW3331JTCf43YCNxQiAjgHGUL8vwFaBw/Q/clP4fV6SN6+BWkFxrkTuKkwxkBagQuB3mef4+Jf/8DJl39G+Ppb9H75GXjrDoxWbpjUVBhjABcgY/DjP/4JrU96GH39VwQ/+zn6v/s9iAwY52BEROfn5wjDEA8fPqxFhP94PAZQTI4OuwHdGJNl17G/mzxVmS1WIF2EvOl114IbSrYShXkEVH4tOxd7LJc3aC8HSlVJ/lqa3LqqIr/cSDmrmz8uM6WlBGOs0sCo6y4YSDeKl531ZlPIh6hed1zahe/BYJC13nW3njAM0ev1VrYm5UQNNgtpjMHe3t5aTfMy7XY7y3RXRBBYPkx027oBGcfxQtRbXVBap6lvViDvRXO+mAilTvdaJpJzDq1NKbmiVqEoAYxJRfa8dMCwTh9jHTCqi112lEKh4+CmfFeq2rJaB2Q+fdDl3uwPFGq+qAwgC+JqSsU14RqLQH7/n/8uRMHZYdPlvl2Ac5aFWOQrxuaXMoawt7eLT+7+aI234rgOaYWbzWZpigEiTCYTcCEQz2YQUiKKIuz4PhjnuLi4AGMAYxz7+/s4PDyE1kkW9tGUFrwtSCA1r2EY4s2bN2i32wAArRSU1hicnWE4/AF7e3vQ2mA8HqPVaiGOYxwdH+Ho6AhxHN84o+JYL5KIkCQJgiDA8+fP0wXkJIbneWi1WhiPRjC58WSr1YL9jOd5mE6n88Ct7ZpAaAqy0+lk/SufLz/xuZdpiNDtdsGydLtpSoLLHBMGWml4ktC+0wLgWnDdeP84mGjh2SdWPyu4o94wY21rkYU64WuDLGLQf11OCkc9kEWIs7Dw7ESuFRJIUxckSXKrAogInucVntDTUQwSuJrP+GNRSsHzPNf31pBMYOB2ztG2ra82DQ4UI44zz/WEA8WI41pwPXGhKxuOM9EbjmvBG47rgzcc14I3HNcHbzjORG84zkRvOAsmuohAL0e9WDDRq5hZZ6LrSbarUmt961boxK0vzBhDdqH+Nint7Wb4bQoHaRKFBZ9V+SQRx4dTyqY7YLsCvOqMCx/dcOQPw2G68d3GCWYb4OehhkQLuZj0vJ9mALjIBanNDYEhg6AboN2+41pwDZDn5yPYZ83b8JQkSdJNdAAE59kDnADA930AaWRhFEWQUmZP0gZj0ErBk54TuCZIzhk4F5jNZvju5ASJSjCZTECUZrvxOx2Mx2M8efIEk3AC39+B1hpCCHx/eoq9/X28fv0tPv30Fzg+PkaUe5KXE3f9ZJvupJRodzpoowPf3wHnHJ7n4eJijG7QxYOHDxFFEYbDISYXF5hOpzh48ACe5+Hp02cIgqD0x7Q5Ph5pg8wYgEePHuVyZfF50FkqfpIk6HQ66Pf7ICLY7Dw2B6QxBnGcZOmKABdpWAdYGEZkyFzmPASu/p0Tyj6Dj/HUsbKRh2CXn7vTamWPjXMCrxc3TNpwZFn63tRy3YxXtTBKqeZkTtDKkTa/hpn3pzdRVHgp59z1zxUi0zR/XiUnM8ZkaYKdwNWQjYNfvHiBVquFyWQC3/exu7uLOI4xmUxwcHCAw8PDW4mitcarV69w79499Hq97LgTtxr+D5QhseIlWjE0AAAAAElFTkSuQmCC",
  "title": "创意引擎",
  "knowledge": {
    "course": "- 变量\n- 优化ui\n- 基于svg模版的生成\n- 固定数量随机生成\n- 计算稀有度&合成大图",
    "readme": "创意引擎",
    "author": "shadow",
    "version": "0.6.0"
  },
  "code": "var mainDiv, myCanvas, toolbox,downloadPannel;\n\n// 保存坑位\nvar cardElements = {};\n\nvar _CANVAS_WIDTH = Math.min(window.innerWidth * 0.3, 300),\n    _CANVAS_HEIGHT = 300;\n\n\n// svg模版\nvar svgs = [];\n\nfunction gui() {\n\n    window.toast=Lab.base.debounce(()=>{\n        if(window.result&&window.result.length) Lab.ui.toast(window.result.length);\n    },1000);\n\n    // 加载svg库\n    Lab.base.loadFromUrl('js', 'https://cdn.bootcdn.net/ajax/libs/svg.js/3.1.1/svg.min.js');\n\n    mainDiv = Lab.ui.createGroup('container');\n    Lab.ui.add(mainDiv);\n    mainDiv.style = 'width: 100%;';\n\n    mainDiv.innerHTML = `\n    <div class=\"ui two column divided grid\">\n        <div class=\"stretched row\">\n            <div class=\"column\">\n                <div class=\"ui segment\" id='myCanvas'></div>\n            </div>\n            <div class=\"column\" id=\"toolbox\"></div>\n        </div>\n    </div>\n    <div class=\"ui column divided grid\">\n        <div class=\"stretched row\">\n            <div class=\"column\" id='cards'></div>\n        </div>\n    </div>\n    `;\n\n    // \n    downloadPannel=createDownloadPannel();\n    mainDiv.add(downloadPannel);\n\n\n    myCanvas = new Lab.Canvas(_CANVAS_WIDTH, _CANVAS_HEIGHT);\n    myCanvas.onModified = doModified;\n    myCanvas.onClick = doClick;\n    myCanvas.onRemoved = doRemoved;\n    mainDiv.querySelector('#myCanvas').appendChild(myCanvas.getElement())\n\n\n    let cardsDiv = Lab.ui.createGroup('cards');\n    mainDiv.querySelector('#cards').appendChild(cardsDiv);\n\n    toolbox = createToolbox();\n    mainDiv.querySelector('#toolbox').appendChild(toolbox);\n\n\n    let addBtn = Lab.ui.createIcon('plus', () => {\n        Lab.ui.loading(0);\n        let { card, rect } = createCard(cardsDiv);\n        cardElements[card.id] = {\n            element: card,\n            rect: rect,\n            imgUrls: []\n        };\n        setTimeout(() => Lab.ui.loading(100), 200);\n    });\n    addBtn.classList.add('red');\n    addBtn.style = `\n    position:fixed;\n    right:12px;\n    top:240px;\n    `;\n\n\n\n    myCanvas.addRect({\n            left: 0,\n            top: 0,\n            width: _CANVAS_WIDTH,\n            height: _CANVAS_HEIGHT,\n            stroke: 'black',\n            fill: 'white'\n        },\n        false, true, true)\n    myCanvas.zoomToFitCanvas();\n\n    \n    // 设定基础模版\n    let preivewImageForBase=Lab.ui.createImageAndPreview();\n    let setBaseBtn = Lab.ui.createButton('0 打开基础模版', () => {\n        Lab.ui.loading(0);\n        let data = Lab.ui.openStringDialog(1);\n        if (data) {\n            window.base=data.data; \n            drawBase(preivewImageForBase);\n        }\n        setTimeout(() => Lab.ui.loading(100), 100);\n    });\n    // console.log(preivewImageForBase)\n    Lab.ui.add(setBaseBtn);\n    Lab.ui.add(Lab.ui.createDivider());\n    Lab.ui.add(preivewImageForBase);\n    Lab.ui.add(Lab.ui.createDivider());\n\n    // 打开多个svg文件\n    let openBtn = Lab.ui.createButton('1 打开多个svg文件', () => {\n        Lab.ui.loading(0);\n        svgs=[];\n        let datas = Lab.ui.openStringDialog(3);\n        console.log(datas);\n        // 统计变量数量\n        let maskKeys = {};\n        for (const data of datas) {\n            let draw = SVG().addTo('body');\n            draw.__filepath = data.filepath;\n            draw.svg(data.data);\n            let parent = draw.children()[0];\n            let styles = parent.attr();\n            draw.width(styles.width);\n            draw.height(styles.height);\n            draw.viewbox(styles.viewBox);\n            draw.node.style.outline='1px solid gray';\n            draw.node.style.margin='2px';\n            \n            svgs.push(draw);\n            // 预先提取变量\n            let ks=getAllMaskKeys(draw);\n            Array.from(ks, k => {\n                if(maskKeys[k]===undefined)maskKeys[k]=0;\n                maskKeys[k]++;\n                // if (!maskKeys.includes(k)) maskKeys.push(k);\n            });\n        };\n        console.log(maskKeys)\n        // 变量设定- 数量显示\n        paramsInput.setValue(JSON.stringify(maskKeys,null,2));\n        setTimeout(() => Lab.ui.loading(100), 200);\n    });\n    Lab.ui.add(openBtn);\n    Lab.ui.add(Lab.ui.createDivider());\n\n\n    // 设定哪些变量要提取\n    let paramsInput = Lab.ui.createTextareaInput('变量设定', e => {\n        // console.log(e);\n    });\n\n    Lab.ui.add(paramsInput);\n    Lab.ui.add(Lab.ui.createDivider());\n\n    // 预处理数据\n    let preDataBtn = Lab.ui.createButton('2 预处理', () => {\n        Lab.ui.loading(0);\n        preDataBtn.classList.remove('green');\n        let text = paramsInput.getValue();\n        if (text) {\n            let json=JSON.parse(text);\n            let keys=Object.keys(json);\n            // let keys = text.split('\\n').filter(f => f);\n            if (keys) {\n                window.keysList = {};\n                for (const key of keys) {\n                    window.keysList[key] = [];\n                };\n                Array.from(svgs, s => initEngine(s, keys));\n                 // 成功遍历完成\n                console.log(window.keysList)\n                window.toast();\n            };\n        };\n        // console.log(paramsInput.getValue())\n        preDataBtn.classList.add('green');\n        setTimeout(() => Lab.ui.loading(100), 200);\n    });\n    Lab.ui.add(preDataBtn);\n    Lab.ui.add(Lab.ui.createDivider());\n\n    // 选择算法\n    // let dkBtn=Lab.ui.createButton('3 笛卡尔全量生成',()=>{\n    //     window.result = createAll();\n    //     window.toast();\n    // });\n    // Lab.ui.add(dkBtn);\n    // Lab.ui.add(Lab.ui.createDivider());\n\n    let fixedBtn=Lab.ui.createButton('3 固定数量随机生成100',()=>{\n        Lab.ui.loading(0);\n        // window.result = createAllRandom(100);\n        window.toast();\n        create100();\n        setTimeout(() => Lab.ui.loading(100), 200);\n    });\n    \n    Lab.ui.add(Lab.ui.createBaseText('生成100个'));\n    Lab.ui.add(fixedBtn);\n    Lab.ui.add(Lab.ui.createDivider());\n    \n    function create100(){\n        window.result = createAllRandom(100);\n        if (window.result) {\n            window.resultIndex=0;\n            window.svgsResult=[];\n            for (const features of window.result) {\n                let svg=drawSvg(false,window.base,features);\n                window.svgsResult.push(svg);\n            };\n        };\n    }\n\n    // 下一个\n    let nextBtn = Lab.ui.createButton('下一个', async () => {\n        myCanvas.reset();\n        if(window.resultIndex>=window.svgsResult.length) window.resultIndex=0;\n        window.currentSvg=window.svgsResult.slice(window.resultIndex,window.resultIndex+1)[0];\n        let url=Lab.base.str2URL(window.currentSvg,\"image/svg+xml;charset=utf-8\");\n        let target=await myCanvas.addSVGFromURL(url);\n        target.name='svg';\n        window.targetUrl=url;\n        window.resultIndex++;\n        // 添加到画布上\n        let cardsDiv = Lab.ui.createGroup('cards');\n        mainDiv.querySelector('#cards').appendChild(cardsDiv);\n        let { card, rect } = createCard(cardsDiv);\n        cardElements[card.id] = {\n            element: card,\n            rect: rect,\n            imgs: [\n                {\n                    element:target,\n                    url:url,\n                    type:'svg'\n                }\n            ]\n        };\n        card.setValue([url]);\n        // 缩放表情包\n        updateCanvasImgs(card.id);\n        \n    });\n    Lab.ui.add(Lab.ui.createBaseText('预览'));\n    Lab.ui.add(nextBtn);\n    Lab.ui.add(Lab.ui.createDivider());\n\n    // 设置人类可读的编号前缀 APL+0983\n    let setCodeBtn = Lab.ui.createInput('text','编号前缀',  texts=> {\n       if(texts&&texts.length){\n           let t=texts[0];\n           t=t.trim();\n           window.__code=t;\n       }\n   });\n\n\n    let setDownloadFilePathBtn = Lab.ui.createButton('设置本地目录', async() => {\n         // 导出本地文件\n         let filepaths=Lab.ui.getFilePath(2);\n         if (filepaths && filepaths[0]) {\n            window.__download_filepath=filepaths[0];\n         }\n    });\n\n    async function download100(){\n        if (window.__download_filepath) {\n            // id map\n            let idsMap={};\n            let i=1;\n            let fileNames=Lab.base.readdirSync( window.__download_filepath);\n            for (const fileName of fileNames) {\n                let children=Lab.base.readdirSync(fileName);\n                let id=Lab.base.getBaseName(children[0]).replace(/\\..*/ig,'');\n                idsMap[id]=1;\n                i++;\n            };\n            \n            for (const svg of window.svgsResult) {\n                let s = SVG();\n                s.svg(svg);\n                let id=s.children()[0].attr('data-id');\n                if(!idsMap[id]){\n                    let base64=await Lab.Image.svg2base64(svg,'png');\n                    // 文件夹\n                    let dirname0=window.__download_filepath + '/' + (window.__code||\"A\") + i;\n                    Lab.base.mkdir(dirname0);\n                    Lab.base.saveData(dirname0 + '/' + id + '.svg', svg);\n                    Lab.base.saveBase64(base64,dirname0 + '/' + id + '.png');\n                    i++;\n                }\n             }\n        } \n    }\n    // console.log(setCodeBtn)\n    let downAllBtn=Lab.ui.createButton('下载到本地',async()=>{\n        window.__code=setCodeBtn.getValue();\n        await download100();\n    });\n    Lab.ui.add(Lab.ui.createBaseText('下载'));\n    Lab.ui.add(setCodeBtn);\n    Lab.ui.add(setDownloadFilePathBtn);\n    Lab.ui.add(downAllBtn);\n\n    let down10000Btn=Lab.ui.createButton('1w下载到本地',async()=>{\n       \n        for (let index = 0; index <100; index++) {\n            create100();\n            await download100();\n            Lab.ui.toast(index);\n            await Lab.base.sleep(1500);\n        }\n        \n    });\n    Lab.ui.add(down10000Btn);\n\n    // 合成全景图\n    let allPicsBtn=Lab.ui.createButton('合成大图',async()=>{\n        // id map\n        let idsMap={};\n        let i=1;\n \n        let filepaths=Lab.ui.getFilePath(0);\n        let num=20;\n        let w=2*2048/num;\n        let h;\n        let imgs=[];\n\n        // 统计\n        let counts={};\n\n        for (const fileName of filepaths) {\n            let children=Lab.base.readdirSync(fileName);\n            let id=Lab.base.getBaseName(children[0]).replace(/\\..*/ig,'');\n            idsMap[id]=1;\n            \n            let column=Math.ceil(i/num);\n            if(!imgs[column]) imgs[column]=[];\n            for (const child of children) {\n                if(Lab.base.getExtName(child).match('png')){ \n                    // 用于合成png大图\n                   let im= await Lab.Image.createImage(child);\n                    h=w/(im.naturalWidth/im.naturalHeight);\n                   let c= Lab.Image.createCanvasFromImage(im,w,h);\n                   let ctx=c.getContext('2d');\n                   ctx.fillStyle='black';\n                   ctx.fillRect(0,h-44,w,44);\n                   ctx.font=\"20px Georgia\";\n                   ctx.textBaseline=\"bottom\";\n                   ctx.textAlign=\"right\";\n                   ctx.fillStyle='white';\n                   ctx.fillText(Lab.base.getBaseName(fileName),w-8,h-8);\n                   imgs[column].push(c);\n                }else if(Lab.base.getExtName(child).match('svg')&&window.keysList){\n                    // 用于计算各个元素出现的概率\n                    \n                    // console.log(window.keysList) 需要预处理调用成功\n                    // console.log(child)\n                    let svgStr=Lab.base.readFileSync(child);\n                    let draw = SVG();\n                    draw.svg(svgStr);\n                    for(var k in window.keysList){\n                    //     console.log(k);\n                        let r=draw.findOne('#'+k);\n                        if(r){\n                            let id=r.attr('data-id');\n                            let obj=window.keysList[k].filter(v=>v.id===id)[0];\n                            // console.log(k,id);\n                            if(obj){\n                                if(!counts[k]) counts[k]={};\n                                \n                                if(!counts[k][obj.basename]) {\n                                    let base64=await Lab.Image.svg2base64(obj.draw.svg(),'png');\n                                    counts[k][obj.basename]={\n                                        base64,\n                                        count:0\n                                    }\n                                };\n                                counts[k][obj.basename].count++;\n                            }\n                        }\n                        \n                    }\n\n                };\n                // console.log(counts);\n                // window.counts=counts;\n            };\n            i++;\n        };\n       \n        imgs=imgs.filter(i=>i);\n        let canvas= Lab.Image.createCanvas(w*num,h*imgs.length);\n        let ctx=canvas.getContext('2d');\n        // console.log(imgs)\n        for (let index = 0; index < imgs.length; index++) {\n            const ims = imgs[index];\n            for (let j = 0; j < ims.length; j++) {\n                const e = ims[j];\n                // console.log(index*w, j*h)\n                ctx.drawImage(e,j*w, index*h, w, h);\n            }\n        }\n        Lab.ui.saveBase64Dialog(canvas.toDataURL(),'保存','大图');\n        // Lab.clipboard.write(canvas.toDataURL(),'base64')\n\n        // window.counts=counts;\n        // 统计元素稀有度\n        let ks=[];\n        let maxWidth=0,maxHeight=0,size=200;\n\n        for(var k in window.keysList){\n            ks.push({\n                value:window.keysList[k].length,\n                key:k\n            }); \n        };\n        ks=ks.sort((a,b)=>b.value-a.value);\n        ks=Array.from(ks,k=>k.key);\n        for (let index = 0; index < ks.length; index++) {\n            const k = ks[index];\n            // counts[k]\n            let elements=[];\n            for(let basename in counts[k]){\n                let im=await Lab.Image.createImage(counts[k][basename].base64);\n                let canvas=Lab.Image.createCanvasFromImage(im);\n                // 绘制数量到图上\n                let ctx=canvas.getContext('2d');\n                   ctx.fillStyle='black';\n                   ctx.fillRect(0,canvas.height-56,canvas.width,56);\n                   ctx.font=\"38px Georgia\";\n                   ctx.textBaseline=\"bottom\";\n                   ctx.textAlign=\"right\";\n                   ctx.fillStyle='white';\n                   \n                   ctx.fillText(\n                       basename.replace(/\\..*/ig,'')+\"_\"+(100*counts[k][basename].count/filepaths.length).toFixed(2)+'%',\n                       canvas.width-8,\n                       canvas.height-8);\n\n                elements.push({\n                    basename,\n                    value:counts[k][basename].count,\n                    canvas\n                });\n            };\n            elements=elements.sort((a,b)=>b.value-a.value);\n            maxWidth=Math.max(elements.length*size+40,maxWidth);\n            ks[index]={\n                key:k,\n                elements\n            }\n            if(elements.length==0) ks[index]=null;\n        };\n        ks=ks.filter(k=>k);\n        maxHeight=ks.length*(size+20);\n        // console.log(ks,maxWidth,maxHeight)\n\n        // 绘制大图 \n        let canvasElements=Lab.Image.createCanvas(maxWidth,maxHeight),ctxElements=canvasElements.getContext('2d');\n\n        for(let k of ks){\n            let y=size*1.2*ks.indexOf(k);\n            if(y+size>canvasElements.height) canvasElements.height=y+40+size;\n        };\n\n        ctxElements.strokeStyle='black';\n        ctxElements.lineWidth = 2;\n        ctxElements.font=\"14px Georgia\";\n        ctxElements.textBaseline=\"top\";\n        ctxElements.textAlign=\"left\";\n        ctxElements.fillStyle='black';\n\n        for(let k of ks){\n            let y=size*1.2*ks.indexOf(k);\n            ctxElements.fillText(k.key,10,10+y);\n            for(let e of k.elements){\n                let x=k.elements.indexOf(e)*size,xs=(1+k.elements.indexOf(e))*10;\n                ctxElements.drawImage(e.canvas,0,0,e.canvas.width,e.canvas.height,x+xs,y+30,size,size);\n                ctxElements.strokeRect(x+xs,y+30,size,size);\n            }\n        };\n\n        Lab.ui.saveBase64Dialog(canvasElements.toDataURL(),'保存','稀有度');\n        // let url=canvasElements.toDataURL();\n        // Lab.ui.add(Lab.ui.createImageAndDownload(url));\n        \n    });\n    Lab.ui.add(allPicsBtn);\n};\n\n// 调整内容\nfunction updateCanvasImgs(id){\n    let {rect,imgs}=cardElements[id];\n        for (const img of imgs) {\n            if(img.type==='svg'){\n                img.element.left=rect.left;\n                img.element.top=rect.top;\n                img.element.scaleToHeight(rect.getScaledHeight());\n                img.element.scaleToWidth(rect.getScaledWidth());\n                myCanvas.render();\n            }\n        };\n};\n\nfunction drawBase(preImg){\n    var draw = SVG();\n    draw.svg(window.base);\n    var parent = draw.children()[0];\n    var styles = parent.attr();\n    draw.width('120px');\n    draw.height('120px');\n    draw.viewbox(styles.viewBox);\n    let gs=Array.from(draw.find('g'),g=>g);\n    gs[0].attr('stroke','red');\n    preImg.setValue([Lab.base.str2URL(draw.svg(),'image/svg+xml;charset=utf-8')])\n}\n\nfunction drawSvg(addTo,baseData,features){\n    let draw = SVG();\n    if(addTo) draw.addTo(addTo);\n    // const clickAddImg = function() {\n    //     console.log(this)\n    //     myCanvas.addImg(this.node)\n    // }\n    // draw.on('click', clickAddImg);\n    \n    draw.svg(baseData);\n    let parent = draw.children()[0];\n    let styles = parent.attr();\n    draw.width(styles.width);\n    draw.height(styles.height);\n    draw.viewbox(styles.viewBox);\n    // window.draw=draw;\n    // 更改组件\n    let id=\"\";\n    for (const r of features) {\n        // 组件svg\n        let element = window.keysList[r.key][r.index];\n        draw.findOne('#' + r.key).svg(element.svg, true);\n        // 拼id\n        id=id+'_'+element.id;\n        // TODO 調整圖層順序\n        console.log(element.zIndex)\n    };\n    id=Lab.base.md5(id);\n    draw.attr('data-id',id);\n    return draw.svg();\n}\n\n\nfunction createDownloadPannel(){\n    let m=Lab.ui.createModel('下载');\n    \n    let runBtn=Lab.ui.createButton('下载svg图',()=>{\n        // console.log(size)\n        if(window.downloadURL){\n            let s = SVG();\n            s.svg(window.currentSvg);\n            let id=s.children()[0].attr('data-id');\n            Lab.ui.createDownlad(window.downloadURL,id);\n            downloadPannel.hide();\n        }\n    });\n    m.add(runBtn);\n    let downloadPngBtn=Lab.ui.createButton('下载png图片',()=>{\n        // console.log(size)\n        let s = SVG();\n        s.svg(window.currentSvg);\n        let id=s.children()[0].attr('data-id');\n        // TODO bug\n        for (const obj of myCanvas.getObjects()) {\n            if(obj.name==='svg')  Lab.ui.createDownlad(obj.toDataURL(),id);\n        };\n        downloadPannel.hide();\n    });\n    m.add(downloadPngBtn);\n    let copyPngBtn=Lab.ui.createButton('拷贝png图片',()=>{\n        // console.log(size)\n        for (const obj of myCanvas.getObjects()) {\n            if(obj.name==='svg')  Lab.clipboard.write(obj.toDataURL(),'base64');\n        };\n        downloadPannel.hide();\n    });\n    m.add(copyPngBtn);\n    return m\n}\n\n// 图片集\nfunction createCard(row) {\n    let id = (new Date()).getTime() + '' + parseInt(Math.random() * 1000);\n\n    let card = Lab.ui.createGroup('card');\n    card.style.width = 'min-content';\n    card.style.margin='12px';\n    card.addEventListener('click', e => {\n        setActiveObject(id);\n        toolbox.update();\n    });\n    card.id = id;\n    row.add(card);\n\n    let text = `图片集 ${1 + Object.keys(cardElements).length}`;\n    let t = Lab.ui.createBaseText(text);\n    card.add(t);\n    t.style.margin = '1em';\n\n    // img\n    let imgBtn = Lab.ui.createInput('imgs', text, (imgs) => {\n        Lab.ui.loading(0);\n        console.log(id, imgs)\n        if (cardElements[id]) cardElements[id].imgUrls = imgs;\n        setTimeout(() => Lab.ui.loading(100), 3000);\n    }, true, false);\n    card.add(imgBtn);\n\n    // btns 功能区\n    let btnsDiv = Lab.ui.createGroup('column');\n    btnsDiv.style.display = 'flex';\n    let downloadBtn = Lab.ui.createIcon('download', () => {\n        //  console.log(imgBtn.getValue())\n        window.downloadURL=imgBtn.getValue();\n        if(downloadPannel) downloadPannel.show();\n    });\n    btnsDiv.add(downloadBtn);\n\n    card.add(btnsDiv);\n\n   \n    // 占位框\n    let rect = myCanvas.addRect({\n        left: parseInt(_CANVAS_WIDTH / 2) - 100,\n        top: parseInt(_CANVAS_HEIGHT / 2) - 100,\n        width: 100,\n        height: 100,\n        // stroke: 'red',\n        strokeWidth: 0,\n        fill: 'rgba(255,0,0,0.1)'\n    }, true, true, true)\n    // myCanvas.zoomToFitCanvas()\n    rect.name = 'artboard';\n    rect.id = id;\n\n\n    // 选项框\n    let ins = Lab.ui.createInput('select', '', e => {\n        console.log(e,rect,imgBtn);\n        if(e==='img'){\n            window.rect=rect;\n            window.imgBtn=imgBtn;\n        }\n    }, true, false);\n    ins.appendOptions([{\n        value: 'img',\n        text: '图片'\n    }, {\n        value: 'emoji',\n        text: '表情'\n    }, {\n        value: 'color',\n        text: '色块'\n    }]);\n    card.add(ins);\n    ins.init();\n    ins.style.marginLeft = '12px';\n    card.setValue=imgBtn.setValue;\n    return { card, rect }\n}\n\nfunction createToolbox() {\n    let inPos = Lab.ui.createInputForPosition((pos) => {\n        // console.log(pos)\n        let [x, y, w, h] = pos;\n\n        let rect = myCanvas.getActiveObject();\n        rect.scaleToWidth(w);\n        rect.scaleToHeight(h);\n\n        rect.left = x;\n        rect.top = y;\n        // console.log(z);\n\n        rect.width = w / rect.scaleX;\n        rect.height = h / rect.scaleX;\n\n        myCanvas.render();\n    });\n    inPos.update = () => {\n        let rect = myCanvas.getActiveObject();\n        inPos.setValue([rect.left, rect.top, rect.getScaledWidth(), rect.getScaledHeight()]);\n        updateCanvasImgs(rect.id);\n    }\n    return inPos;\n}\n\n\nfunction doModified(e, data) {\n    // console.log(e, data)\n    // e.target.id;\n    if (e.target.id && cardElements[e.target.id]) {\n        toolbox.update();\n    }\n\n}\n\nfunction doClick(e) {\n    // console.log(e.target.id)\n    if (e.target&&e.target.id && cardElements[e.target.id]) {\n        let card = cardElements[e.target.id];\n        // console.log(card, e.target.id)\n        card.element.classList.add('red');\n        // 更新rect信息到toolbox\n        toolbox.update();\n    } else {\n        for (const id in cardElements) {\n            cardElements[id].element.classList.remove('red');\n        };\n    }\n}\n\nfunction doRemoved(e) {\n    if (e.target.id && cardElements[e.target.id]) {\n        cardElements[e.target.id].element.remove();\n        delete cardElements[e.target.id];\n    };\n}\n\n// 激活\nfunction setActiveObject(id) {\n    for (const id in cardElements) {\n        cardElements[id].element.classList.remove('red');\n    };\n    if (cardElements[id]) {\n        let c = cardElements[id];\n        myCanvas.setActiveObject(c.rect);\n        c.element.classList.add('red');\n    };\n}\n\nfunction travel(children = []) {\n    // let isDone = true;\n    let list=[];\n    for (let c of children) {\n        // console.log(c.node.id);\n        // if (doFun) doFun(c)\n        // if (c.children().length > 0) {\n        //     isDone = false;\n        //     travel(c.children(), doFun, successFun);\n        // };  \n        list.push(c);\n        if(c.children().length>0){\n            list=[...list,...travel(c.children())];\n        };\n    };\n    return list;\n    // bug\n    // console.log(isDone)\n    // if (successFun && isDone) {\n    //     successFun();\n    // }\n};\n\n// step 1 打开所有的模版\n// step 2 设定变量，预处理，提取变量对应的svg\n// step 3 导出数据\n\n\n// 得到变量，用-M标记的变量\nfunction getAllMaskKeys(draw) {\n    let maskKeys = [];\n    let children=travel(draw.children());\n    // console.log(children)\n    // 遍历过程中的数据处理\n    for (const child of children) {\n        if (child.node.id && child.node.id.trim() && child.node.id.match('-M') && !maskKeys.includes(child.node.id)) {\n            maskKeys.push(child.node.id);\n        };\n    }\n    // 成功遍历完成\n    return maskKeys\n}\n\n// 初始化\n// keyList=['face','eyes','mouse','ears']\n// window.face=[];\n// window.eyes=[];\n// window.mouse=[];\n// window.ears=[];\nfunction initEngine(draw, keys = []) {\n    // 文件名\n    let basename = Lab.base.getBaseName(draw.__filepath);\n    let children=travel(draw.children());\n    for (const child of children) {\n         // 遍历过程中的数据处理\n        \n         if (keys.includes(child.node.id) && window.keysList[child.node.id]) {\n            let id = Lab.base.md5(basename);\n             //  寫上id\n             child.attr('data-id',id);\n             child.attr('data-basename',basename);\n            let svg = child.svg();\n            let isNew = true;\n            for (const n of window.keysList[child.node.id]) {\n                if (n.id === id) isNew = false;\n            };\n            if (isNew) {\n                \n                window.keysList[child.node.id].push({\n                    id,\n                    svg,\n                    basename,\n                    draw,\n                    zIndex:keys.indexOf(child.node.id)\n                });\n                let index=window.keysList[child.node.id].length-1;\n                draw.node.addEventListener('click',e=>{\n                    window.keysList[child.node.id][index].draw.node.style.opacity+=0.05;\n                    window.keysList[child.node.id][index].zIndex++;\n                    if(window.keysList[child.node.id][index].draw.node.style.opacity>1) window.keysList[child.node.id][index].zIndex=0;\n                    console.log(window.keysList[child.node.id][index])\n                    \n                })\n            }\n        }\n    };\n    \n};\n\n\n// 笛卡尔生成全集\nfunction createAll() {\n    let data = [];\n    for (const key in window.keysList) {\n        data.push(Array.from(window.keysList[key], (d, i) => {\n            return {\n                key: key,\n                index: i\n            }\n        }));\n    };\n    let ds=Lab.base.cartesian(data);\n    // ds=Lab.base.chunk(ds,6);\n    return ds\n}\n\n// 笛卡尔积太大，改用随机生成，重复一定的数量\nfunction createAllRandom(count=100){\n    let data = [];\n    for (const key in window.keysList) {\n        data.push(Array.from(window.keysList[key], (d, i) => {\n            return {\n                key: key,\n                index: i\n            }\n        }));\n    };\n    let ds=[];\n    let dsMap={};\n    for (let index = 0; index < count*2; index++) {\n        let style=[];\n        for (const d of data) {\n            let s=Lab.base.shuffle([...d])[0];\n            style.push(s);\n        };\n        let id=Lab.base.hash(style);\n        if(!dsMap[id]){\n            ds.push(style);\n            dsMap[id]=1;\n        };\n    };\n    ds=Lab.base.shuffle([...ds]).slice(0,count);\n    return ds\n}",
  "code_length": 204,
  "size": [
    883,
    681
  ],
  "extname": "designlabplugin",
  "version": "0.6.0",
  "package_version": "0.1.2",
  "package_id": "df22ad54c8e3dee49e71dd4ce9538ee33b2a7d1e",
  "dependencies": {
    "@ffmpeg-installer/ffmpeg": "^1.0.20",
    "@ffprobe-installer/ffprobe": "^1.1.0",
    "@fortawesome/fontawesome-free": "^5.15.3",
    "@hapi/hapi": "^20.1.2",
    "@kilokilo/three-bmfont-text": "^3.1.0",
    "@mediapipe/camera_utils": "^0.3.1632432234",
    "@mediapipe/drawing_utils": "^0.3.1620248257",
    "@mediapipe/holistic": "^0.5.1635989137",
    "@node-rs/jieba": "^1.3.1",
    "@paddlejs-models/humanseg": "0.0.5",
    "@pixiv/three-vrm": "^0.6.7",
    "@tensorflow-models/body-pix": "^2.1.0",
    "@tensorflow-models/deeplab": "^0.2.1",
    "@tensorflow-models/face-landmarks-detection": "0.0.1",
    "@tensorflow-models/knn-classifier": "^1.2.2",
    "@tensorflow-models/mobilenet": "^2.1.0",
    "@tensorflow-models/posenet": "^2.2.2",
    "@tensorflow/tfjs": "^3.3.0",
    "@tensorflow/tfjs-backend-wasm": "^3.3.0",
    "about-window": "^1.14.0",
    "animejs": "^3.2.1",
    "color": "^3.1.3",
    "dat.gui": "^0.7.7",
    "debounce": "^1.2.1",
    "electron-json-storage": "^4.4.0",
    "electron-squirrel-startup": "^1.0.0",
    "emoji-picker-element": "^1.6.0",
    "emoji-regex": "^9.2.2",
    "espree": "^7.3.1",
    "exceljs": "^4.2.1",
    "face-api.js": "^0.22.2",
    "fluent-ffmpeg": "^2.1.2",
    "fomantic-ui": "^2.8.7",
    "gif.js": "^0.2.0",
    "gifuct-js": "^2.1.1",
    "horajs": "^0.1.3",
    "idb-kv-store": "^4.5.0",
    "internal-ip": "^6.2.0",
    "jimp": "^0.16.1",
    "kalidokit": "^1.0.5",
    "lowdb": "^1.0.0",
    "make-cert": "^1.2.0",
    "marked": "^1.2.9",
    "md5": "^2.3.0",
    "mime-types": "^2.1.30",
    "mkcert": "^1.4.0",
    "ml": "^6.0.0",
    "natural": "^5.0.3",
    "ngraph.path": "^1.3.1",
    "nouislider": "^14.7.0",
    "object-hash": "^2.1.1",
    "opencvjs-dist": "^4.4.0",
    "osc-js": "^2.1.2",
    "pdfjs-dist": "^2.6.347",
    "peer": "^0.6.1",
    "peerjs": "^1.3.2",
    "pixelit": "https://github.com/giventofly/pixelit.git",
    "recordrtc": "^5.6.2",
    "regl": "^2.1.0",
    "smartcrop": "^2.0.3",
    "socket.io": "^4.0.0",
    "socket.io-client": "^4.0.0",
    "three": "^0.134.0",
    "timeago.js": "^4.0.2",
    "unsplash-js": "^7.0.12",
    "wordcloud": "^1.2.2",
    "yoga-layout-wasm": "^1.9.3-alpha.7",
    "zdog": "^1.1.2"
  },
  "author": "shadow",
  "create_time": 1638869311054
}