{
  "id": "bb579ae26bddddbb3e98b3eca36d10ae833d36e4",
  "poster": "data:image/png;base64,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",
  "title": "创意引擎",
  "knowledge": {
    "course": "- 变量\n- 优化ui\n- 基于svg模版的生成\n- 自动从图片提取配色方案\n- 布局-素材自由绑定\n- 固定数量随机生成\n- 计算稀有度&合成大图",
    "readme": "创意引擎",
    "author": "shadow",
    "version": "0.11"
  },
  "code": "var mainDiv, myCanvas, toolbox, downloadPannel\n\n// 保存坑位\nvar cardElements = {}\n\nvar _CANVAS_WIDTH = Math.min(window.innerWidth * 0.3, 300),\n  _CANVAS_HEIGHT = 300\n\n// svg模版\nvar svgs = []\n\nfunction gui () {\n  window.toast = Lab.base.debounce(() => {\n    if (window.result && window.result.length)\n      Lab.ui.toast(window.result.length)\n  }, 1000)\n\n  // 加载svg库\n  Lab.base\n    .loadFromUrl(\n      'js',\n      'https://cdn.bootcdn.net/ajax/libs/svg.js/3.1.1/svg.min.js'\n    )\n    .then(() => console.log('svg.js done'))\n\n  // mainDiv = Lab.ui.createGroup('container')\n  // Lab.ui.add(mainDiv)\n  // mainDiv.style = 'width: 100%;'\n\n  // mainDiv.innerHTML = `\n  //   <div class=\"ui two column divided grid\">\n  //       <div class=\"stretched row\">\n  //           <div class=\"column\">\n  //               <div class=\"ui segment\" id='myCanvas'></div>\n  //           </div>\n  //           <div class=\"column\" id=\"toolbox\"></div>\n  //       </div>\n  //   </div>\n  //   <div class=\"ui column divided grid\">\n  //       <div class=\"stretched row\">\n  //           <div class=\"column\" id='cards'></div>\n  //       </div>\n  //   </div>\n  //   `\n\n  // 调试界面\n  let toggleDevBtn = Lab.ui.createToggleDevToolsIcon()\n  Lab.ui.add(toggleDevBtn)\n\n  // 设定基础模版\n  let preivewImageForBase = Lab.ui.createImageAndPreview()\n  preivewImageForBase.style.width='440px';\n  preivewImageForBase.style.height='440px';\n  let setBaseBtn = Lab.ui.createButton('0 打开基础模版', () => {\n    Lab.ui.loading(0)\n    let data = Lab.ui.openStringDialog(1)\n    if (data) {\n      window.base = data.data\n      drawBase(preivewImageForBase)\n    }\n    setTimeout(() => Lab.ui.loading(100), 100)\n  })\n\n  Lab.ui.add(preivewImageForBase)\n  Lab.ui.add(Lab.ui.createDivider())\n  Lab.ui.add(setBaseBtn)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  let step2Model = Lab.ui.createModel(`设置素材`, '')\n  Lab.ui.add(step2Model)\n  window.step2Model = step2Model\n  //\n  let step2Btn = Lab.ui.createButton('1 设置素材', () => {\n    // Lab.ui.loading(0);\n    step2Model.show()\n  })\n  Lab.ui.add(step2Btn)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  step2Model.add(Lab.ui.createHeader('4', '1/ 素材固定位置'))\n  // 打开多个svg文件\n  let openBtn = Lab.ui.createButton('打开多个svg文件', () => {\n    Lab.ui.loading(0)\n    svgs = []\n    let datas = Lab.ui.openStringDialog(3)\n    console.log(datas)\n    // 统计变量数量\n    let maskKeys = {}\n    for (const data of datas) {\n      let draw = SVG().addTo('body')\n      draw.__filepath = data.filepath\n      draw.svg(data.data)\n      let parent = draw.children()[0]\n      let styles = parent.attr()\n      draw.width(styles.width)\n      draw.height(styles.height)\n      draw.viewbox(styles.viewBox)\n      draw.node.style.outline = '1px solid gray'\n      draw.node.style.margin = '2px'\n\n      svgs.push(draw)\n      // 预先提取变量\n      let ks = getAllMaskKeys(draw)\n      Array.from(ks, k => {\n        if (maskKeys[k] === undefined) maskKeys[k] = 0\n        maskKeys[k]++\n        // if (!maskKeys.includes(k)) maskKeys.push(k);\n      })\n    }\n    console.log(maskKeys)\n    // 变量设定- 数量显示\n    paramsInput.setValue(JSON.stringify(maskKeys, null, 2))\n    setTimeout(() => Lab.ui.loading(100), 200)\n  })\n  step2Model.add(openBtn)\n  step2Model.add(Lab.ui.createDivider())\n\n  // 设定哪些变量要提取\n  let paramsInput = Lab.ui.createTextareaInput('变量设定，以 -M 为标记', e => {\n    // console.log(e);\n  })\n\n  step2Model.add(paramsInput)\n  step2Model.add(Lab.ui.createDivider())\n\n  step2Model.add(Lab.ui.createHeader('4', '2/ 素材位置随机'))\n\n  // 配色方案\n  let getColorsBtn = Lab.ui.createButton(\n    '1 从剪切板粘贴图片提取主题色',\n    async () => {\n      let im = Lab.clipboard.read('img')\n      if (im && !im.isEmpty()) {\n        let colors = []\n        im = await Lab.ui.createImage(im.toDataURL())\n        let cFn = new Lab.Color()\n        let colorsPalette = await cFn.getPalette(im, 10)\n        colorsPalette.forEach((c, index) => {\n          c = new Lab.Color(c).rgb().array()\n          colors.push(c)\n        })\n        console.log(colors)\n        colorsDiv.innerHTML = ''\n        Array.from(colors, c => {\n          let inc = Lab.ui.createInput('color')\n          c = new Lab.Color(c).hex()\n          inc.setDefaultValue([c])\n          colorsDiv.add(inc)\n        })\n      }\n    }\n  )\n\n  let colorsDiv = Lab.ui.createGroup()\n  Array.from([[0, 0, 0]], (c, index) => {\n    let inc = Lab.ui.createInput('color')\n    c = new Lab.Color(c).hex()\n    inc.setDefaultValue([c])\n    colorsDiv.add(inc)\n  })\n  step2Model.add(getColorsBtn)\n  step2Model.add(Lab.ui.createDivider())\n  step2Model.add(colorsDiv)\n  step2Model.add(Lab.ui.createDivider())\n\n  // 设置素材的权重，权重越高，优先抽取\n  // 设定哪些变量要提取\n  let open2weightBtn = Lab.ui.createButton(\n    '2 打开素材文件夹-设置坑位-素材关系',\n    async () => {\n      let dirname = Lab.ui.getFilePath(2)\n      if (dirname && dirname[0]) {\n        let children = Lab.base.fs.readdirSync(dirname[0])\n        let maskKeys = createMaskKeysFromSvg()\n        let childAsKeys = []\n        for (const child of children) {\n          let childPath = dirname[0] + '/' + child\n          let cStat = Lab.base.fs.statSync(childPath)\n          // 如果是目录，则读取里面的素材图片\n          if (cStat.isDirectory()) {\n            childAsKeys.push(child)\n          }\n        }\n        let baseKey = childAsKeys[0]\n        for (const key in maskKeys) {\n          if (maskKeys[key] === 0) {\n            maskKeys[key] = childAsKeys[childAsKeys.length - 1] || baseKey\n            childAsKeys.pop()\n          }\n        }\n        console.log(maskKeys)\n        weightInput.setValue(JSON.stringify(maskKeys, null, 2))\n        drawBase(preivewImageForBase)\n      }\n    }\n  )\n  step2Model.add(open2weightBtn)\n  step2Model.add(Lab.ui.createDivider())\n  let weightInput = Lab.ui.createTextareaInput(\n    `设置素材文件夹和布局的对应关系{'布局1':'文件夹1','布局2':'文件夹2'}`,\n    e => {\n      // console.log(e);\n    }\n  )\n  step2Model.add(weightInput)\n  step2Model.add(Lab.ui.createDivider())\n\n  // 随机抽取素材\n  let open2Btn = Lab.ui.createButton(\n    '3 打开素材文件夹-以文件夹分类素材',\n    async () => {\n      let dirname = Lab.ui.getFilePath(2)\n      if (dirname && dirname[0]) {\n        let children = Lab.base.fs.readdirSync(dirname[0])\n\n        // 局部储存 key是素材文件夹，value是素材\n        let keysListOne = {}\n\n        // 素材和布局的对应关系\n        let weight = JSON.parse(weightInput.getValue())\n        console.log(weight)\n        // let weightSum = 0\n        // for (let key in weight) {\n        //   weightSum += weight[key]\n        // }\n        // // 总量为10来控制\n        // for (let key in weight) {\n        //   weight[key] = (10 * weight[key]) / weightSum;\n        // };\n\n        //\n        for (const child of children) {\n          let childPath = dirname[0] + '/' + child\n          let cStat = Lab.base.fs.statSync(childPath)\n          // 如果是目录，则读取里面的素材图片\n\n          if (cStat.isDirectory()) {\n            let imgFiles = Lab.base.fs.readdirSync(childPath)\n            let list = []\n            for (const imgFile of imgFiles) {\n              if (imgFile != '.DS_Store') {\n                list.push({\n                  basename: imgFile,\n                  zIndex: 0,\n                  filePath: childPath + '/' + imgFile\n                })\n              }\n            }\n\n            keysListOne[child] = list\n          }\n        }\n        console.log(`完成：`, keysListOne)\n\n        // 全局\n        window.keysList = {}\n        let maskKeys = initRandomLayout()\n\n        // 是否开启颜色变量\n        let colors = Array.from(colorsDiv.children, c => {\n          let rgb = new Lab.Color(c.getValue()).rgb().array()\n          return [\n            { apply: 'red', params: [rgb[0]] },\n            { apply: 'green', params: [rgb[1]] },\n            { apply: 'blue', params: [rgb[2]] }\n          ]\n        })\n\n        // 随机拆分素材\n        for (const key in maskKeys) {\n          // 素材\n          let items = [...keysListOne[weight[key]]]\n\n          // 去重\n          let idsMap = {}\n\n          for (let i = 0; i < items.length; i++) {\n            // 非常容易出现bug\n            items[i] = { ...items[i] }\n\n            // 读取图片并随机颜色\n            items[i].base64 = await Lab.Image.changeColor(\n              items[i].filePath,\n              Lab.base.shuffle(colors)[0]\n            )\n            // 计算id\n            items[i].id = Lab.base.md5(items[i].base64)\n\n            // 添加随机的操作：角度、缩放、翻转\n            let imgBase64 = await Lab.Image.flip(\n              Lab.Image.base642Buffer(items[i].base64),\n              Math.random() > 0.5,\n              Math.random() > 0.5\n            )\n            imgBase64 = await Lab.Image.rotate(\n              Lab.Image.base642Buffer(imgBase64),\n              Math.random() * 15 * (Math.random() > 0.5 ? -1 : 1)\n            )\n\n            items[i].base64 = await Lab.Image.scale(\n              Lab.Image.base642Buffer(imgBase64),\n              Lab.base.shuffle([0.9, 0.8, 1.1, 1, 1.2])[0]\n            )\n\n            if (!idsMap[items[i].id]) {\n              idsMap[items[i].id] = 1\n              items[\n                i\n              ].svg = `<g id=\\\"${key}\\\" data-id=\\\"${items[i].id}\\\" data-basename=\\\"${items[i].basename}\\\"><image id=\\\"${items[i].id}\\\" x=\\\"${maskKeys[key].x}\\\" y=\\\"${maskKeys[key].y}\\\" width=\\\"${maskKeys[key].width}\\\" height=\\\"${maskKeys[key].height}\\\" xlink:href=\\\"${items[i].base64}\\\"></image></g>`\n              items[i].draw = SVG()\n              items[i].draw.svg(items[i].svg)\n              // console.log(items[i].draw)\n              items[i].draw.children()[0].transform(maskKeys[key].transform)\n              items[i].svg = items[i].draw.children()[0].svg()\n              console.log(key, maskKeys)\n              items[i].key = key\n            } else {\n              // 重复了，需要设null\n              items[i] = null\n            }\n          }\n\n          window.keysList[key] = items.filter(i => i)\n          maskKeys[key] = window.keysList[key].length\n        }\n        paramsInput.setValue(JSON.stringify(maskKeys, null, 2))\n        preDataBtn.classList.add('green')\n      }\n    }\n  )\n  step2Model.add(open2Btn)\n  step2Model.add(Lab.ui.createDivider())\n\n  \n\n  // 预处理数据\n  let preDataBtn = Lab.ui.createButton('2 预处理', () => {\n    Lab.ui.loading(0)\n    preDataBtn.classList.remove('green')\n    let text = paramsInput.getValue()\n    if (text) {\n      let json = JSON.parse(text)\n      let keys = Object.keys(json)\n      // let keys = text.split('\\n').filter(f => f);\n      if (keys) {\n        window.keysList = {}\n        for (const key of keys) {\n          window.keysList[key] = []\n        }\n        Array.from(svgs, s => initEngine(s, keys))\n        // 成功遍历完成\n        console.log(window.keysList)\n        window.toast()\n      }\n    }\n    // console.log(paramsInput.getValue())\n    preDataBtn.classList.add('green')\n    setTimeout(() => Lab.ui.loading(100), 200)\n  })\n  Lab.ui.add(preDataBtn)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  // 选择算法\n  // let dkBtn=Lab.ui.createButton('3 笛卡尔全量生成',()=>{\n  //     window.result = createAll();\n  //     window.toast();\n  // });\n  // Lab.ui.add(dkBtn);\n  // Lab.ui.add(Lab.ui.createDivider());\n\n  let fixedBtn = Lab.ui.createButton('3 固定数量随机生成100', () => {\n    Lab.ui.loading(0)\n    // window.result = createAllRandom(100);\n    window.toast()\n    create100()\n    setTimeout(() => Lab.ui.loading(100), 200)\n  })\n\n  // Lab.ui.add(Lab.ui.createBaseText('生成100个'))\n  Lab.ui.add(fixedBtn)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  function create100 () {\n    window.result = createAllRandom(100)\n    if (window.result) {\n      window.resultIndex = 0\n      window.svgsResult = []\n      for (const features of window.result) {\n        let svg = drawSvg(false, window.base, features)\n        window.svgsResult.push(svg)\n      }\n    }\n  }\n\n  let previewModel = Lab.ui.createModel('预览')\n  Lab.ui.add(previewModel)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  let previewModelOpenBtn = Lab.ui.createButton('4 预览', previewModel.show)\n  Lab.ui.add(previewModelOpenBtn)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  //\n  downloadPannel = createDownloadPannel()\n  Lab.ui.add(downloadPannel)\n\n  myCanvas = new Lab.Canvas(_CANVAS_WIDTH, _CANVAS_HEIGHT)\n  myCanvas.onModified = doModified\n  myCanvas.onClick = doClick\n  myCanvas.onRemoved = doRemoved\n  previewModel.add(myCanvas.getElement())\n\n  let cardsDiv = Lab.ui.createGroup('cards')\n  previewModel.add(cardsDiv)\n\n  toolbox = createToolbox()\n  previewModel.add(toolbox)\n\n  let addBtn = Lab.ui.createIcon(\n    'plus',\n    () => {\n      Lab.ui.loading(0)\n      let { card, rect } = createCard(cardsDiv)\n      cardElements[card.id] = {\n        element: card,\n        rect: rect,\n        imgUrls: []\n      }\n      setTimeout(() => Lab.ui.loading(100), 200)\n    },\n    false\n  )\n  addBtn.classList.add('red')\n  previewModel.add(addBtn)\n\n  // addBtn.style = `\n  //   position:fixed;\n  //   right:12px;\n  //   top:240px;\n  //   `\n\n  myCanvas.addRect(\n    {\n      left: 0,\n      top: 0,\n      width: _CANVAS_WIDTH,\n      height: _CANVAS_HEIGHT,\n      stroke: 'black',\n      fill: 'white'\n    },\n    false,\n    true,\n    true\n  )\n  myCanvas.zoomToFitCanvas()\n\n  // 下一个\n  let nextBtn = Lab.ui.createButton('下一个', async () => {\n    myCanvas.reset()\n    if (window.resultIndex >= window.svgsResult.length) window.resultIndex = 0\n    window.currentSvg = window.svgsResult.slice(\n      window.resultIndex,\n      window.resultIndex + 1\n    )[0]\n    let url = Lab.base.str2URL(window.currentSvg, 'image/svg+xml;charset=utf-8')\n    let target = await myCanvas.addSVGFromURL(url)\n    target.name = 'svg'\n    window.targetUrl = url\n    window.resultIndex++\n    // 添加到画布上\n    let cardsDiv = Lab.ui.createGroup('cards')\n    previewModel.add(cardsDiv)\n    let { card, rect } = createCard(cardsDiv)\n    cardElements[card.id] = {\n      element: card,\n      rect: rect,\n      imgs: [\n        {\n          element: target,\n          url: url,\n          type: 'svg'\n        }\n      ]\n    }\n    card.setValue([url])\n    // 缩放表情包\n    updateCanvasImgs(card.id)\n  })\n  previewModel.add(nextBtn)\n\n  let downloadModel = Lab.ui.createModel('下载')\n  let downloadModelBtn = Lab.ui.createButton('5 下载', downloadModel.show)\n  Lab.ui.add(downloadModelBtn)\n\n  // 设置人类可读的编号前缀 APL+0983\n  let setCodeBtn = Lab.ui.createInput('text', '编号前缀', texts => {\n    if (texts && texts.length) {\n      let t = texts[0]\n      t = t.trim()\n      window.__code = t\n    }\n  })\n\n  let setDownloadFilePathBtn = Lab.ui.createButton('设置本地目录', async () => {\n    // 导出本地文件\n    let filepaths = Lab.ui.getFilePath(2)\n    if (filepaths && filepaths[0]) {\n      window.__download_filepath = filepaths[0]\n    }\n  })\n\n  async function download100 () {\n    if (!window.__download_filepath) Lab.ui.toast('请设置本地目录')\n    if (window.__download_filepath) {\n      // id map\n      let idsMap = {}\n      let i = 1\n      let fileNames = Lab.base.readdirSync(window.__download_filepath)\n      for (const fileName of fileNames) {\n        // 判断是否是文件夹\n        if (Lab.base.fs.statSync(fileName).isDirectory()) {\n          let children = Lab.base.readdirSync(fileName)\n          // console.log(children)\n          // 取到svg的id命名的原图\n          let svgFile = children.filter(f => f.match('.svg'))[0]\n          if (svgFile) {\n            let id = Lab.base.getBaseName(svgFile).replace(/\\..*/gi, '')\n            idsMap[id] = 1\n          }\n          i++\n        }\n      }\n\n      for (let svg of window.svgsResult) {\n        let s = SVG()\n        s.svg(svg)\n        let id = s.children()[0].attr('data-id')\n\n        if (!idsMap[id]) {\n          let basename = (window.__code || 'A') + i\n\n          // 把编号写入svg并保存\n          s.children()[0].attr('data-number', basename)\n          svg = s.children()[0].svg()\n\n          // 文件夹\n          let dirname0 = window.__download_filepath + '/' + basename\n          Lab.base.mkdir(dirname0)\n\n          Lab.base.saveData(dirname0 + '/' + id + '.svg', svg)\n\n          // 保存原图-用于上链\n          let base64 = await Lab.Image.svg2base64(svg, 'png')\n          Lab.base.saveBase64(base64, dirname0 + '/' + basename + '.png')\n\n          // 增加水印\n          s.children()[0].add(`<text \n          x=\"0\" \n          y=\"${parseInt(\n            s\n              .children()[0]\n              .attr('height')\n              .replace('px', '')\n          ) - 20}\" fill=\"#000\" transform=\"rotate(0 0 0)\" \n          fill-opacity=\"0.5\" \n          font-size=\"12\">${new Array(100).fill(basename).join(' _ ')}</text>`)\n          // 保存预览图\n          svg = s.children()[0].svg()\n          base64 = await Lab.Image.svg2base64(svg, 'png')\n          Lab.base.saveBase64(\n            base64,\n            dirname0 + '/' + basename + '_preview.png'\n          )\n\n          i++\n        }\n      }\n    }\n  }\n  // console.log(setCodeBtn)\n  let downAllBtn = Lab.ui.createButton('下载到本地', async () => {\n    window.__code = setCodeBtn.getValue()\n    await download100()\n  })\n\n  let down10000Btn = Lab.ui.createButton('1w下载到本地', async () => {\n    for (let index = 0; index < 100; index++) {\n      create100()\n      await download100()\n      Lab.ui.toast(index)\n      await Lab.base.sleep(1500)\n    }\n  })\n\n  // 合成全景图\n  let allPicsBtn = Lab.ui.createButton('合成大图&稀有度', async () => {\n    // id map\n    let idsMap = {}\n    let i = 1\n\n    let filepaths = Lab.ui.getFilePath(0)\n    let num = 20\n    let w = (2 * 2048) / num\n    let h\n    let imgs = []\n\n    // 统计\n    let counts = {}\n\n    // 稀有度\n    if (!window.keysList) Lab.ui.toast('请进行预处理')\n    // 计算每个图的稀有属性值，并保存为.md文件\n    let filesRare = {}\n\n    for (const fileName of filepaths) {\n      let children = Lab.base.readdirSync(fileName)\n      let id = Lab.base.getBaseName(children[0]).replace(/\\..*/gi, '')\n\n      let basenameCode = Lab.base.getBaseName(fileName)\n\n      idsMap[id] = 1\n      filesRare[basenameCode] = { fileName }\n\n      let column = Math.ceil(i / num)\n      if (!imgs[column]) imgs[column] = []\n      for (const child of children) {\n        if (Lab.base.getExtName(child).match('png')) {\n          // 用于合成png大图\n          let im = await Lab.Image.createImage(child)\n          im.fileName = basenameCode\n          h = w / (im.naturalWidth / im.naturalHeight)\n          //   let c = Lab.Image.createCanvasFromImage(im, w, h)\n          //   let ctx = c.getContext('2d')\n          //   ctx.fillStyle = 'black'\n          //   ctx.fillRect(0, h - 44, w, 44)\n          //   ctx.font = '20px Georgia'\n          //   ctx.textBaseline = 'bottom'\n          //   ctx.textAlign = 'right'\n          //   ctx.fillStyle = 'white'\n          //   ctx.fillText(Lab.base.getBaseName(fileName), w - 8, h - 8)\n          imgs[column].push(im)\n        } else if (Lab.base.getExtName(child).match('svg') && window.keysList) {\n          // 用于计算各个元素出现的概率\n          let attrs = {}\n          // console.log(window.keysList) 需要预处理调用成功\n          // console.log(child)\n          let svgStr = Lab.base.readFileSync(child)\n          let draw = SVG()\n          draw.svg(svgStr)\n          for (var k in window.keysList) {\n            let r = draw.findOne('#' + k)\n            if (r) {\n              let id = r.attr('data-id')\n              let obj = window.keysList[k].filter(v => v.id === id)[0]\n              // console.log(k,id);\n              if (obj) {\n                if (!counts[k]) counts[k] = {}\n\n                if (!counts[k][obj.basename]) {\n                  let base64 = await Lab.Image.svg2base64(obj.draw.svg(), 'png')\n                  counts[k][obj.basename] = {\n                    base64,\n                    count: 0\n                  }\n                }\n                counts[k][obj.basename].count++\n                attrs[obj.basename] = 1\n              }\n            }\n          }\n          filesRare[basenameCode].attrs = attrs\n        }\n        // console.log(counts);\n        // window.counts=counts;\n      }\n      i++\n    }\n\n    // Lab.clipboard.write(canvas.toDataURL(),'base64')\n\n    // window.counts=counts;\n    // 统计元素稀有度\n    let ks = []\n    let maxWidth = 0,\n      maxHeight = 0,\n      size = 200\n\n    for (var k in window.keysList) {\n      ks.push({\n        value: window.keysList[k].length,\n        key: k\n      })\n    }\n    ks = ks.sort((a, b) => b.value - a.value)\n    ks = Array.from(ks, k => k.key)\n    for (let index = 0; index < ks.length; index++) {\n      const k = ks[index]\n      // counts[k]\n      let elements = []\n      for (let basename in counts[k]) {\n        let im = await Lab.Image.createImage(counts[k][basename].base64)\n        let canvas = Lab.Image.createCanvasFromImage(im)\n        // 绘制数量到图上\n        let ctx = canvas.getContext('2d')\n        ctx.fillStyle = 'black'\n        ctx.fillRect(0, canvas.height - 56, canvas.width, 56)\n        ctx.font = '38px Georgia'\n        ctx.textBaseline = 'bottom'\n        ctx.textAlign = 'right'\n        ctx.fillStyle = 'white'\n\n        // 稀有度\n        let rare = (\n          (100 * counts[k][basename].count) /\n          filepaths.length\n        ).toFixed(2)\n\n        ctx.fillText(\n          basename.replace(/\\..*/gi, '') + '_' + rare + '%',\n          canvas.width - 8,\n          canvas.height - 8\n        )\n\n        elements.push({\n          basename,\n          value: counts[k][basename].count,\n          rare,\n          canvas\n        })\n      }\n      elements = elements.sort((a, b) => b.value - a.value)\n      maxWidth = Math.max(elements.length * size + 40, maxWidth) + 20\n      ks[index] = {\n        key: k,\n        elements\n      }\n      if (elements.length == 0) ks[index] = null\n    }\n    ks = ks.filter(k => k)\n    maxHeight = ks.length * (size + 20) + 40\n    // console.log(ks,maxWidth,maxHeight)\n\n    // 绘制大图\n    let canvasElements = Lab.Image.createCanvas(maxWidth, maxHeight),\n      ctxElements = canvasElements.getContext('2d')\n\n    for (let k of ks) {\n      let y = size * 1.2 * ks.indexOf(k)\n      if (y + size > canvasElements.height)\n        canvasElements.height = y + 40 + size\n    }\n\n    ctxElements.strokeStyle = 'black'\n    ctxElements.lineWidth = 2\n    ctxElements.font = '14px Georgia'\n    ctxElements.textBaseline = 'top'\n    ctxElements.textAlign = 'left'\n    ctxElements.fillStyle = 'black'\n\n    // 计算每个文件的稀有度\n    window._RARE = {}\n    Array.from(ks, r => {\n      let key = r.key\n      Array.from(r.elements, e => {\n        window._RARE[e.basename] = { key, rare: Number(e.rare) }\n      })\n    })\n\n    window._filesRare = filesRare\n    for (let k of ks) {\n      let y = size * 1.2 * ks.indexOf(k)\n      ctxElements.fillText(k.key, 10, 10 + y)\n      for (let e of k.elements) {\n        let x = k.elements.indexOf(e) * size,\n          xs = (1 + k.elements.indexOf(e)) * 10\n        ctxElements.drawImage(\n          e.canvas,\n          0,\n          0,\n          e.canvas.width,\n          e.canvas.height,\n          x + xs,\n          y + 30,\n          size,\n          size\n        )\n        ctxElements.strokeRect(x + xs, y + 30, size, size)\n      }\n    }\n\n    Lab.ui.saveBase64Dialog(canvasElements.toDataURL(), '保存', '稀有度')\n    // let url=canvasElements.toDataURL();\n    // Lab.ui.add(Lab.ui.createImageAndDownload(url));\n\n    // 绘制-所有文件的大图合集\n    imgs = imgs.filter(i => i)\n    let canvas = Lab.Image.createCanvas(w * num, h * imgs.length)\n    let ctx = canvas.getContext('2d')\n    // console.log(imgs)\n    // 稀有度的总文件\n    let raresText = []\n\n    for (let index = 0; index < imgs.length; index++) {\n      const ims = imgs[index]\n      for (let j = 0; j < ims.length; j++) {\n        const im = ims[j]\n\n        let c = Lab.Image.createCanvasFromImage(im, w, h)\n        let cx = c.getContext('2d')\n        cx.fillStyle = 'black'\n        cx.fillRect(0, h - 44, w, 44)\n        cx.font = '18px Georgia'\n        cx.textBaseline = 'bottom'\n        cx.textAlign = 'right'\n        cx.fillStyle = 'white'\n        // 在这里加入稀有度的数据\n        //\n        function average (nums) {\n          return nums.reduce((a, b) => a + b) / nums.length\n        }\n        function sum (nums) {\n          return nums.reduce((a, b) => a + b)\n        }\n\n        let rare1 = [],\n          rareStr = ''\n        for (let key in _filesRare[im.fileName].attrs) {\n          // console.log(_RARE[key])\n          rare1.push(_RARE[key].rare * 0.001)\n          rareStr += '_' + _RARE[key].key + '_' + _RARE[key].rare + '%'\n        }\n\n        rare1 = (sum(rare1) * 100).toFixed(2)\n\n        cx.fillText(im.fileName + '_' + rare1, w - 8, h - 8)\n\n        ctx.drawImage(c, j * w, index * h, w, h)\n\n        raresText.push({\n          code: im.fileName,\n          rare: rare1,\n          attrs: rareStr\n        })\n      }\n    }\n    Lab.ui.saveBase64Dialog(canvas.toDataURL(), '保存', '大图')\n    Lab.ui.saveJsonDialog(raresText)\n  })\n\n  downloadModel.add(setCodeBtn)\n  downloadModel.add(setDownloadFilePathBtn)\n  downloadModel.add(downAllBtn)\n  downloadModel.add(down10000Btn)\n  downloadModel.add(allPicsBtn)\n}\n\n// 调整内容\nfunction updateCanvasImgs (id) {\n  let { rect, imgs } = cardElements[id]\n  for (const img of imgs) {\n    if (img.type === 'svg') {\n      img.element.left = rect.left\n      img.element.top = rect.top\n      img.element.scaleToHeight(rect.getScaledHeight())\n      img.element.scaleToWidth(rect.getScaledWidth())\n      myCanvas.render()\n    }\n  }\n}\n\nfunction createMaskKeysFromSvg () {\n  var draw = SVG()\n  draw.svg(window.base)\n  var parent = draw.children()[0]\n  var styles = parent.attr()\n  draw.width(styles.width)\n  draw.height(styles.height)\n  draw.viewbox(styles.viewBox)\n  var gs = draw\n    .children()[0]\n    .children()[1]\n    .find('g')\n  let maskKeys = {}\n  for (let index = 0; index < gs.length; index++) {\n    gs[index].id(`M-${index}`)\n    maskKeys[`M-${index}`] = 0\n  }\n  window.base = draw.children()[0].svg()\n  return maskKeys\n}\n\nfunction initRandomLayout () {\n  var draw = SVG()\n  draw.svg(window.base)\n  var parent = draw.children()[0]\n  var styles = parent.attr()\n  draw.width(styles.width)\n  draw.height(styles.height)\n  draw.viewbox(styles.viewBox)\n  var gs = draw\n    .children()[0]\n    .children()[1]\n    .find('g')\n  let maskKeys = {}\n  for (let index = 0; index < gs.length; index++) {\n    // gs[index].id(`M-${index}`)\n    maskKeys[gs[index].id()] = {\n      x: gs[index].x(),\n      y: gs[index].y(),\n      width: gs[index].width(),\n      height: gs[index].height(),\n      transform: gs[index].transform()\n    }\n  }\n  return maskKeys\n}\n\nfunction drawBase (preImg) {\n  var draw = SVG()\n  draw.svg(window.base)\n  var parent = draw.children()[0]\n  var styles = parent.attr()\n  draw.width('120px')\n  draw.height('120px')\n  draw.viewbox(styles.viewBox)\n  let gs = Array.from(draw.find('g'), g => g)\n  gs[0].attr('stroke', 'red')\n  Array.from(gs, g =>\n    g.add(`<text \n          x=\"2\" \n          y=\"14\" fill=\"#000\" transform=\"rotate(0 0 0)\" \n          fill-opacity=\"0.8\" \n          font-size=\"14\">${g.id()}</text>`))\n  preImg.setValue([Lab.base.str2URL(draw.svg(), 'image/svg+xml;charset=utf-8')])\n}\n\nfunction drawSvg (addTo, baseData, features) {\n  let draw = SVG()\n  if (addTo) draw.addTo(addTo)\n  // const clickAddImg = function() {\n  //     console.log(this)\n  //     myCanvas.addImg(this.node)\n  // }\n  // draw.on('click', clickAddImg);\n\n  draw.svg(baseData)\n  let parent = draw.children()[0]\n  let styles = parent.attr()\n  draw.width(styles.width)\n  draw.height(styles.height)\n  draw.viewbox(styles.viewBox)\n  // window.draw=draw;\n  // 更改组件\n  let id = ''\n  for (const r of features) {\n    // 组件svg\n    let element = window.keysList[r.key][r.index]\n    draw.findOne('#' + r.key).svg(element.svg, true)\n    // 拼id\n    id = id + '_' + element.id\n    // TODO 調整圖層順序\n    console.log(element.zIndex)\n  }\n  id = Lab.base.md5(id)\n  // 唯一id\n  draw.attr('data-id', id)\n  // 编号\n  draw.attr('data-number', '编号')\n  return draw.svg()\n}\n\nfunction createDownloadPannel () {\n  let m = Lab.ui.createModel('下载')\n\n  let runBtn = Lab.ui.createButton('下载svg图', () => {\n    // console.log(size)\n    if (window.downloadURL) {\n      let s = SVG()\n      s.svg(window.currentSvg)\n      let id = s.children()[0].attr('data-id')\n      Lab.ui.createDownlad(window.downloadURL, id)\n      downloadPannel.hide()\n    }\n  })\n  m.add(runBtn)\n  let downloadPngBtn = Lab.ui.createButton('下载png图片', () => {\n    // console.log(size)\n    let s = SVG()\n    s.svg(window.currentSvg)\n    let id = s.children()[0].attr('data-id')\n    // TODO bug\n    for (const obj of myCanvas.getObjects()) {\n      if (obj.name === 'svg') Lab.ui.createDownlad(obj.toDataURL(), id)\n    }\n    downloadPannel.hide()\n  })\n  m.add(downloadPngBtn)\n  let copyPngBtn = Lab.ui.createButton('拷贝png图片', () => {\n    // console.log(size)\n    for (const obj of myCanvas.getObjects()) {\n      if (obj.name === 'svg') Lab.clipboard.write(obj.toDataURL(), 'base64')\n    }\n    downloadPannel.hide()\n  })\n  m.add(copyPngBtn)\n  return m\n}\n\n// 图片集\nfunction createCard (row) {\n  let id = new Date().getTime() + '' + parseInt(Math.random() * 1000)\n\n  let card = Lab.ui.createGroup('card')\n  card.style.width = 'min-content'\n  card.style.margin = '12px'\n  card.addEventListener('click', e => {\n    setActiveObject(id)\n    toolbox.update()\n  })\n  card.id = id\n  row.add(card)\n\n  let text = `图片集 ${1 + Object.keys(cardElements).length}`\n  let t = Lab.ui.createBaseText(text)\n  card.add(t)\n  t.style.margin = '1em'\n\n  // img\n  let imgBtn = Lab.ui.createInput(\n    'imgs',\n    text,\n    imgs => {\n      Lab.ui.loading(0)\n      console.log(id, imgs)\n      if (cardElements[id]) cardElements[id].imgUrls = imgs\n      setTimeout(() => Lab.ui.loading(100), 3000)\n    },\n    true,\n    false\n  )\n  card.add(imgBtn)\n\n  // btns 功能区\n  let btnsDiv = Lab.ui.createGroup('column')\n  btnsDiv.style.display = 'flex'\n  let downloadBtn = Lab.ui.createIcon('download', () => {\n    //  console.log(imgBtn.getValue())\n    window.downloadURL = imgBtn.getValue()\n    if (downloadPannel) downloadPannel.show()\n  })\n  btnsDiv.add(downloadBtn)\n\n  card.add(btnsDiv)\n\n  // 占位框\n  let rect = myCanvas.addRect(\n    {\n      left: parseInt(_CANVAS_WIDTH / 2) - 100,\n      top: parseInt(_CANVAS_HEIGHT / 2) - 100,\n      width: 100,\n      height: 100,\n      // stroke: 'red',\n      strokeWidth: 0,\n      fill: 'rgba(255,0,0,0.1)'\n    },\n    true,\n    true,\n    true\n  )\n  // myCanvas.zoomToFitCanvas()\n  rect.name = 'artboard'\n  rect.id = id\n\n  // 选项框\n  let ins = Lab.ui.createInput(\n    'select',\n    '',\n    e => {\n      console.log(e, rect, imgBtn)\n      if (e === 'img') {\n        window.rect = rect\n        window.imgBtn = imgBtn\n      }\n    },\n    true,\n    false\n  )\n  ins.appendOptions([\n    {\n      value: 'img',\n      text: '图片'\n    },\n    {\n      value: 'emoji',\n      text: '表情'\n    },\n    {\n      value: 'color',\n      text: '色块'\n    }\n  ])\n  card.add(ins)\n  ins.init()\n  ins.style.marginLeft = '12px'\n  card.setValue = imgBtn.setValue\n  return { card, rect }\n}\n\nfunction createToolbox () {\n  let inPos = Lab.ui.createInputForPosition(pos => {\n    // console.log(pos)\n    let [x, y, w, h] = pos\n\n    let rect = myCanvas.getActiveObject()\n    rect.scaleToWidth(w)\n    rect.scaleToHeight(h)\n\n    rect.left = x\n    rect.top = y\n    // console.log(z);\n\n    rect.width = w / rect.scaleX\n    rect.height = h / rect.scaleX\n\n    myCanvas.render()\n  })\n  inPos.update = () => {\n    let rect = myCanvas.getActiveObject()\n    inPos.setValue([\n      rect.left,\n      rect.top,\n      rect.getScaledWidth(),\n      rect.getScaledHeight()\n    ])\n    updateCanvasImgs(rect.id)\n  }\n  return inPos\n}\n\nfunction doModified (e, data) {\n  // console.log(e, data)\n  // e.target.id;\n  if (e.target.id && cardElements[e.target.id]) {\n    toolbox.update()\n  }\n}\n\nfunction doClick (e) {\n  // console.log(e.target.id)\n  if (e.target && e.target.id && cardElements[e.target.id]) {\n    let card = cardElements[e.target.id]\n    // console.log(card, e.target.id)\n    card.element.classList.add('red')\n    // 更新rect信息到toolbox\n    toolbox.update()\n  } else {\n    for (const id in cardElements) {\n      cardElements[id].element.classList.remove('red')\n    }\n  }\n}\n\nfunction doRemoved (e) {\n  if (e.target.id && cardElements[e.target.id]) {\n    cardElements[e.target.id].element.remove()\n    delete cardElements[e.target.id]\n  }\n}\n\n// 激活\nfunction setActiveObject (id) {\n  for (const id in cardElements) {\n    cardElements[id].element.classList.remove('red')\n  }\n  if (cardElements[id]) {\n    let c = cardElements[id]\n    myCanvas.setActiveObject(c.rect)\n    c.element.classList.add('red')\n  }\n}\n\nfunction travel (children = []) {\n  // let isDone = true;\n  let list = []\n  for (let c of children) {\n    // console.log(c.node.id);\n    // if (doFun) doFun(c)\n    // if (c.children().length > 0) {\n    //     isDone = false;\n    //     travel(c.children(), doFun, successFun);\n    // };\n    list.push(c)\n    if (c.children().length > 0) {\n      list = [...list, ...travel(c.children())]\n    }\n  }\n  return list\n  // bug\n  // console.log(isDone)\n  // if (successFun && isDone) {\n  //     successFun();\n  // }\n}\n\n// step 1 打开所有的模版\n// step 2 设定变量，预处理，提取变量对应的svg\n// step 3 导出数据\n\n// 得到变量，用-M标记的变量\nfunction getAllMaskKeys (draw) {\n  let maskKeys = []\n  let children = travel(draw.children())\n  // console.log(children)\n  // 遍历过程中的数据处理\n  for (const child of children) {\n    if (\n      child.node.id &&\n      child.node.id.trim() &&\n      child.node.id.match('-M') &&\n      !maskKeys.includes(child.node.id)\n    ) {\n      maskKeys.push(child.node.id)\n    }\n  }\n  // 成功遍历完成\n  return maskKeys\n}\n\n// 初始化\n// keyList=['face','eyes','mouse','ears']\n// window.face=[];\n// window.eyes=[];\n// window.mouse=[];\n// window.ears=[];\nfunction initEngine (draw, keys = []) {\n  // 文件名\n  let basename = Lab.base.getBaseName(draw.__filepath)\n  let children = travel(draw.children())\n  for (const child of children) {\n    // 遍历过程中的数据处理\n\n    if (keys.includes(child.node.id) && window.keysList[child.node.id]) {\n      let id = Lab.base.md5(basename)\n      //  寫上id\n      child.attr('data-id', id)\n      child.attr('data-basename', basename)\n      let svg = child.svg()\n      let isNew = true\n      for (const n of window.keysList[child.node.id]) {\n        if (n.id === id) isNew = false\n      }\n      if (isNew) {\n        window.keysList[child.node.id].push({\n          id,\n          svg,\n          basename,\n          draw,\n          zIndex: keys.indexOf(child.node.id)\n        })\n        let index = window.keysList[child.node.id].length - 1\n        draw.node.addEventListener('click', e => {\n          window.keysList[child.node.id][index].draw.node.style.opacity += 0.05\n          window.keysList[child.node.id][index].zIndex++\n          if (window.keysList[child.node.id][index].draw.node.style.opacity > 1)\n            window.keysList[child.node.id][index].zIndex = 0\n          console.log(window.keysList[child.node.id][index])\n        })\n      }\n    }\n  }\n}\n\n// 笛卡尔生成全集\nfunction createAll () {\n  let data = []\n  for (const key in window.keysList) {\n    data.push(\n      Array.from(window.keysList[key], (d, i) => {\n        return {\n          key: key,\n          index: i\n        }\n      })\n    )\n  }\n  let ds = Lab.base.cartesian(data)\n  // ds=Lab.base.chunk(ds,6);\n  return ds\n}\n\n// 笛卡尔积太大，改用随机生成，重复一定的数量\nfunction createAllRandom (count = 100) {\n  let data = []\n  for (const key in window.keysList) {\n    data.push(\n      Array.from(window.keysList[key], (d, i) => {\n        return {\n          key: key,\n          index: i\n        }\n      })\n    )\n  }\n  let ds = []\n  let dsMap = {}\n  for (let index = 0; index < count * 2; index++) {\n    let style = []\n    for (const d of data) {\n      let s = Lab.base.shuffle([...d])[0]\n      style.push(s)\n    }\n    let id = Lab.base.hash(style)\n    if (!dsMap[id]) {\n      ds.push(style)\n      dsMap[id] = 1\n    }\n  }\n  ds = Lab.base.shuffle([...ds]).slice(0, count)\n  return ds\n}\n",
  "code_length": 249,
  "size": [
    883,
    681
  ],
  "extname": "designlabplugin",
  "version": "0.11",
  "package_version": "0.1.2",
  "package_id": "8255f6cf550e81a6c7f3ad3ca18c92229fab703c",
  "dependencies": {
    "@ffmpeg-installer/ffmpeg": "^1.0.20",
    "@ffprobe-installer/ffprobe": "^1.1.0",
    "@fortawesome/fontawesome-free": "^5.15.3",
    "@hapi/hapi": "^20.1.2",
    "@kilokilo/three-bmfont-text": "^3.1.0",
    "@mediapipe/camera_utils": "^0.3.1632432234",
    "@mediapipe/drawing_utils": "^0.3.1620248257",
    "@mediapipe/holistic": "^0.5.1635989137",
    "@node-rs/jieba": "^1.3.1",
    "@paddlejs-models/humanseg": "0.0.5",
    "@pixiv/three-vrm": "^0.6.7",
    "@tensorflow-models/body-pix": "^2.1.0",
    "@tensorflow-models/deeplab": "^0.2.1",
    "@tensorflow-models/face-landmarks-detection": "0.0.1",
    "@tensorflow-models/knn-classifier": "^1.2.2",
    "@tensorflow-models/mobilenet": "^2.1.0",
    "@tensorflow-models/posenet": "^2.2.2",
    "@tensorflow/tfjs": "^3.3.0",
    "@tensorflow/tfjs-backend-wasm": "^3.3.0",
    "about-window": "^1.14.0",
    "animejs": "^3.2.1",
    "babylonjs": "^4.2.0",
    "babylonjs-gui": "^4.2.0",
    "babylonjs-loaders": "^4.2.0",
    "color": "^3.1.3",
    "dat.gui": "^0.7.7",
    "debounce": "^1.2.1",
    "electron-json-storage": "^4.4.0",
    "electron-squirrel-startup": "^1.0.0",
    "emoji-picker-element": "^1.6.0",
    "emoji-regex": "^9.2.2",
    "espree": "^7.3.1",
    "exceljs": "^4.2.1",
    "face-api.js": "^0.22.2",
    "fluent-ffmpeg": "^2.1.2",
    "fomantic-ui": "^2.8.7",
    "gif.js": "^0.2.0",
    "gifuct-js": "^2.1.1",
    "horajs": "^0.1.3",
    "idb-kv-store": "^4.5.0",
    "internal-ip": "^6.2.0",
    "jimp": "^0.16.1",
    "kalidokit": "^1.0.5",
    "lowdb": "^1.0.0",
    "make-cert": "^1.2.0",
    "marked": "^1.2.9",
    "md5": "^2.3.0",
    "mime-types": "^2.1.34",
    "mkcert": "^1.4.0",
    "ml": "^6.0.0",
    "natural": "^5.0.3",
    "ngraph.path": "^1.3.1",
    "nouislider": "^14.7.0",
    "object-hash": "^2.1.1",
    "open-simplex-noise": "^2.5.0",
    "opencvjs-dist": "^4.4.0",
    "osc-js": "^2.1.2",
    "pdfjs-dist": "^2.6.347",
    "peer": "^0.6.1",
    "peerjs": "^1.3.2",
    "pixelit": "https://github.com/giventofly/pixelit.git",
    "qrcode": "^1.5.0",
    "recordrtc": "^5.6.2",
    "regl": "^2.1.0",
    "smartcrop": "^2.0.3",
    "socket.io": "^4.0.0",
    "socket.io-client": "^4.0.0",
    "three": "^0.134.0",
    "timeago.js": "^4.0.2",
    "unsplash-js": "^7.0.12",
    "wordcloud": "^1.2.2",
    "yoga-layout-wasm": "^1.9.3-alpha.7",
    "zdog": "^1.1.2"
  },
  "author": "shadow",
  "create_time": 1642400507567
}