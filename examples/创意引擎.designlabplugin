{
  "id": "f28a7ab93fec018009a2f4d932ceb696379ca534",
  "poster": "data:image/png;base64,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",
  "title": "创意引擎",
  "knowledge": {
    "course": "- 变量\n- 优化ui\n- 基于svg模版的生成\n- 自动从图片提取配色方案\n- 布局-素材自由绑定\n- 固定数量随机生成\n- 计算稀有度&合成大图",
    "readme": "创意引擎",
    "author": "shadow",
    "version": "0.8"
  },
  "code": "var mainDiv, myCanvas, toolbox, downloadPannel\n\n// 保存坑位\nvar cardElements = {}\n\nvar _CANVAS_WIDTH = Math.min(window.innerWidth * 0.3, 300),\n  _CANVAS_HEIGHT = 300\n\n// svg模版\nvar svgs = []\n\nfunction gui () {\n  window.toast = Lab.base.debounce(() => {\n    if (window.result && window.result.length)\n      Lab.ui.toast(window.result.length)\n  }, 1000)\n\n  // 加载svg库\n  Lab.base\n    .loadFromUrl(\n      'js',\n      'https://cdn.bootcdn.net/ajax/libs/svg.js/3.1.1/svg.min.js'\n    )\n    .then(() => console.log('svg.js done'))\n\n  mainDiv = Lab.ui.createGroup('container')\n  Lab.ui.add(mainDiv)\n  mainDiv.style = 'width: 100%;'\n\n  mainDiv.innerHTML = `\n    <div class=\"ui two column divided grid\">\n        <div class=\"stretched row\">\n            <div class=\"column\">\n                <div class=\"ui segment\" id='myCanvas'></div>\n            </div>\n            <div class=\"column\" id=\"toolbox\"></div>\n        </div>\n    </div>\n    <div class=\"ui column divided grid\">\n        <div class=\"stretched row\">\n            <div class=\"column\" id='cards'></div>\n        </div>\n    </div>\n    `\n\n  //\n  downloadPannel = createDownloadPannel()\n  mainDiv.add(downloadPannel)\n\n  myCanvas = new Lab.Canvas(_CANVAS_WIDTH, _CANVAS_HEIGHT)\n  myCanvas.onModified = doModified\n  myCanvas.onClick = doClick\n  myCanvas.onRemoved = doRemoved\n  mainDiv.querySelector('#myCanvas').appendChild(myCanvas.getElement())\n\n  let cardsDiv = Lab.ui.createGroup('cards')\n  mainDiv.querySelector('#cards').appendChild(cardsDiv)\n\n  toolbox = createToolbox()\n  mainDiv.querySelector('#toolbox').appendChild(toolbox)\n\n  let addBtn = Lab.ui.createIcon('plus', () => {\n    Lab.ui.loading(0)\n    let { card, rect } = createCard(cardsDiv)\n    cardElements[card.id] = {\n      element: card,\n      rect: rect,\n      imgUrls: []\n    }\n    setTimeout(() => Lab.ui.loading(100), 200)\n  })\n  addBtn.classList.add('red')\n  addBtn.style = `\n    position:fixed;\n    right:12px;\n    top:240px;\n    `\n\n  myCanvas.addRect(\n    {\n      left: 0,\n      top: 0,\n      width: _CANVAS_WIDTH,\n      height: _CANVAS_HEIGHT,\n      stroke: 'black',\n      fill: 'white'\n    },\n    false,\n    true,\n    true\n  )\n  myCanvas.zoomToFitCanvas()\n\n  // 设定基础模版\n  let preivewImageForBase = Lab.ui.createImageAndPreview()\n  let setBaseBtn = Lab.ui.createButton('0 打开基础模版', () => {\n    Lab.ui.loading(0)\n    let data = Lab.ui.openStringDialog(1)\n    if (data) {\n      window.base = data.data\n      drawBase(preivewImageForBase)\n    }\n    setTimeout(() => Lab.ui.loading(100), 100)\n  })\n  // console.log(preivewImageForBase)\n  Lab.ui.add(setBaseBtn)\n  Lab.ui.add(Lab.ui.createDivider())\n  Lab.ui.add(preivewImageForBase)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  // 配色方案\n  let getColorsBtn = Lab.ui.createButton('0 从图片提取主题色', async () => {\n    let im = Lab.clipboard.read('img')\n    if (!im.isEmpty()) {\n      let colors = []\n      im = await Lab.ui.createImage(im.toDataURL())\n      let cFn = new Lab.Color()\n      let colorsPalette = await cFn.getPalette(im, 10)\n      colorsPalette.forEach((c, index) => {\n        c = new Lab.Color(c).rgb().array()\n        colors.push(c)\n      })\n      console.log(colors)\n      colorsDiv.innerHTML = ''\n      Array.from(colors, c => {\n        let inc = Lab.ui.createInput('color')\n        c = new Lab.Color(c).hex()\n        inc.setDefaultValue([c])\n        colorsDiv.add(inc)\n      })\n    }\n  })\n\n  let colorsDiv = Lab.ui.createGroup()\n  Array.from([[0, 0, 0]], (c, index) => {\n    let inc = Lab.ui.createInput('color')\n    c = new Lab.Color(c).hex()\n    inc.setDefaultValue([c])\n    colorsDiv.add(inc)\n  })\n  Lab.ui.add(getColorsBtn)\n  Lab.ui.add(colorsDiv)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  // 打开多个svg文件\n  let openBtn = Lab.ui.createButton('1-1 打开多个svg文件', () => {\n    Lab.ui.loading(0)\n    svgs = []\n    let datas = Lab.ui.openStringDialog(3)\n    console.log(datas)\n    // 统计变量数量\n    let maskKeys = {}\n    for (const data of datas) {\n      let draw = SVG().addTo('body')\n      draw.__filepath = data.filepath\n      draw.svg(data.data)\n      let parent = draw.children()[0]\n      let styles = parent.attr()\n      draw.width(styles.width)\n      draw.height(styles.height)\n      draw.viewbox(styles.viewBox)\n      draw.node.style.outline = '1px solid gray'\n      draw.node.style.margin = '2px'\n\n      svgs.push(draw)\n      // 预先提取变量\n      let ks = getAllMaskKeys(draw)\n      Array.from(ks, k => {\n        if (maskKeys[k] === undefined) maskKeys[k] = 0\n        maskKeys[k]++\n        // if (!maskKeys.includes(k)) maskKeys.push(k);\n      })\n    }\n    console.log(maskKeys)\n    // 变量设定- 数量显示\n    paramsInput.setValue(JSON.stringify(maskKeys, null, 2))\n    setTimeout(() => Lab.ui.loading(100), 200)\n  })\n  Lab.ui.add(openBtn)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  // 设置素材的权重，权重越高，优先抽取\n  // 设定哪些变量要提取\n  let open2weightBtn = Lab.ui.createButton(\n    '1-2 打开素材文件夹-设置权重',\n    async () => {\n      let dirname = Lab.ui.getFilePath(2)\n      if (dirname && dirname[0]) {\n        let children = Lab.base.fs.readdirSync(dirname[0])\n        let maskKeys = createMaskKeysFromSvg()\n        let childAsKeys = []\n        for (const child of children) {\n          let childPath = dirname[0] + '/' + child\n          let cStat = Lab.base.fs.statSync(childPath)\n          // 如果是目录，则读取里面的素材图片\n          if (cStat.isDirectory()) {\n            childAsKeys.push(child)\n          }\n        }\n        let baseKey = childAsKeys[0]\n        for (const key in maskKeys) {\n          if (maskKeys[key] === 0) {\n            maskKeys[key] = childAsKeys[childAsKeys.length - 1] || baseKey\n            childAsKeys.pop()\n          }\n        }\n        console.log(maskKeys)\n        weightInput.setValue(JSON.stringify(maskKeys, null, 2))\n        drawBase(preivewImageForBase)\n      }\n    }\n  )\n  Lab.ui.add(open2weightBtn)\n  Lab.ui.add(Lab.ui.createDivider())\n  let weightInput = Lab.ui.createTextareaInput(\n    `设置素材文件夹和布局的对应关系{'布局1':'文件夹1','布局2':'文件夹2'}`,\n    e => {\n      // console.log(e);\n    }\n  )\n  Lab.ui.add(weightInput)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  // 随机抽取素材\n  let open2Btn = Lab.ui.createButton(\n    '1-2 打开素材文件夹-以文件夹分类素材',\n    async () => {\n      let dirname = Lab.ui.getFilePath(2)\n      if (dirname && dirname[0]) {\n        let children = Lab.base.fs.readdirSync(dirname[0])\n\n        // 局部储存 key是素材文件夹，value是素材\n        let keysListOne = {}\n\n        // 素材和布局的对应关系\n        let weight = JSON.parse(weightInput.getValue())\n        console.log(weight)\n        // let weightSum = 0\n        // for (let key in weight) {\n        //   weightSum += weight[key]\n        // }\n        // // 总量为10来控制\n        // for (let key in weight) {\n        //   weight[key] = (10 * weight[key]) / weightSum;\n        // };\n\n        //\n        for (const child of children) {\n          let childPath = dirname[0] + '/' + child\n          let cStat = Lab.base.fs.statSync(childPath)\n          // 如果是目录，则读取里面的素材图片\n\n          if (cStat.isDirectory()) {\n            let imgFiles = Lab.base.fs.readdirSync(childPath)\n            let list = []\n            for (const imgFile of imgFiles) {\n              if (imgFile != '.DS_Store') {\n                list.push({\n                  basename: imgFile,\n                  zIndex: 0,\n                  filePath: childPath + '/' + imgFile\n                })\n              }\n            }\n\n            keysListOne[child] = list\n          }\n        }\n        console.log(`完成：`, keysListOne)\n\n        // 全局\n        window.keysList = {}\n        let maskKeys = initRandomLayout()\n\n        // 是否开启颜色变量\n        let colors = Array.from(colorsDiv.children, c => {\n          let rgb = new Lab.Color(c.getValue()).rgb().array()\n          return [\n            { apply: 'red', params: [rgb[0]] },\n            { apply: 'green', params: [rgb[1]] },\n            { apply: 'blue', params: [rgb[2]] }\n          ]\n        })\n\n        // 随机拆分素材\n        for (const key in maskKeys) {\n          // 素材\n          let items = [...keysListOne[weight[key]]]\n\n          // 去重\n          let idsMap = {}\n\n          for (let i = 0; i < items.length; i++) {\n            // 非常容易出现bug\n            items[i] = { ...items[i] }\n\n            // 读取图片并随机颜色\n            items[i].base64 = await Lab.Image.changeColor(\n              items[i].filePath,\n              Lab.base.shuffle(colors)[0]\n            )\n            // 计算id\n            items[i].id = Lab.base.md5(items[i].base64)\n\n            // 添加随机的操作：角度、缩放、翻转\n            let imgBase64 = await Lab.Image.flip(\n              Lab.Image.base642Buffer(items[i].base64),\n              Math.random() > 0.5,\n              Math.random() > 0.5\n            )\n            imgBase64=await Lab.Image.rotate(\n              Lab.Image.base642Buffer(imgBase64),\n              Math.random() * 15 * (Math.random() > 0.5 ? -1 : 1)\n            );\n\n            items[i].base64=await Lab.Image.scale(\n              Lab.Image.base642Buffer(imgBase64),\n              Lab.base.shuffle([0.9,0.8,1.1,1,1.2])[0]\n            );\n\n            if (!idsMap[items[i].id]) {\n              idsMap[items[i].id] = 1\n              items[\n                i\n              ].svg = `<g id=\\\"${key}\\\" data-id=\\\"${items[i].id}\\\" data-basename=\\\"${items[i].basename}\\\"><image id=\\\"${items[i].id}\\\" x=\\\"${maskKeys[key].x}\\\" y=\\\"${maskKeys[key].y}\\\" width=\\\"${maskKeys[key].width}\\\" height=\\\"${maskKeys[key].height}\\\" xlink:href=\\\"${items[i].base64}\\\"></image></g>`\n              items[i].draw = SVG()\n              items[i].draw.svg(items[i].svg)\n              // console.log(items[i].draw)\n              items[i].draw.children()[0].transform(maskKeys[key].transform)\n              items[i].svg = items[i].draw.children()[0].svg()\n              console.log(key, maskKeys)\n              items[i].key = key\n            } else {\n              // 重复了，需要设null\n              items[i] = null\n            }\n          }\n\n          window.keysList[key] = items.filter(i => i)\n          maskKeys[key] = window.keysList[key].length\n        }\n        paramsInput.setValue(JSON.stringify(maskKeys, null, 2))\n        preDataBtn.classList.add('green')\n      }\n    }\n  )\n  Lab.ui.add(open2Btn)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  // 设定哪些变量要提取\n  let paramsInput = Lab.ui.createTextareaInput('变量设定，以 -M 为标记', e => {\n    // console.log(e);\n  })\n\n  Lab.ui.add(paramsInput)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  // 预处理数据\n  let preDataBtn = Lab.ui.createButton('2 预处理', () => {\n    Lab.ui.loading(0)\n    preDataBtn.classList.remove('green')\n    let text = paramsInput.getValue()\n    if (text) {\n      let json = JSON.parse(text)\n      let keys = Object.keys(json)\n      // let keys = text.split('\\n').filter(f => f);\n      if (keys) {\n        window.keysList = {}\n        for (const key of keys) {\n          window.keysList[key] = []\n        }\n        Array.from(svgs, s => initEngine(s, keys))\n        // 成功遍历完成\n        console.log(window.keysList)\n        window.toast()\n      }\n    }\n    // console.log(paramsInput.getValue())\n    preDataBtn.classList.add('green')\n    setTimeout(() => Lab.ui.loading(100), 200)\n  })\n  Lab.ui.add(preDataBtn)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  // 选择算法\n  // let dkBtn=Lab.ui.createButton('3 笛卡尔全量生成',()=>{\n  //     window.result = createAll();\n  //     window.toast();\n  // });\n  // Lab.ui.add(dkBtn);\n  // Lab.ui.add(Lab.ui.createDivider());\n\n  let fixedBtn = Lab.ui.createButton('3 固定数量随机生成100', () => {\n    Lab.ui.loading(0)\n    // window.result = createAllRandom(100);\n    window.toast()\n    create100()\n    setTimeout(() => Lab.ui.loading(100), 200)\n  })\n\n  Lab.ui.add(Lab.ui.createBaseText('生成100个'))\n  Lab.ui.add(fixedBtn)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  function create100 () {\n    window.result = createAllRandom(100)\n    if (window.result) {\n      window.resultIndex = 0\n      window.svgsResult = []\n      for (const features of window.result) {\n        let svg = drawSvg(false, window.base, features)\n        window.svgsResult.push(svg)\n      }\n    }\n  }\n\n  // 下一个\n  let nextBtn = Lab.ui.createButton('下一个', async () => {\n    myCanvas.reset()\n    if (window.resultIndex >= window.svgsResult.length) window.resultIndex = 0\n    window.currentSvg = window.svgsResult.slice(\n      window.resultIndex,\n      window.resultIndex + 1\n    )[0]\n    let url = Lab.base.str2URL(window.currentSvg, 'image/svg+xml;charset=utf-8')\n    let target = await myCanvas.addSVGFromURL(url)\n    target.name = 'svg'\n    window.targetUrl = url\n    window.resultIndex++\n    // 添加到画布上\n    let cardsDiv = Lab.ui.createGroup('cards')\n    mainDiv.querySelector('#cards').appendChild(cardsDiv)\n    let { card, rect } = createCard(cardsDiv)\n    cardElements[card.id] = {\n      element: card,\n      rect: rect,\n      imgs: [\n        {\n          element: target,\n          url: url,\n          type: 'svg'\n        }\n      ]\n    }\n    card.setValue([url])\n    // 缩放表情包\n    updateCanvasImgs(card.id)\n  })\n  Lab.ui.add(Lab.ui.createBaseText('预览'))\n  Lab.ui.add(nextBtn)\n  Lab.ui.add(Lab.ui.createDivider())\n\n  // 设置人类可读的编号前缀 APL+0983\n  let setCodeBtn = Lab.ui.createInput('text', '编号前缀', texts => {\n    if (texts && texts.length) {\n      let t = texts[0]\n      t = t.trim()\n      window.__code = t\n    }\n  })\n\n  let setDownloadFilePathBtn = Lab.ui.createButton('设置本地目录', async () => {\n    // 导出本地文件\n    let filepaths = Lab.ui.getFilePath(2)\n    if (filepaths && filepaths[0]) {\n      window.__download_filepath = filepaths[0]\n    }\n  })\n\n  async function download100 () {\n    if (window.__download_filepath) {\n      // id map\n      let idsMap = {}\n      let i = 1\n      let fileNames = Lab.base.readdirSync(window.__download_filepath)\n      for (const fileName of fileNames) {\n        // 判断是否是文件夹\n        if (Lab.base.fs.statSync(fileName).isDirectory()) {\n          let children = Lab.base.readdirSync(fileName)\n          let id = Lab.base.getBaseName(children[0]).replace(/\\..*/gi, '')\n          idsMap[id] = 1\n          i++\n        }\n      }\n\n      for (const svg of window.svgsResult) {\n        let s = SVG()\n        s.svg(svg)\n        let id = s.children()[0].attr('data-id')\n        if (!idsMap[id]) {\n          let base64 = await Lab.Image.svg2base64(svg, 'png')\n          // 文件夹\n          let dirname0 =\n            window.__download_filepath + '/' + (window.__code || 'A') + i\n          Lab.base.mkdir(dirname0)\n          Lab.base.saveData(dirname0 + '/' + id + '.svg', svg)\n          Lab.base.saveBase64(base64, dirname0 + '/' + id + '.png')\n          i++\n        }\n      }\n    }\n  }\n  // console.log(setCodeBtn)\n  let downAllBtn = Lab.ui.createButton('下载到本地', async () => {\n    window.__code = setCodeBtn.getValue()\n    await download100()\n  })\n  Lab.ui.add(Lab.ui.createBaseText('下载'))\n  Lab.ui.add(setCodeBtn)\n  Lab.ui.add(setDownloadFilePathBtn)\n  Lab.ui.add(downAllBtn)\n\n  let down10000Btn = Lab.ui.createButton('1w下载到本地', async () => {\n    for (let index = 0; index < 100; index++) {\n      create100()\n      await download100()\n      Lab.ui.toast(index)\n      await Lab.base.sleep(1500)\n    }\n  })\n  Lab.ui.add(down10000Btn)\n\n  // 合成全景图\n  let allPicsBtn = Lab.ui.createButton('合成大图&稀有度', async () => {\n    // id map\n    let idsMap = {}\n    let i = 1\n\n    let filepaths = Lab.ui.getFilePath(0)\n    let num = 20\n    let w = (2 * 2048) / num\n    let h\n    let imgs = []\n\n    // 统计\n    let counts = {}\n\n    // 稀有度\n    if (!window.keysList) Lab.ui.toast('请进行预处理')\n    // 计算每个图的稀有属性值，并保存为.md文件\n    let filesRare = {}\n\n    for (const fileName of filepaths) {\n      let children = Lab.base.readdirSync(fileName)\n      let id = Lab.base.getBaseName(children[0]).replace(/\\..*/gi, '')\n\n      let basenameCode = Lab.base.getBaseName(fileName)\n\n      idsMap[id] = 1\n      filesRare[basenameCode] = { fileName }\n\n      let column = Math.ceil(i / num)\n      if (!imgs[column]) imgs[column] = []\n      for (const child of children) {\n        if (Lab.base.getExtName(child).match('png')) {\n          // 用于合成png大图\n          let im = await Lab.Image.createImage(child)\n          im.fileName = basenameCode\n          h = w / (im.naturalWidth / im.naturalHeight)\n          //   let c = Lab.Image.createCanvasFromImage(im, w, h)\n          //   let ctx = c.getContext('2d')\n          //   ctx.fillStyle = 'black'\n          //   ctx.fillRect(0, h - 44, w, 44)\n          //   ctx.font = '20px Georgia'\n          //   ctx.textBaseline = 'bottom'\n          //   ctx.textAlign = 'right'\n          //   ctx.fillStyle = 'white'\n          //   ctx.fillText(Lab.base.getBaseName(fileName), w - 8, h - 8)\n          imgs[column].push(im)\n        } else if (Lab.base.getExtName(child).match('svg') && window.keysList) {\n          // 用于计算各个元素出现的概率\n          let attrs = {}\n          // console.log(window.keysList) 需要预处理调用成功\n          // console.log(child)\n          let svgStr = Lab.base.readFileSync(child)\n          let draw = SVG()\n          draw.svg(svgStr)\n          for (var k in window.keysList) {\n            let r = draw.findOne('#' + k)\n            if (r) {\n              let id = r.attr('data-id')\n              let obj = window.keysList[k].filter(v => v.id === id)[0]\n              // console.log(k,id);\n              if (obj) {\n                if (!counts[k]) counts[k] = {}\n\n                if (!counts[k][obj.basename]) {\n                  let base64 = await Lab.Image.svg2base64(obj.draw.svg(), 'png')\n                  counts[k][obj.basename] = {\n                    base64,\n                    count: 0\n                  }\n                }\n                counts[k][obj.basename].count++\n                attrs[obj.basename] = 1\n              }\n            }\n          }\n          filesRare[basenameCode].attrs = attrs\n        }\n        // console.log(counts);\n        // window.counts=counts;\n      }\n      i++\n    }\n\n    // Lab.clipboard.write(canvas.toDataURL(),'base64')\n\n    // window.counts=counts;\n    // 统计元素稀有度\n    let ks = []\n    let maxWidth = 0,\n      maxHeight = 0,\n      size = 200\n\n    for (var k in window.keysList) {\n      ks.push({\n        value: window.keysList[k].length,\n        key: k\n      })\n    }\n    ks = ks.sort((a, b) => b.value - a.value)\n    ks = Array.from(ks, k => k.key)\n    for (let index = 0; index < ks.length; index++) {\n      const k = ks[index]\n      // counts[k]\n      let elements = []\n      for (let basename in counts[k]) {\n        let im = await Lab.Image.createImage(counts[k][basename].base64)\n        let canvas = Lab.Image.createCanvasFromImage(im)\n        // 绘制数量到图上\n        let ctx = canvas.getContext('2d')\n        ctx.fillStyle = 'black'\n        ctx.fillRect(0, canvas.height - 56, canvas.width, 56)\n        ctx.font = '38px Georgia'\n        ctx.textBaseline = 'bottom'\n        ctx.textAlign = 'right'\n        ctx.fillStyle = 'white'\n\n        // 稀有度\n        let rare = (\n          (100 * counts[k][basename].count) /\n          filepaths.length\n        ).toFixed(2)\n\n        ctx.fillText(\n          basename.replace(/\\..*/gi, '') + '_' + rare + '%',\n          canvas.width - 8,\n          canvas.height - 8\n        )\n\n        elements.push({\n          basename,\n          value: counts[k][basename].count,\n          rare,\n          canvas\n        })\n      }\n      elements = elements.sort((a, b) => b.value - a.value)\n      maxWidth = Math.max(elements.length * size + 40, maxWidth) + 20\n      ks[index] = {\n        key: k,\n        elements\n      }\n      if (elements.length == 0) ks[index] = null\n    }\n    ks = ks.filter(k => k)\n    maxHeight = ks.length * (size + 20) + 40\n    // console.log(ks,maxWidth,maxHeight)\n\n    // 绘制大图\n    let canvasElements = Lab.Image.createCanvas(maxWidth, maxHeight),\n      ctxElements = canvasElements.getContext('2d')\n\n    for (let k of ks) {\n      let y = size * 1.2 * ks.indexOf(k)\n      if (y + size > canvasElements.height)\n        canvasElements.height = y + 40 + size\n    }\n\n    ctxElements.strokeStyle = 'black'\n    ctxElements.lineWidth = 2\n    ctxElements.font = '14px Georgia'\n    ctxElements.textBaseline = 'top'\n    ctxElements.textAlign = 'left'\n    ctxElements.fillStyle = 'black'\n\n    // 计算每个文件的稀有度\n    window._RARE = {}\n    Array.from(ks, r => {\n      let key = r.key\n      Array.from(r.elements, e => {\n        window._RARE[e.basename] = { key, rare: Number(e.rare) }\n      })\n    })\n\n    window._filesRare = filesRare\n    for (let k of ks) {\n      let y = size * 1.2 * ks.indexOf(k)\n      ctxElements.fillText(k.key, 10, 10 + y)\n      for (let e of k.elements) {\n        let x = k.elements.indexOf(e) * size,\n          xs = (1 + k.elements.indexOf(e)) * 10\n        ctxElements.drawImage(\n          e.canvas,\n          0,\n          0,\n          e.canvas.width,\n          e.canvas.height,\n          x + xs,\n          y + 30,\n          size,\n          size\n        )\n        ctxElements.strokeRect(x + xs, y + 30, size, size)\n      }\n    }\n\n    Lab.ui.saveBase64Dialog(canvasElements.toDataURL(), '保存', '稀有度')\n    // let url=canvasElements.toDataURL();\n    // Lab.ui.add(Lab.ui.createImageAndDownload(url));\n\n    // 绘制-所有文件的大图合集\n    imgs = imgs.filter(i => i)\n    let canvas = Lab.Image.createCanvas(w * num, h * imgs.length)\n    let ctx = canvas.getContext('2d')\n    // console.log(imgs)\n    // 稀有度的总文件\n    let raresText = []\n\n    for (let index = 0; index < imgs.length; index++) {\n      const ims = imgs[index]\n      for (let j = 0; j < ims.length; j++) {\n        const im = ims[j]\n\n        let c = Lab.Image.createCanvasFromImage(im, w, h)\n        let cx = c.getContext('2d')\n        cx.fillStyle = 'black'\n        cx.fillRect(0, h - 44, w, 44)\n        cx.font = '18px Georgia'\n        cx.textBaseline = 'bottom'\n        cx.textAlign = 'right'\n        cx.fillStyle = 'white'\n        // 在这里加入稀有度的数据\n        //\n        function average (nums) {\n          return nums.reduce((a, b) => a + b) / nums.length\n        }\n        function sum (nums) {\n          return nums.reduce((a, b) => a + b)\n        }\n\n        let rare1 = [],\n          rareStr = ''\n        for (let key in _filesRare[im.fileName].attrs) {\n          // console.log(_RARE[key])\n          rare1.push(_RARE[key].rare * 0.001)\n          rareStr += '_' + _RARE[key].key + '_' + _RARE[key].rare + '%'\n        }\n\n        rare1 = (sum(rare1) * 100).toFixed(2)\n\n        cx.fillText(im.fileName + '_' + rare1, w - 8, h - 8)\n\n        ctx.drawImage(c, j * w, index * h, w, h)\n\n        raresText.push({\n          code: im.fileName,\n          rare: rare1,\n          attrs: rareStr\n        })\n      }\n    }\n    Lab.ui.saveBase64Dialog(canvas.toDataURL(), '保存', '大图')\n    Lab.ui.saveJsonDialog(raresText)\n  })\n  Lab.ui.add(allPicsBtn)\n}\n\n// 调整内容\nfunction updateCanvasImgs (id) {\n  let { rect, imgs } = cardElements[id]\n  for (const img of imgs) {\n    if (img.type === 'svg') {\n      img.element.left = rect.left\n      img.element.top = rect.top\n      img.element.scaleToHeight(rect.getScaledHeight())\n      img.element.scaleToWidth(rect.getScaledWidth())\n      myCanvas.render()\n    }\n  }\n}\n\nfunction createMaskKeysFromSvg () {\n  var draw = SVG()\n  draw.svg(window.base)\n  var parent = draw.children()[0]\n  var styles = parent.attr()\n  draw.width(styles.width)\n  draw.height(styles.height)\n  draw.viewbox(styles.viewBox)\n  var gs = draw\n    .children()[0]\n    .children()[1]\n    .find('g')\n  let maskKeys = {}\n  for (let index = 0; index < gs.length; index++) {\n    gs[index].id(`M-${index}`)\n    maskKeys[`M-${index}`] = 0\n  }\n  window.base = draw.children()[0].svg()\n  return maskKeys\n}\n\nfunction initRandomLayout () {\n  var draw = SVG()\n  draw.svg(window.base)\n  var parent = draw.children()[0]\n  var styles = parent.attr()\n  draw.width(styles.width)\n  draw.height(styles.height)\n  draw.viewbox(styles.viewBox)\n  var gs = draw\n    .children()[0]\n    .children()[1]\n    .find('g')\n  let maskKeys = {}\n  for (let index = 0; index < gs.length; index++) {\n    // gs[index].id(`M-${index}`)\n    maskKeys[gs[index].id()] = {\n      x: gs[index].x(),\n      y: gs[index].y(),\n      width: gs[index].width(),\n      height: gs[index].height(),\n      transform: gs[index].transform()\n    }\n  }\n  return maskKeys\n}\n\nfunction drawBase (preImg) {\n  var draw = SVG()\n  draw.svg(window.base)\n  var parent = draw.children()[0]\n  var styles = parent.attr()\n  draw.width('120px')\n  draw.height('120px')\n  draw.viewbox(styles.viewBox)\n  let gs = Array.from(draw.find('g'), g => g)\n  gs[0].attr('stroke', 'red')\n  Array.from(gs, g => g.text(g.id()))\n  preImg.setValue([Lab.base.str2URL(draw.svg(), 'image/svg+xml;charset=utf-8')])\n}\n\nfunction drawSvg (addTo, baseData, features) {\n  let draw = SVG()\n  if (addTo) draw.addTo(addTo)\n  // const clickAddImg = function() {\n  //     console.log(this)\n  //     myCanvas.addImg(this.node)\n  // }\n  // draw.on('click', clickAddImg);\n\n  draw.svg(baseData)\n  let parent = draw.children()[0]\n  let styles = parent.attr()\n  draw.width(styles.width)\n  draw.height(styles.height)\n  draw.viewbox(styles.viewBox)\n  // window.draw=draw;\n  // 更改组件\n  let id = ''\n  for (const r of features) {\n    // 组件svg\n    let element = window.keysList[r.key][r.index]\n    draw.findOne('#' + r.key).svg(element.svg, true)\n    // 拼id\n    id = id + '_' + element.id\n    // TODO 調整圖層順序\n    console.log(element.zIndex)\n  }\n  id = Lab.base.md5(id)\n  draw.attr('data-id', id)\n  return draw.svg()\n}\n\nfunction createDownloadPannel () {\n  let m = Lab.ui.createModel('下载')\n\n  let runBtn = Lab.ui.createButton('下载svg图', () => {\n    // console.log(size)\n    if (window.downloadURL) {\n      let s = SVG()\n      s.svg(window.currentSvg)\n      let id = s.children()[0].attr('data-id')\n      Lab.ui.createDownlad(window.downloadURL, id)\n      downloadPannel.hide()\n    }\n  })\n  m.add(runBtn)\n  let downloadPngBtn = Lab.ui.createButton('下载png图片', () => {\n    // console.log(size)\n    let s = SVG()\n    s.svg(window.currentSvg)\n    let id = s.children()[0].attr('data-id')\n    // TODO bug\n    for (const obj of myCanvas.getObjects()) {\n      if (obj.name === 'svg') Lab.ui.createDownlad(obj.toDataURL(), id)\n    }\n    downloadPannel.hide()\n  })\n  m.add(downloadPngBtn)\n  let copyPngBtn = Lab.ui.createButton('拷贝png图片', () => {\n    // console.log(size)\n    for (const obj of myCanvas.getObjects()) {\n      if (obj.name === 'svg') Lab.clipboard.write(obj.toDataURL(), 'base64')\n    }\n    downloadPannel.hide()\n  })\n  m.add(copyPngBtn)\n  return m\n}\n\n// 图片集\nfunction createCard (row) {\n  let id = new Date().getTime() + '' + parseInt(Math.random() * 1000)\n\n  let card = Lab.ui.createGroup('card')\n  card.style.width = 'min-content'\n  card.style.margin = '12px'\n  card.addEventListener('click', e => {\n    setActiveObject(id)\n    toolbox.update()\n  })\n  card.id = id\n  row.add(card)\n\n  let text = `图片集 ${1 + Object.keys(cardElements).length}`\n  let t = Lab.ui.createBaseText(text)\n  card.add(t)\n  t.style.margin = '1em'\n\n  // img\n  let imgBtn = Lab.ui.createInput(\n    'imgs',\n    text,\n    imgs => {\n      Lab.ui.loading(0)\n      console.log(id, imgs)\n      if (cardElements[id]) cardElements[id].imgUrls = imgs\n      setTimeout(() => Lab.ui.loading(100), 3000)\n    },\n    true,\n    false\n  )\n  card.add(imgBtn)\n\n  // btns 功能区\n  let btnsDiv = Lab.ui.createGroup('column')\n  btnsDiv.style.display = 'flex'\n  let downloadBtn = Lab.ui.createIcon('download', () => {\n    //  console.log(imgBtn.getValue())\n    window.downloadURL = imgBtn.getValue()\n    if (downloadPannel) downloadPannel.show()\n  })\n  btnsDiv.add(downloadBtn)\n\n  card.add(btnsDiv)\n\n  // 占位框\n  let rect = myCanvas.addRect(\n    {\n      left: parseInt(_CANVAS_WIDTH / 2) - 100,\n      top: parseInt(_CANVAS_HEIGHT / 2) - 100,\n      width: 100,\n      height: 100,\n      // stroke: 'red',\n      strokeWidth: 0,\n      fill: 'rgba(255,0,0,0.1)'\n    },\n    true,\n    true,\n    true\n  )\n  // myCanvas.zoomToFitCanvas()\n  rect.name = 'artboard'\n  rect.id = id\n\n  // 选项框\n  let ins = Lab.ui.createInput(\n    'select',\n    '',\n    e => {\n      console.log(e, rect, imgBtn)\n      if (e === 'img') {\n        window.rect = rect\n        window.imgBtn = imgBtn\n      }\n    },\n    true,\n    false\n  )\n  ins.appendOptions([\n    {\n      value: 'img',\n      text: '图片'\n    },\n    {\n      value: 'emoji',\n      text: '表情'\n    },\n    {\n      value: 'color',\n      text: '色块'\n    }\n  ])\n  card.add(ins)\n  ins.init()\n  ins.style.marginLeft = '12px'\n  card.setValue = imgBtn.setValue\n  return { card, rect }\n}\n\nfunction createToolbox () {\n  let inPos = Lab.ui.createInputForPosition(pos => {\n    // console.log(pos)\n    let [x, y, w, h] = pos\n\n    let rect = myCanvas.getActiveObject()\n    rect.scaleToWidth(w)\n    rect.scaleToHeight(h)\n\n    rect.left = x\n    rect.top = y\n    // console.log(z);\n\n    rect.width = w / rect.scaleX\n    rect.height = h / rect.scaleX\n\n    myCanvas.render()\n  })\n  inPos.update = () => {\n    let rect = myCanvas.getActiveObject()\n    inPos.setValue([\n      rect.left,\n      rect.top,\n      rect.getScaledWidth(),\n      rect.getScaledHeight()\n    ])\n    updateCanvasImgs(rect.id)\n  }\n  return inPos\n}\n\nfunction doModified (e, data) {\n  // console.log(e, data)\n  // e.target.id;\n  if (e.target.id && cardElements[e.target.id]) {\n    toolbox.update()\n  }\n}\n\nfunction doClick (e) {\n  // console.log(e.target.id)\n  if (e.target && e.target.id && cardElements[e.target.id]) {\n    let card = cardElements[e.target.id]\n    // console.log(card, e.target.id)\n    card.element.classList.add('red')\n    // 更新rect信息到toolbox\n    toolbox.update()\n  } else {\n    for (const id in cardElements) {\n      cardElements[id].element.classList.remove('red')\n    }\n  }\n}\n\nfunction doRemoved (e) {\n  if (e.target.id && cardElements[e.target.id]) {\n    cardElements[e.target.id].element.remove()\n    delete cardElements[e.target.id]\n  }\n}\n\n// 激活\nfunction setActiveObject (id) {\n  for (const id in cardElements) {\n    cardElements[id].element.classList.remove('red')\n  }\n  if (cardElements[id]) {\n    let c = cardElements[id]\n    myCanvas.setActiveObject(c.rect)\n    c.element.classList.add('red')\n  }\n}\n\nfunction travel (children = []) {\n  // let isDone = true;\n  let list = []\n  for (let c of children) {\n    // console.log(c.node.id);\n    // if (doFun) doFun(c)\n    // if (c.children().length > 0) {\n    //     isDone = false;\n    //     travel(c.children(), doFun, successFun);\n    // };\n    list.push(c)\n    if (c.children().length > 0) {\n      list = [...list, ...travel(c.children())]\n    }\n  }\n  return list\n  // bug\n  // console.log(isDone)\n  // if (successFun && isDone) {\n  //     successFun();\n  // }\n}\n\n// step 1 打开所有的模版\n// step 2 设定变量，预处理，提取变量对应的svg\n// step 3 导出数据\n\n// 得到变量，用-M标记的变量\nfunction getAllMaskKeys (draw) {\n  let maskKeys = []\n  let children = travel(draw.children())\n  // console.log(children)\n  // 遍历过程中的数据处理\n  for (const child of children) {\n    if (\n      child.node.id &&\n      child.node.id.trim() &&\n      child.node.id.match('-M') &&\n      !maskKeys.includes(child.node.id)\n    ) {\n      maskKeys.push(child.node.id)\n    }\n  }\n  // 成功遍历完成\n  return maskKeys\n}\n\n// 初始化\n// keyList=['face','eyes','mouse','ears']\n// window.face=[];\n// window.eyes=[];\n// window.mouse=[];\n// window.ears=[];\nfunction initEngine (draw, keys = []) {\n  // 文件名\n  let basename = Lab.base.getBaseName(draw.__filepath)\n  let children = travel(draw.children())\n  for (const child of children) {\n    // 遍历过程中的数据处理\n\n    if (keys.includes(child.node.id) && window.keysList[child.node.id]) {\n      let id = Lab.base.md5(basename)\n      //  寫上id\n      child.attr('data-id', id)\n      child.attr('data-basename', basename)\n      let svg = child.svg()\n      let isNew = true\n      for (const n of window.keysList[child.node.id]) {\n        if (n.id === id) isNew = false\n      }\n      if (isNew) {\n        window.keysList[child.node.id].push({\n          id,\n          svg,\n          basename,\n          draw,\n          zIndex: keys.indexOf(child.node.id)\n        })\n        let index = window.keysList[child.node.id].length - 1\n        draw.node.addEventListener('click', e => {\n          window.keysList[child.node.id][index].draw.node.style.opacity += 0.05\n          window.keysList[child.node.id][index].zIndex++\n          if (window.keysList[child.node.id][index].draw.node.style.opacity > 1)\n            window.keysList[child.node.id][index].zIndex = 0\n          console.log(window.keysList[child.node.id][index])\n        })\n      }\n    }\n  }\n}\n\n// 笛卡尔生成全集\nfunction createAll () {\n  let data = []\n  for (const key in window.keysList) {\n    data.push(\n      Array.from(window.keysList[key], (d, i) => {\n        return {\n          key: key,\n          index: i\n        }\n      })\n    )\n  }\n  let ds = Lab.base.cartesian(data)\n  // ds=Lab.base.chunk(ds,6);\n  return ds\n}\n\n// 笛卡尔积太大，改用随机生成，重复一定的数量\nfunction createAllRandom (count = 100) {\n  let data = []\n  for (const key in window.keysList) {\n    data.push(\n      Array.from(window.keysList[key], (d, i) => {\n        return {\n          key: key,\n          index: i\n        }\n      })\n    )\n  }\n  let ds = []\n  let dsMap = {}\n  for (let index = 0; index < count * 2; index++) {\n    let style = []\n    for (const d of data) {\n      let s = Lab.base.shuffle([...d])[0]\n      style.push(s)\n    }\n    let id = Lab.base.hash(style)\n    if (!dsMap[id]) {\n      ds.push(style)\n      dsMap[id] = 1\n    }\n  }\n  ds = Lab.base.shuffle([...ds]).slice(0, count)\n  return ds\n}\n",
  "code_length": 233,
  "size": [
    883,
    681
  ],
  "extname": "designlabplugin",
  "version": "0.8",
  "package_version": "0.1.2",
  "package_id": "df22ad54c8e3dee49e71dd4ce9538ee33b2a7d1e",
  "dependencies": {
    "@ffmpeg-installer/ffmpeg": "^1.0.20",
    "@ffprobe-installer/ffprobe": "^1.1.0",
    "@fortawesome/fontawesome-free": "^5.15.3",
    "@hapi/hapi": "^20.1.2",
    "@kilokilo/three-bmfont-text": "^3.1.0",
    "@mediapipe/camera_utils": "^0.3.1632432234",
    "@mediapipe/drawing_utils": "^0.3.1620248257",
    "@mediapipe/holistic": "^0.5.1635989137",
    "@node-rs/jieba": "^1.3.1",
    "@paddlejs-models/humanseg": "0.0.5",
    "@pixiv/three-vrm": "^0.6.7",
    "@tensorflow-models/body-pix": "^2.1.0",
    "@tensorflow-models/deeplab": "^0.2.1",
    "@tensorflow-models/face-landmarks-detection": "0.0.1",
    "@tensorflow-models/knn-classifier": "^1.2.2",
    "@tensorflow-models/mobilenet": "^2.1.0",
    "@tensorflow-models/posenet": "^2.2.2",
    "@tensorflow/tfjs": "^3.3.0",
    "@tensorflow/tfjs-backend-wasm": "^3.3.0",
    "about-window": "^1.14.0",
    "animejs": "^3.2.1",
    "color": "^3.1.3",
    "dat.gui": "^0.7.7",
    "debounce": "^1.2.1",
    "electron-json-storage": "^4.4.0",
    "electron-squirrel-startup": "^1.0.0",
    "emoji-picker-element": "^1.6.0",
    "emoji-regex": "^9.2.2",
    "espree": "^7.3.1",
    "exceljs": "^4.2.1",
    "face-api.js": "^0.22.2",
    "fluent-ffmpeg": "^2.1.2",
    "fomantic-ui": "^2.8.7",
    "gif.js": "^0.2.0",
    "gifuct-js": "^2.1.1",
    "horajs": "^0.1.3",
    "idb-kv-store": "^4.5.0",
    "internal-ip": "^6.2.0",
    "jimp": "^0.16.1",
    "kalidokit": "^1.0.5",
    "lowdb": "^1.0.0",
    "make-cert": "^1.2.0",
    "marked": "^1.2.9",
    "md5": "^2.3.0",
    "mime-types": "^2.1.30",
    "mkcert": "^1.4.0",
    "ml": "^6.0.0",
    "natural": "^5.0.3",
    "ngraph.path": "^1.3.1",
    "nouislider": "^14.7.0",
    "object-hash": "^2.1.1",
    "opencvjs-dist": "^4.4.0",
    "osc-js": "^2.1.2",
    "pdfjs-dist": "^2.6.347",
    "peer": "^0.6.1",
    "peerjs": "^1.3.2",
    "pixelit": "https://github.com/giventofly/pixelit.git",
    "recordrtc": "^5.6.2",
    "regl": "^2.1.0",
    "smartcrop": "^2.0.3",
    "socket.io": "^4.0.0",
    "socket.io-client": "^4.0.0",
    "three": "^0.134.0",
    "timeago.js": "^4.0.2",
    "unsplash-js": "^7.0.12",
    "wordcloud": "^1.2.2",
    "yoga-layout-wasm": "^1.9.3-alpha.7",
    "zdog": "^1.1.2"
  },
  "author": "shadow",
  "create_time": 1640858073354
}